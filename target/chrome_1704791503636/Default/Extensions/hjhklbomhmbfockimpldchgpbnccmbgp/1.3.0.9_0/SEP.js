'use strict';(function(a){(a.SEF=a.SEF||{}).context={BROWSER:"Chrome",browserObject:window.chrome}})(this);(function(a){(a.SEF=a.SEF||{}).symbols=Object.freeze({Initialize:Symbol("Initialize"),Self:Symbol("Self"),Category:Symbol("Category"),ModuleSequenceId:Symbol("SequenceId"),Module:Symbol("ModuleObject"),ModuleId:Symbol("ModuleId"),ModuleName:Symbol("ModuleName"),ModuleType:Symbol("ModuleType"),ModulePublicKey:Symbol("ModulePublicKey"),Listeners:Symbol("Listeners"),Pollers:Symbol("Pollers"),ConfigurationServer:Symbol("ConfigServer"),InitFuture:Symbol("InitFuture"),Return:Symbol("Return"),EventContext:Symbol("EventContext"),
Result:Symbol("Result"),Action:Symbol("Action"),ActionData:Symbol("ActionData"),CustomAction:Symbol("CustomAction"),CustomActionData:Symbol("CustomActionData"),Base:Symbol("Base"),Capture:Symbol("Capture"),Version:Symbol("Version"),Target:Symbol("Target"),ErrorInfo:Symbol("Error"),Incidents:Symbol("Incidents")});a.SEF.utils=a.SEF.utils||{}})(this);(function(a){Object.defineProperty(a.SEF=a.SEF||{},"version",{value:"1.0.170",writable:!1})})(this);(function(a){(a.SEF=a.SEF||{}).exceptions=function(){return{DatabaseNotSeededException:class extends Error{constructor(a){super(`Passcode required to seed database upon creation. <${a}>`)}},JWTInvalidPayloadException:class extends Error{constructor(){super("JWT payload is invalid")}},JWTPayloadHashMismatchException:class extends Error{constructor(){super("JWT payload hash mismatch")}},JWTVerificationException:class extends Error{constructor(){super("Unable to verify JWT payload using current key")}},
AbstractClassException:class extends Error{constructor(){super("Cannot instantiate an abstract class")}},ModuleParamMissingException:class extends Error{constructor(a){super(`Paramter missing: '${a}'`)}},RebindingProhibited:class extends Error{constructor(a,c=""){super(`Rebinding '${c}@${a}' is prohibited`)}},ObjectNotCallableException:class extends Error{constructor(a){super(`Object <${a}> is not callable`)}},InvalidModuleException:class extends Error{constructor(){super("Object is not a valid SEF Module")}},
ListenerInterfaceNotSupportedException:class extends Error{constructor(a){super(`Object <${a}> does not support listener interface`)}},EventNotSupportedException:class extends Error{constructor(a,c){super(`Event <${c}> is not supported on target <${a}>`)}},OperationNotPermitted:class extends Error{constructor(){super("Operation is not permitted in the current context")}},ContractExpiredError:class extends Error{constructor(a){super("expired");this.options=a}},ValidationError:class extends Error{},
StopIteration:class{constructor(a){this.value=a}}}}()})(this);(function(a){a.SEF=a.SEF||{};(a.SEF.utils=a.SEF.utils||{}).Logger=function(){function a(a,b){a in c.modules&&(c.modules[a].enabled=!!b)}class c{constructor(a){this.module=a;this.logs=[];this.minLogSize=3;this.maxLogSize=50;this.maxDuration=18E4}send(a,c){try{const b=Date.now();this.logs.length<=this.maxLogSize&&this.logs.push({ts:b,level:a,msg:c});(this.logs.length>=this.minLogSize||0<this.logs.length&&b-this.logs[0].ts>this.maxDuration)&&SEF.hasOwnProperty("bridge")&&(SEF.bridge.portManager.Send({[SEF.constants.teleKeys.MESSAGE_TYPE]:"LOGGING",
[SEF.constants.teleKeys.LOGGING]:this.logs},SEF.config.Get("nativeMessasingAppId")),this.logs=[],this.minLogSize=0)}catch(l){}}debug(a,...b){c.DoLog(console.debug.bind(console),this.module,`[DBG] ${a}`,...b)}info(a,...b){c.DoLog(console.info.bind(console),this.module,`[INF] ${a}`,...b);this.send("INFO",`[${this.module}] ${a}`)}error(a,...b){c.DoLog(console.error.bind(console),this.module,`[ERR] ${a}`,...b);this.send("ERROR",`[${this.module}] ${a}`)}warn(a,...b){c.DoLog(console.warn.bind(console),
this.module,`[WRN] ${a}`,...b);this.send("WARN",`[${this.module}] ${a}`)}verbose(a,...b){c.DoLog(console.log.bind(console),this.module,`[VBS] ${a}`,...b)}}c.DoLog=(a,b,l,...f)=>{!0===c.modules[b].enabled&&(a(`[${(new Date).toLocaleString("en-US")}][${b}]${l}`,...f),c.externalHandlers.forEach(a=>{a(`[${b}] ${l}`)}))};c.modules={};c.externalHandlers=[];return class extends c{constructor(a){a=a.toUpperCase();super(a);c.modules.hasOwnProperty(a)||(c.modules[a]={enabled:!0,object:this});return c.modules[a].object}static EnableModules(b){b=
b.toUpperCase();a(b,!0)}static DisableModules(b){b=b.toUpperCase();a(b,!1)}static GetModules(){return Object.keys(c.modules)}static Status(){const a={};Object.keys(c.modules).forEach(b=>{a[b]=c.modules[b].enabled});return a}static SetupHandler(a){"function"===typeof a&&c.externalHandlers.push(a)}}}()})(this);(function(a){a=a.SEF=a.SEF||{};var b={NATIVE_MESSAGING_APP_CONNECT_RETRY_DEFAULT:3E4};b.NATIVE_MESSAGING_APP_ID=Object.freeze("com.broadcom.webextbridge");b.PULSE_FREQUENCY=180;b.SYNC_FREQUENCY=5;b.NATIVE_APP_IDS=Object.freeze(["com.symantec.xndc_oob"]);b.WEBCONF_RESPONSE_TIMEOUT=5E3;b.URL_MAX_LENGTH=2048;b.POLL_FREQUENCY=Object.freeze({MIN:4,MAX:86400});b.TRUSTED_DOMAINS=Object.freeze(["google-analytics.com","norton.com","symantec.com","nortoncdn.com","sp.cwfservice.net"]);b.HTTP_HEADER_NAME_SOURCE_ID=
Object.freeze("X-Device-ID");b.scanApproach=Object.freeze({INLINE_SCAN:"InlineScan",DELAY_LOAD:"DelayLoad",PEER_DOM:"PeerDOM",LAZY_SCAN:"LazyScan"});b.actionProfiles=Object.freeze({SECURE:"Secure",PRIORITY:"PriorityBased",CONSENSUS:"ConsensusBased"});b.consolPriorities=Object.freeze({HIGH:500,HIGH_MEDIUM:400,MEDIUM:300,MEDIUM_LOW:200,LOW:100});b.networkUsage=Object.freeze({NONE:"No Usage",LIMITED:"Limited Usage",UNLIMITED:"Unlimited Usage"});b.moduleStates=Object.freeze({ENABLED:"enabled",SILENT:"silent",
DISABLED:"disabled"});b.msgTypes=Object.freeze({CLOUD_CONFIG:"config",FEATURE_STATES:"featureStates",NDC_CONTENT:"ndcContent",POLICIES:"policies",MESSAGE:"message",BROADCAST:"broadcast",EXIT:"exit",EXCLUSIONS:"exclusions",MESSAGE_KEY:"messagekey"});b.teleKeys=Object.freeze({MESSAGE_TYPE:"type",PRODUCT_ID:"ext_id",PRODUCT_NAME:"ext_name",PRODUCT_VERSION:"ext_version",BROWSER:"browser",BROWSER_VERSION:"browser_version",URL:"url",SOURCE:"source",SILENT:"silent",EXCLUDED:"excluded",ACTION:"action",TIME:"act_time",
CATEGORY_IDS:"category_ids",THREAT_LEVEL:"threat_level",SIG_ID:"signature_id",SIG_NAME:"signature_name",PAYLOAD:"payload",LANGUAGE:"lang",LOGGING:"logging"});b.telePayloadKeys=Object.freeze({NDC_DEF_VERSION:"ndc_def_version"});b.sigInfo=Object.freeze({WEBPULSE_BASED_SIG_ID:60501,WEBPULSE_BASED_SIG_NAME:"URL reputation: Browser navigation to known bad URL",WEBPULSE_BASED_THREAT_LEVEL:3,RULE_BASED_SIG_ID:60502,RULE_BASED_SIG_NAME:"URL BLOCKING: Browser navigation to known bad URL",RULE_BASED_THREAT_LEVEL:3});
b.SAFE_LANDING_PAGE=Object.freeze("notification.html");a.constants=b})(this);(function(a){(a.SEF=a.SEF||{}).common=function(){const {exceptions:a,utils:c,constants:g}=SEF,h=new c.Logger("COMMON"),{ContractExpiredError:l}=a,f={JSScope:class{constructor(d,...e){if("JSScope"===this.constructor.name)throw Error("Cannot instantiate this class");if(d&&"function"!=typeof d)throw Error("executor must be callable");this.args=e;d=d||function(){return null};const [a,m]=[(this[this.constructor.name]||function(){return null}).bind(this),(this[`~${this.constructor.name}`]||function(){return null}).bind(this)];
a();try{d.bind(this)()}catch(A){}finally{m()}}},hash:{MD5:d=>d?forge.md.md5.create().update(d).digest().toHex():null,SHA256:d=>d?forge.md.sha256.create().update(d).digest().toHex():null,SHA256Digest:d=>d?forge.md.sha256.create().update(d).digest():null}};class q extends Promise{constructor(d,e={}){if("function"!==typeof d)throw Error("executor is not callable");super((a,m)=>{try{d(a,m)}catch(A){m(A)}finally{e.expiry&&setTimeout(m,e.expiry,new l(e))}})}expires(d){"function"===typeof d&&this.catch(e=>
e instanceof l?d(e):e);return this}}g.msgType=Object.freeze({URL_REPUTATION:"webPulse",HTTP_HDR_SCANNER:"NDC",DOWNLOAD_EVENT:3,OTHER:4});class k{constructor(d,e=null,a={}){this.status=d;this.tabId=e;this.optional=a;this.recommendation=this.type=null}Set(d,e=null){e&&(this.recommendation=e);"number"==typeof d?(this.type=g.msgType.URL_REPUTATION,e="reputation"):Array.isArray(d)||d instanceof Uint32Array?(this.type=g.msgType.HTTP_HDR_SCANNER,d=Uint32Array.from(d),e="sigIds"):"string"==typeof d?(this.type=
g.msgType.DOWNLOAD_EVENT,e="filename"):(this.type=g.msgType.OTHER,e="payload");Object.defineProperty(this,e,{value:d,enumerable:!0,writable:!1});return this}SetOptional(d){for(const e of Object.keys(d))this.optional[e]=d[e];return this}SetTabId(d){this.tabId=d;return this}SetRecommendation(d){this.recommendation=d;return this}}class r{static get CACHE_LIMIT(){return 1E3}static get CACHE_TTL(){return 604800}constructor(d=r.CACHE_LIMIT,e=r.CACHE_TTL){if(!r.instance){if("number"!==typeof d||"number"!==
typeof e)throw Error("Paramter is not a number");this.maxEntries=d;this.ttl=e;const a=function(d){let e={length:0};return{Insert:(a,m,b=null)=>{if(!a)return h.error("[SEF.Web Error]: _cache::Insert: Null key"),!1;if(!(a in e)){if(e.length>=d.maxEntries)return h.error("[SEF.Web Error]: Cache capacity maxed out at "+`${d.maxEntries} entries`),!1;e.length++}e[a]=m;m=b?b:d.ttl?d.ttl:0;0<d.ttl&&setTimeout(()=>{a in e&&(delete e[a],e.length--)},1E3*m);return!0},Remove:d=>d&&d in e?(delete e[d],e.length--,
!0):!1,Size:()=>e.length,Clear:()=>{e={length:0}},Get:d=>d in e?e[d]:null}}(this);this.InsertVolatile=this.Insert=a.Insert;this.Remove=a.Remove;this.Clear=a.Clear;this.GetEx=a.Get;this.Get=d=>{d=a.Get(d);return d instanceof Promise||d instanceof q?null:d};this.Size=a.Size;Object.defineProperty(r,"instance",{value:this,writable:!1})}return r.instance}}class p{constructor(d){const e=new URL(d);e.directory=`${e.protocol}//${e.host}${e.pathname.substr(0,e.pathname.lastIndexOf("/"))}`;e.path=`${e.protocol}//${e.host}${e.pathname}`;
e.HostHash=()=>f.hash.SHA256(e.host);e.DirectoryHash=()=>f.hash.SHA256(e.directory);e.PathHash=()=>f.hash.SHA256(e.path);return e}}class t{static CreateUrlMatcher(d){let e,a,m,b,n,k,c;var f=(new RegExp(/(?:(?<schema>.*):\/\/)?(?:(?<authority>.*:.*)@)?(?:(?<domain>[^\/:]*))?(?::)?(?:(?<port>[0-9]*))?(?:\/)?(?:(?<path>[^\?#]*))?(?:\?)?(?:(?<query>[^#]*))?(?:#)?(?:(?<fragment>.*))?/,"i")).exec(d);[c,f,e,a,m,b,n,k]=f;if(c!==d)return h.error("Invalid url format."),null;d=new t(c,f,e,a,m,b,n,k);try{d.Compile()}catch(G){h.error("Create Url Matcher failed: ",
G),d=null}return d}constructor(d,e,a,m,b,n,k,c){this.url=d;this.schema=e;this.authority=a;this.domain=m;this.path=n;this.port=b;this.query=k;this.fragment=c;this.matcher=null}Compile(){let d="";d=this.schema?d+this.Format(this.schema.concat("://")):d+"(?:.*://)?";this.authority||(this.authority="(?:.*:.*@)?");d+=this.authority;if(!this.domain)throw Error("Empty domain.");d+=this.Format(this.domain);d=this.port?d+this.Format(":".concat(this.port.toString())):d+"(?::[0-9]*)?";this.path&&(d+=this.Format("/".concat(this.path)));
this.query&&(d+=this.Format("?".concat(this.query)));this.fragment&&(d+=this.Format("#".concat(this.fragment)));this.matcher=new RegExp("^".concat(d).concat(".*$"))}Format(d){return d.replace(/\./g,"\\.").replace(/\?/g,"\\?").replace(/\*/g,".*")}Equal(d){return this.schema===d.schema&&this.authority===d.authority&&this.domain===d.domain&&this.port===d.port&&this.path===d.path&&this.query===d.query&&this.fragment===d.fragment?!0:!1}Match(d){return this.matcher.exec(d)?this.url.length:0}}class n{static CreateIpv4RangeMatcherFromIpv4Range(d){let e=
null;try{const a=JSON.parse(d);if("number"!==typeof a[0]||"number"!==typeof a[1]||0>a[0]||4294967295<a[0]||0>a[1]||4294967295<a[1])return null;e=new n(d,a)}catch(x){h.error("Create Ipv4RangeMatcher failed: ",x),e=null}return e}static CreateIpv4RangeMatcherFromIpv4(d){let e=null;try{const a=parseInt(d,10);if(0>a||4294967295<a)return null;e=new n(d,[a,a])}catch(x){h.error("Create Ipv4RangeMatcher failed: ",x),e=null}return e}static Preprocess(d){return f.ValidateAndRetrieveIpv4Address(d)}static compareFn(d,
e){return d.range[0]===e.range[0]&&d.range[1]===e.range[1]?0:d.range[1]<e.range[0]?-1:d.range[0]>e.range[1]?1:null}static matchFn(d){return e=>d>=e.range[0]&&d<=e.range[1]?0:d<e.range[0]?1:-1}constructor(d,e){this.strIpv4Range=d;this.range=e;this.range[0]>this.range[1]&&([this.range[0],this.range[1]]=[this.range[1],this.range[0]])}Equal(d){return this.strIpv4Range===d.strIpv4Range&&this.ipv4Range===d.ipv4Range}}class m{constructor(d,e,a,m={}){if("function"!==typeof d)throw Error("Argument must be callable");
if("function"!==typeof e&&"number"!==typeof e)throw Error(`Invalid frequency type <${typeof e}> while creating PollingSchedule: ${e}`);if(a&&!Array.isArray(a))throw Error("Parameters must be Array or undefined");let b=e,n=!1,k=null,c=null;Object.defineProperty(this,"frequency",{get(){return"function"==typeof b?b():b},set(d){b="function"==typeof d||"number"==typeof d?d:b}});Object.defineProperty(this,"scheduled",{get(){return n},set(){return null}});Object.defineProperty(this,"lastRunAt",{get(){return c},
set(){return null}});Object.defineProperty(this,"poller",{value:d,writable:!1});Object.defineProperty(this,"params",{value:a,writable:!1});m.hasOwnProperty("name")&&Object.defineProperty(this,"name",{value:m.name,writable:!1});m.hasOwnProperty("description")&&Object.defineProperty(this,"description",{value:m.description,writable:!1});m.hasOwnProperty("delayedStart")&&Object.defineProperty(this,"delayedStart",{value:m.delayedStart,writable:!1});Object.defineProperty(this,"autoStart",{value:"boolean"===
typeof m.autoStart?m.autoStart:!0,writable:!1});this.Run=function(){if(!this.scheduled){var d=()=>{function e(e){e<g.POLL_FREQUENCY.MIN||e>g.POLL_FREQUENCY.MAX||(k=setTimeout(d,1E3*e),n=!0)}n=!1;k=null;try{const d=this.poller.apply(null,this.params);c=Date.now();d instanceof Promise||d instanceof q?d.then(()=>{e(this.frequency)}):e(this.frequency)}catch(C){h.error(`Poller error: ${C}`)}};!0===this.delayedStart?setTimeout(d,1E3*this.frequency):d()}};this.Stop=function(){n&&k&&(clearTimeout(k),n=!1)}}}
class e{constructor(){this.promise=new Promise((d,e)=>{this.resolve=d;this.reject=e})}}f.Contract=q;f.GenericResult=k;f.Cache=r;f.ParsedUrl=p;f.UrlMatcher=t;f.Ipv4RangeMatcher=n;f.Poller=m;f.Future=e;f.JWTVerify=(d,e)=>{if(!d.hasOwnProperty("JWT"))throw h.error("[SEF.Web Error]: JWT::Invalid payload"),new SEF.exceptions.JWTInvalidPayloadException;if(!0!==KJUR.jws.JWS.verify(d.JWT,KEYUTIL.getKey(e),["RS256"]))throw h.error("[SEF.Web Error]: JWT verification failure"),new SEF.exceptions.JWTVerificationException;
if(KJUR.jws.JWS.readSafeJSONString(b64utoutf8(d.JWT.split(".")[1])).hash!==forge.md.sha256.create().update(JSON.stringify(d.payload)).digest().toHex())throw h.error("[SEF.Web Error]: Payload hash mismatch"),new SEF.exceptions.JWTPayloadHashMismatchException;};f.notify=d=>{setTimeout(d=>{try{SEF.config.Get("notificationCallback")(d)}catch(x){}},0,d)};f.perf={Start:()=>null,End:()=>null};f.isNil=d=>void 0===d||null===d;f.isntNil=d=>!f.isNil(d);f.trim=(d,e)=>d.length<=e?d:`${d.slice(0,e-8)}...${d.slice(-5)}`;
f.MakePrototype=d=>d?d:class{};f.url={isValid(d,e=null){if(!d)return!1;try{const a=new URL(d);if(0===a.hostname.length||0===a.protocol.length)return!1;if("function"===typeof e)return e(a)}catch(x){return!1}return!0},isValidHttp(e){return f.url.isValid(e,e=>"http:"===e.protocol||"https:"===e.protocol)},PIIClean(e){if(f.url.isValidHttp(e)){var d=e.indexOf("?");return e.substring(0,-1!==d?d:e.length)}return null},Clean(e){try{const d=new URL(e);return`${d.protocol}//${d.host}${d.pathname}`}catch(B){return null}}};
f.GetBrowserVersion=()=>{var e=navigator.userAgent;try{var a=e.match(/(?<name>chrome|safari|firefox(?=\/))\/?\s*(?<version>[\d.]+)/i)||[];if("Chrome"===a[1]){var m=e.match(/\bEdg\/(?<version>[\d.]+)/);if(null!==m)return{name:"Edge",version:m[1]}}a=a[2]?[a[1],a[2]]:[navigator.appName,navigator.appVersion];null!==(m=e.match(/version\/(?<version>[\d.]+)/i))&&a.splice(1,1,m[1]);return{name:a[0],version:a[1]}}catch(u){return h.error(`Failed to get browser version from user agent, ${e}, err is ${u}`),{name:"",
version:""}}};f.ValidateAndRetrieveIpv4Address=e=>{if(e=/^(?<subnet0>25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?<subnet1>25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?<subnet2>25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?<subnet3>25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.exec(e)){let d=new Uint32Array(1);e.forEach(e=>{d[0]=(d[0]<<8)+parseInt(e,10)});return d[0]}return null};f.Sleep=e=>new Promise.resolve(d=>setTimeout(d,e));return f}()})(this);(function(){(SEF.utils=SEF.utils||{}).Message=function(){function a(a,b,k,c){return a+(b^c)&255^b^~k&255^c}const b={},c=new SEF.utils.Logger("MSGUTIL"),g=SEF.context.browserObject.runtime.id.substr(0,13).split("");let h=!0;g.forEach((a,b,k)=>{k[b]=a.charCodeAt(0)});let l=!0;b.unwrap=function(a,b){a=a.match(/.{1,2}/g);let k="";for(let m=0;m<a.length;m++){var c=parseInt(a[m],16),f="And this is another random long piece".charCodeAt(m%37),t="(Message utility hexing string)".charCodeAt(m%31),n=b[m%b.length];
k+=String.fromCharCode((c^f^~t&255^n)-(f^n)&255)}return JSON.parse(k)};b.wrap=function(b,c){b=JSON.stringify(b);let k="";for(let f=0;f<b.length;f++){let l=Number(a(b.charCodeAt(f),"And this is another random long piece".charCodeAt(f%37),"(Message utility hexing string)".charCodeAt(f%31),c[f%c.length])).toString(16);1===l.length&&(l=`0${l}`);k+=l}return k};b.setKey=function(a){b.sessionKey=a;l=!1};b.resetKey=function(){b.sessionKey=g;l=!0};b.isDefaultKey=function(){return l};b.sessionKey=g;b.checkBridgeMessageEncryption=
function(a){"object"===typeof a&&null!==a?(h=!1,c.info("No bridge version received from native port, assume it is 1.0.0, dont encrypt messages.")):h=!0};b.haveMessageEncryption=function(){return h};return b}()})(this);(function(a){(function(){const b=new SEF.utils.Logger("POLYFILLS");class c{}class g{}SEF.eventing=SEF.eventing||{};Promise.allSettled=Promise.allSettled||function(a){return Promise.all(a.map(function(a){return Promise.resolve(a).then(this.onFulfilled).catch(this.onRejected)},{onFulfilled(a){return{status:"fulfilled",value:a}},onRejected(a){return{status:"rejected",reason:a}}}))};const h=class{constructor(a){this.listeners=new Set;this.id=a}addListener(a){if("function"!==typeof a)throw Error("listener to EventListenerType must be callable");
this.listeners.add(a)}removeListener(a){this.listeners.delete(a)}hasListener(a){return this.listeners.has(a)}emit(a){const c=[];this.listeners.forEach(f=>{try{c.push(f(a))}catch(k){b.error(`Error while calling listeners for <${this.id}>: ${k} ${k.stack}`)}});return c}};SEF.eventing.EventListenerType=h;if("edge"===SEF.context.BROWSER.toLowerCase()||"safari"===SEF.context.BROWSER.toLowerCase()){if(SEF.eventing.EventTarget=class extends c{constructor(){super();this.listeners=new Map}addEventListener(a,
b){if("string"!==typeof a)throw Error("'type' must be a string");if("function"!==typeof b)throw Error("listener must be callable");this.listeners.has(a)||this.listeners.set(a,new Set);this.listeners.get(a).add(b)}removeEventListener(a,b){this.listeners.has(a)&&this.listeners.get(a).delete(b)}dispatchEvent(a){if(!(a instanceof SEF.eventing.CustomEvent))throw Error("Parameter is not of type 'Event'");a instanceof g&&(a.eventPhase=2,a.target=this);let c=this.listeners.get(a.type);if(c){c=c.values();
let f;for(;!(f=c.next()).done;)try{if(!0===a.cancelImmediate)break;f.value(a)}catch(k){b.error(`[Polyfill::EventTarget] Error while dispatch: ${k}`)}}a instanceof g&&(a.eventPhase=0);return!a.defaultPrevented}},"safari"===SEF.context.BROWSER.toLowerCase()){SEF.eventing.CustomEvent=class extends g{static get NONE(){return 0}static get CAPTURING_PHASE(){return 1}static get AT_TARGET(){return 2}static get BUBBLING_PHASE(){return 3}constructor(a,b={detail:null,bubbles:!1,cancelable:!1,composed:!1}){super();
Object.defineProperties(this,{type:{value:a,writble:!1},bubbles:{value:b.bubbles,writble:!1},cancelable:{value:b.cancelable,writble:!1},composed:{value:b.composed,writble:!1},isTrusted:{value:!1,writble:!1}});this.detail=b.detail;this.defaultPrevented=this.cancelBubble=!1;this.eventPhase=0;this.target=null;this.timeStamp=(new Date).getTime()}stopPropagation(){this.cancelBubble=!0}preventDefault(){this.defaultPrevented=!0}stopImmediatePropagation(){this.cancelImmediate=!0}composedPath(){return null}};
class b{constructor(a){this.headers=a.headers;this.ok=a.ok;this.redirected=a.redirected;this.status=a.status;this.statusText=a.statusText;this.type=a.type;this.url=a.url;this.useFinalURL=a.useFinalURL;this.body=a.body;this.bodyUsed=!1}clone(){return Object.assign({},this)}error(){return Object.assign({},this)}arrayBuffer(){try{return Promise.resolve(this.body)}catch(q){return Promise.reject(q)}}json(){try{return Promise.resolve(JSON.parse(String.fromCharCode(this.body)))}catch(q){return Promise.reject(q)}}text(){try{return Promise.resolve(String.fromCharCode(this.body))}catch(q){return Promise.reject(q)}}}
a.fetch=function(...a){return new Promise((c,f)=>{_fetch(...a).then(a=>{c(new b(a))}).catch(a=>{f(a)})})};class c{constructor(a){this.name=a}}SEF.context.browserObject.tabs={captureTab(a,b){return new Promise((c,k)=>{a.captureTab(b).then(a=>{c(a)}).catch(k)})},connect(a,b){a.connect(b);return new c(b.name)},create(a){return new Promise((b,c)=>{_openTab(a).then(b).catch(c)})},reload(a,b){return new Promise((c,k)=>{a.reload(b).then(c).catch(k)})},remove(a){a=Array.isArray(a)?a:[a];return Promise.all(a.reduce((a,
b)=>{a.push(new Promise((a,c)=>{b.remove().then(a).catch(c)}));return a},[]))},sendMessage(a,b,c){return new Promsie((k,t)=>{a.sendMessage(b,c).then(k).catch(t)})},update(a,b){return new Promise((c,k)=>{a.update(b).then(c).catch(k)})}};SEF.context.browserObject.runtime={connect(){throw Error("Not supported");},onConnect:new h("runtime::onConnect"),onMessage:new h("runtine::onMessage"),getURL(){return""}};SEF.context.browserObject.webRequest={onAuthRequired:new h("onAuthRequired"),onBeforeRedirect:new h("onBeforeRedirect"),
onBeforeRequest:new h("onBeforeRequest"),onBeforeSendHeaders:new h("onBeforeSendHeaders"),onCompleted:new h("onCompleted"),onErrorOccurred:new h("onErrorOccurred"),onHeadersReceived:new h("onHeadersReceived"),onResponseStarted:new h("onResponseStarted"),onSendHeaders:new h("onSendHeaders")}}}else SEF.eventing.EventTarget=EventTarget})()})(this);(function(a){a.SEF=a.SEF||{};(function(){function a(a,d){const e=a[d];e&&"function"===typeof e&&(a[d]=(...a)=>{if(!SEF.config.Get("actionConsolidation"))return null;const d=e(...a);return d&&d instanceof n?(d.Consolidate(),a=d[SEF.symbols.EventContext],SEF.exclusions.IsTrustedHost(a.url)&&(d.trustedHost=!0),SEF.exclusions.IsExcluded(a.url,a.tabId)&&(d.Allow(),d.exclusion=!0),d[SEF.symbols.Action]===SEF.eventing.Actions.DEFER?d[SEF.symbols.ActionData].then(()=>SEF.DispatchEvent(d)?d.DoAction():null):
SEF.DispatchEvent(d)?d.DoAction():null):d})}function c(a){const e=a[k];e&&Object.entries(e.consolidators).forEach(([d,b])=>{e.target[d].removeListener(a[d]);b&&Array.isArray(b)&&0<b.length?e.target[d].addListener(a[d],...b):e.target[d].addListener(a[d])})}function g(a){const e=a[k];e&&Object.entries(e.consolidators).forEach(([d])=>{e.target[d].removeListener(a[d])})}const {exceptions:h,constants:l}=SEF;SEF.core=SEF.core||{};SEF.eventing=SEF.eventing||{};SEF.eventing.CustomEvent=SEF.eventing.CustomEvent||
CustomEvent;var f=SEF.eventing.EventTarget||EventTarget;const q=Symbol("listener"),k=Symbol("setupInfo");SEF.eventing.EventTarget=class extends f{AddEventListener(...a){return super.addEventListener(...a)}RemoveEventListener(...a){return super.removeEventListener(...a)}DispatchEvent(a){return super.dispatchEvent(a)}DispatchEventAsync(a){setTimeout(a=>{this.DispatchEvent(a)},0,a);return!0}dispatchEvent(a){return SEF.eventing.EventTarget.prototype.DispatchEvent.bind(this)(a)}};({utils:f}=SEF);const r=
new f.Logger("EVENTING"),p=new SEF.eventing.EventTarget;SEF.eventing.Proxies=new WeakMap;f=new class{constructor(){this.map=new Map;return this.Dispatch.bind(this)}Dispatch(a){if(this.map.has(a.type)){const e=this.map.get(a.type);clearTimeout(e.id);a.next=e.event}this.map.set(a.type,{event:a,id:setTimeout(()=>{this.map.delete(a);SEF.DispatchEvent(a)},0)})}};Object.defineProperties(SEF,{AddEventListener:{value:function(...a){return p.addEventListener(...a)},writable:!1},RemoveEventListener:{value:function(...a){return p.removeEventListener(...a)},
writable:!1},DispatchEvent:{value:function(...a){return p.dispatchEvent(...a)},writable:!1},DispatchEventAsync:{value:function(...a){return new Promise((e,b)=>{setTimeout((...a)=>{try{e(p.dispatchEvent(...a))}catch(u){b(u)}},0,...a)})},writable:!1},ConsolidatedAsyncDispatch:{value:f,writable:!1}});SEF.eventing.Actions={DEFAULT:"Default",BLOCK:"Block",REDIRECT:"Redirect",ALLOW:"Allow",MODIFY:"ModifyHeaders",ISOLATE:"WebIsolatation",UPGRADE:"UpgradeToSecure",CUSTOM:"CustomAction",ASYNC:"Async",DEFER:"Deferred",
ERROR:"Error"};class t{constructor(a){this.future=Promise.resolve(a)}}const n=class extends SEF.eventing.CustomEvent{constructor(a,d={},b={},m="done"){d.hasOwnProperty("detail")||(d.detail={});super(a,d);Object.defineProperty(this,SEF.symbols.EventContext,{value:Object.freeze({id:b.id,tabId:b.tabId,requestId:b.requestId,frameId:b.frameId,url:b.url}),writable:!1});Object.defineProperty(this,SEF.symbols.CustomAction,{value:[],writable:!1});this.checkpoint=m;this.contextMap=n.contextMap}Process(){if(this.eventPhase!==
SEF.eventing.CustomEvent.NONE)throw Error("Cannot process event at this phase");var a=this[SEF.symbols.EventContext];a=`${a.tabId}:${a.requestId}`;this.contextMap.has(a)||this.contextMap.set(a,{[SEF.eventing.WebRequestListener.checkpoint.REQUEST]:new Map,[SEF.eventing.WebRequestListener.checkpoint.RESPONSE]:new Map,[SEF.eventing.WebRequestListener.checkpoint.DONE]:new Map});this.contextMap.get(a)[this.checkpoint].set(this.target||this[SEF.symbols.Target],this)}Consolidate(a=null){if(this.eventPhase!==
SEF.eventing.CustomEvent.NONE)throw Error("Cannot consolidate this event in the current phase");const {checkpoint:d}=this;var e={[l.actionProfiles.SECURE]:a=>{const e={action:SEF.eventing.Actions.ALLOW},b={[`${d}Headers`]:[]},[m,c,n]=[[],[],[]];for(const k of a)switch(k[SEF.symbols.Action]){case SEF.eventing.Actions.BLOCK:case SEF.eventing.Actions.ISOLATE:case SEF.eventing.Actions.REDIRECT:return{action:k[SEF.symbols.Action],actionData:k[SEF.symbols.ActionData]};case SEF.eventing.Actions.MODIFY:b[`${d}Headers`]=
b[`${d}Headers`].concat(k[SEF.symbols.ActionData][`${d}Headers`]);e.action=SEF.eventing.Actions.MODIFY;c.push(k);break;case SEF.eventing.Actions.ASYNC:m.push(k[SEF.symbols.ActionData]);break;case SEF.eventing.Actions.DEFER:n.push(k[SEF.symbols.ActionData])}e.action=0<n.length?SEF.eventing.Actions.DEFER:0<m.length?SEF.eventing.Actions.ASYNC:e.action;e.actionData=0<n.length||0<m.length?Promise.allSettled([...n,...m,...c]).then(a=>{a.filter(a=>"rejected"===a.status).forEach(a=>{r.error(`Consolidation<secure> Error: ${a}`)});
this.Consolidate(a.filter(a=>"fulfilled"===a.status).map(a=>a.value));return this}):e.action===SEF.eventing.Actions.MODIFY?b:{cancel:!1};return e},[l.actionProfiles.PRIORITY]:a=>{const e={action:SEF.eventing.Actions.ALLOW,actionData:{cancel:!1}};let d=0;for(const b of a)({weight:a}=b.target||b[SEF.symbols.Target]),a>d&&(d=a,e.action=b[SEF.symbols.Action],e.actionData=b[SEF.symbols.ActionData]);return e},[l.actionProfiles.CONSENSUS]:a=>{const [e,b]=[{},{action:SEF.eventing.Actions.ALLOW,actionData:{cancel:!1}}];
let [m,c]=[[],[]],n=[];const [k,t,f,l]=[0,1,0,1],g={[`${d}Headers`]:[]};for(const d of a)e.hasOwnProperty(d[SEF.symbols.Action])?(e[d[SEF.symbols.Action]].votes++,e[d[SEF.symbols.Action]].data.push(d[SEF.symbols.ActionData])):e[d[SEF.symbols.Action]]={votes:1,data:[d[SEF.symbols.ActionData]]};n=Object.entries(e).sort((a,e)=>[SEF.eventing.Actions.DEFER,SEF.eventing.Actions.ASYNC].includes(a[f])?1:e[l].votes-a[l].votes);b.action=n[k][f];e.hasOwnProperty(SEF.eventing.Actions.ASYNC)&&(c=e[SEF.eventing.Actions.ASYNC].data,
2===n.length&&n[k][l].votes<n[t][l].votes||2<n.length&&n[k][l].votes-n[t][l].votes<e[SEF.eventing.Actions.ASYNC].votes)&&(b.action=SEF.eventing.Actions.ASYNC);e.hasOwnProperty(SEF.eventing.Actions.DEFER)&&(m=e[SEF.eventing.Actions.DEFER].data,b.action=SEF.eventing.Actions.DEFER);b.actionData=b.action===SEF.eventing.Actions.ASYNC||b.action===SEF.eventing.Actions.DEFER?Promise.allSettled([...m,...c]).then(e=>{e.filter(a=>"rejected"===a.status).forEach(a=>{r.error(`Consolidation <consensus> Error: ${a}`)});
this.Consolidate(a);return this}):b.action===SEF.eventing.Actions.MODIFY?e[SEF.eventing.Actions.MODIFY].data.reduce((a,e)=>{a[`${d}Headers`]=a[`${d}Headers`].concat(e[`${d}Headers`]);return a},g):n[k][l].data[0];return b}};this.actionProfile=SEF.config.Get("actionProfile");if(!a||!Array.isArray(a)){a=null;var b=this[SEF.symbols.EventContext];if(b=this.contextMap.get(`${b.tabId}:${b.requestId}`))this.recommendations=b[d],a=[...this.recommendations.values()]}a&&(e=e[this.actionProfile](a),this[SEF.symbols.Action]=
e.action,this[SEF.symbols.ActionData]=e.actionData,this[SEF.symbols.Incidents]=a.map(a=>a.detail.incidents||[]).flat())}GetAction(){return this[SEF.symbols.Action]}GetActionData(){return this[SEF.symbols.ActionData]}Error(a){this[SEF.symbols.Action]=SEF.eventing.Actions.ERROR;this[SEF.symbols.ActionData]=a}Defer(a){this[SEF.symbols.Return]=a;this[SEF.symbols.Action]=SEF.eventing.Actions.DEFER;this[SEF.symbols.ActionData]=a.then(a=>{this[SEF.symbols.Return]=a;n.PrepareForDispatch(this);return this}).catch(a=>
{this[SEF.symbols.Return]={error:a};n.PrepareForDispatch(this);return this});this.Process()}Async(a){this[SEF.symbols.Action]=SEF.eventing.Actions.ASYNC;this[SEF.symbols.ActionData]=a.then(a=>{this[SEF.symbols.Return]=a;n.PrepareForDispatch(this);return this}).catch(a=>{this[SEF.symbols.Return]={error:a};n.PrepareForDispatch(this);return this})}Block(a=!1){SEF.config.Get("returnSafeLandingPage")&&!0!==a?(this[SEF.symbols.Action]=SEF.eventing.Actions.REDIRECT,a=`${SEF.context.browserObject.runtime.getURL(SEF.constants.SAFE_LANDING_PAGE)}?url=${this[SEF.symbols.EventContext].url}`,
this[SEF.symbols.ActionData]={redirectUrl:a}):(this[SEF.symbols.Action]=SEF.eventing.Actions.BLOCK,this[SEF.symbols.ActionData]={cancel:!0})}Redirect(a){this[SEF.symbols.Action]=SEF.eventing.Actions.REDIRECT;SEF.config.Get("returnSafeLandingPage")&&(a=`${SEF.context.browserObject.runtime.getURL(l.SAFE_LANDING_PAGE)}?url=${this[SEF.symbols.EventContext].url}`);this[SEF.symbols.ActionData]={redirectUrl:a}}Isolate(a){this[SEF.symbols.Action]=SEF.eventing.Actions.ISOLATE;this[SEF.symbols.ActionData]=
{isolationUrl:`${a}${this[SEF.symbols.EventContext].url}`}}Allow(){this[SEF.symbols.Action]=SEF.eventing.Actions.ALLOW;this[SEF.symbols.ActionData]={cancel:!1}}CustomAction(a,...d){"function"===typeof a&&this[SEF.symbols.CustomAction].push([a,d])}DoAction(){if(this.eventPhase!==SEF.eventing.CustomEvent.NONE)throw Error("Action not permitted during dispatch");var a={[SEF.eventing.Actions.BLOCK]:()=>this[SEF.symbols.ActionData],[SEF.eventing.Actions.ALLOW]:()=>this[SEF.symbols.ActionData],[SEF.eventing.Actions.UPGRADE]:()=>
this[SEF.symbols.ActionData],[SEF.eventing.Actions.REDIRECT]:()=>{this[SEF.symbols.EventContext].hasOwnProperty("tabId")&&SEF.context.browserObject.tabs.update(this[SEF.symbols.EventContext].tabId,{url:this[SEF.symbols.ActionData].redirectUrl,active:!0});return{cancel:!0}},[SEF.eventing.Actions.APPLYCSP]:()=>this[SEF.symbols.ActionData],[SEF.eventing.Actions.MODIFY]:()=>this[SEF.symbols.ActionData],[SEF.eventing.Actions.ASYNC]:()=>this[SEF.symbols.ActionData].then(a=>a.DoAction()),[SEF.eventing.Actions.ISOLATE]:()=>
{SEF.context.browserObject.tabs.update(this[SEF.symbols.EventContext].tabId,{url:this[SEF.symbols.ActionData].isolationUrl,active:!0})},[SEF.eventing.Actions.ERROR]:()=>({cancel:!1}),[SEF.eventing.Actions.DEFAULT]:()=>this[SEF.symbols.ActionData],[SEF.eventing.Actions.DEFER]:()=>this[SEF.symbols.ActionData],undefined:()=>{}};0<this[SEF.symbols.CustomAction].length&&this[SEF.symbols.CustomAction].forEach(([a,e])=>{try{a.bind(this)(...e)}catch(x){r.warn("Custom action failure: "+`<${this.type}>[${JSON.stringify(this[SEF.symbols.EventContext])}]: ${x}`)}});
try{const e=this[SEF.symbols.Incidents];if(e)for(const a of e){a.payload=a.payload||{};a.excluded=!1;this.exclusion&&(a.action={cancel:!1},a.excluded=!0);try{SEF.utils.Telemetry.SendTelemetry(a)}catch(x){}}return a[this[SEF.symbols.Action]]()}catch(d){return a=(a=this.target||this[SEF.symbols.Target])?a[SEF.symbols.ModuleName]:"Unknown",r.error(`DoAction error: target: '${a}' action: '${this[SEF.symbols.Action]}' `+`data: '${this[SEF.symbols.ActionData]}' error: ${d}`),{cancel:!1}}}static PrepareForDispatch(a){const d=
a[SEF.symbols.Return];a[SEF.symbols.Action]=SEF.eventing.Actions.DEFAULT;a[SEF.symbols.ActionData]=d;try{if(d){if(d instanceof t)return a.Defer(d.future),d.future;d instanceof Promise||d instanceof SEF.common.Contract?a.Async(d):d.hasOwnProperty("silent")?a.Allow():d.hasOwnProperty("cancel")?!0===d.cancel?d.hasOwnProperty("suppress")?a.Block(d.suppress):a.Block(!1):!1===d.cancel&&a.Allow():d.hasOwnProperty("requestHeaders")||d.hasOwnProperty("responseHeaders")?a.ModifyHeaders(d):d.hasOwnProperty("redirectUrl")?
a.Redirect(d.redirectUrl):d.hasOwnProperty("upgradeToSecure")?d.upgradeToSecure?a.UpgradeToSecure():a.Allow():d.hasOwnProperty("authCredentials")?a.CustomAction(d):d.hasOwnProperty("isolationUrl")?a.Isolate(d.isolationUrl):d.hasOwnProperty("error")&&a.Error(d.error)}}catch(B){let e=a.target||a[SEF.symbols.Target];e=e?e[SEF.symbols.ModuleName]:"Unknown";r.error(`Action processing error: type: <${a.type}> target: <${e}> `+`capture: <${a[SEF.symbols.Capture]}> result: '<${d}' error: <${B}>`)}return!0}};
n.contextMap=new Map;class m extends n{Process(){}Consolidate(){}}f=class{constructor(a,d,b,m,...c){if(!(a instanceof SEF.core.ModuleBase))throw new h.InvalidModuleException;if(!d.hasOwnProperty(b))throw new h.EventNotSupportedException(d,b);if(void 0===d[b].addListener||null===d[b].addListener)throw new h.ListenerInterfaceNotSupportedException(b);if("function"!==typeof m)throw new h.ObjectNotCallableException;this.propagation=this.cancelable=this.autoStart=!0;this.EventTypeImpl=n;this.eventTarget=
a||p;Object.defineProperties(this,{target:{value:d,writable:!1},eventType:{value:b,writable:!1},listener:{value:a=>{if(SEF.exclusions.IsTrustedHost(a.url))return null;const d={type:b,detail:{},stopImmediatePropagation(){this._stopImmediate=!0},stopPropagation(){this._stopPropagation=!0},defer(a){return new t(a)}},e=m.bind(d)(a),c=new this.EventTypeImpl(d.type,{detail:d.detail,cancelable:this.cancelable,bubbles:!0},a);if(!1===this.propagation||!0===d._stopPropagation)c.stopPropagation(),c.__cancelBubble=
!0;!0===d._stopImmediate&&c.stopImmediatePropagation();c[SEF.symbols.Return]=e;c[SEF.symbols.Capture]=b;c[SEF.symbols.Target]=this.eventTarget;a=n.PrepareForDispatch(c);return a instanceof Promise||a instanceof SEF.common.Contract?a.then(()=>this.__doDispatch(c),()=>this.__doDispatch(c)):this.__doDispatch(c)},writable:!0},params:{value:c,writable:!1}});this.isListening=!1;a[SEF.symbols.Listeners].set(m,this)}static [q](){return!0}__doDispatch(a){this.PreDispatch(a);return!1===a.cancelable?(this.eventTarget.DispatchEventAsync(a),
a.DoAction()||a[SEF.symbols.Return]):this.eventTarget.DispatchEvent(a)?a.DoAction()||a[SEF.symbols.Return]:null}PreDispatch(){return this}NoAutoStart(){this.autoStart=!1;return this}Listen(a=null){this.target[this.eventType].hasListener(this.listener)||(this.target[this.eventType].addListener(this.listener,...this.params),this.isListening=!0,a&&SEF.ConsolidatedAsyncDispatch(new SEF.eventing.CustomEvent(a,{detail:{proto:this.constructor,self:this,target:this.target,event:this.eventType}})));return this}Stop(a=
null){this.target[this.eventType].hasListener(this.listener)&&(this.target[this.eventType].removeListener(this.listener),this.isListening=!1,a&&SEF.ConsolidatedAsyncDispatch(new SEF.eventing.CustomEvent(a,{detail:{proto:this.constructor,self:this,target:this.target,event:this.eventType}})));return this}IsListening(){return this.isListening}};Object.defineProperty(SEF,"Propagate",{value(a){a instanceof m?SEF.DispatchEvent(a):SEF.config.Get("actionConsolidation")&&(a.preventDefault(),a.Process())},
writable:!1});SEF._initFuture=new SEF.common.Future;SEF._initFuture.promise=SEF._initFuture.promise.then(()=>{const e=Object.values(SEF.eventing).filter(a=>a[q]?!0:!1);e.forEach(d=>{if(d.Setup){const e=d.Setup();e&&e.target&&e.consolidators&&(Object.keys(e.consolidators).forEach(e=>a(d,e)),d[k]=e,c(d),e.resetTrigger&&SEF.AddEventListener(e.resetTrigger,a=>{c(a.detail.proto)}))}});SEF.AddEventListener("ondisabled",()=>{e.forEach(g)});SEF.AddEventListener("onenabled",()=>{e.forEach(c)})});SEF.OnInitComplete=
function(){return this._initFuture.promise};SEF.eventing.EventBase=n;SEF.eventing.UnconsolidatableEvent=m;SEF.eventing.ListenerBase=f})()})(this);(function(){(function(){class a extends SEF.eventing.EventBase{constructor(b,g,h,l="done"){super(b,g,h);this instanceof a||Object.setPrototypeOf(this,a.prototype);this.checkpoint=l;this.contextMap=a.contextMap}static ClearContext(a){SEF.eventing.WebRequestEvent.contextMap.delete(`${a.tabId}:${a.requestId}`)}ApplyCSP(a){this.ModifyHeaders({[`${this.checkpoint}Headers`]:[{name:"Content-Security-Policy",value:a}]})}UpgradeToSecure(){this[SEF.symbols.Action]=SEF.eventing.Actions.UPGRADE;this[SEF.symbols.ActionData]=
{upgradeToSecure:!0}}ModifyHeaders(a){this[SEF.symbols.Action]=SEF.eventing.Actions.MODIFY;this[SEF.symbols.ActionData]=a;this.checkpoint=a.hasOwnProperty("requestHeaders")?SEF.eventing.WebRequestListener.checkpoint.REQUEST:a.hasOwnProperty("responseHeaders")?SEF.eventing.WebRequestListener.checkpoint.RESPONSE:SEF.eventing.WebRequestListener.checkpoint.DONE}}a.contextMap=new Map;class b extends SEF.eventing.ListenerBase{constructor(c,g,h,...l){super(c,SEF.context.browserObject.webRequest,g,h,...l);
this.EventTypeImpl=a;Object.defineProperty(this,"checkpoint",{value:{onBeforeRequest:b.checkpoint.REQUEST,onBeforeSendHeaders:b.checkpoint.REQUEST,onSendHeaders:b.checkpoint.RESPONSE,onBeforeRedirect:b.checkpoint.REQUEST,onAuthRequired:b.checkpoint.REQUEST,onHeadersReceived:b.checkpoint.RESPONSE,onResponseStarted:b.checkpoint.DONE,onCompleted:b.checkpoint.DONE}[g]||b.checkpoint.DONE,writable:!1})}PreDispatch(a){a.checkpoint=this.checkpoint}Listen(){return super.Listen("addWebRequestListener")}Stop(){return super.Stop("removeWebRequestListener")}static onBeforeSendHeaders(c){return new a(`web${b.checkpoint.REQUEST}`,
{cancelable:!0},c,b.checkpoint.REQUEST)}static onHeadersReceived(c){return new a(`web${b.checkpoint.RESPONSE}`,{cancelable:!0},c,b.checkpoint.RESPONSE)}static onErrorOccurred(b){a.ClearContext(b)}static onCompleted(b){a.ClearContext(b)}static Setup(){SEF.config.AddListener((a,b,h)=>{"actionConsolidation"===a&&!1===h&&SEF.eventing.WebRequestEvent.contextMap.clear()});return{target:SEF.context.browserObject.webRequest,consolidators:{onBeforeSendHeaders:[{urls:["<all_urls>"]},["requestHeaders","blocking"]],
onHeadersReceived:[{urls:["<all_urls>"]},["responseHeaders","blocking"]],onErrorOccurred:[{urls:["<all_urls>"]}],onCompleted:[{urls:["<all_urls>"]}]},resetTrigger:"addWebRequestListener"}}}b.checkpoint={REQUEST:"request",RESPONSE:"response",DONE:"done"};SEF.eventing.WebRequestEvent=a;SEF.eventing.WebRequestListener=b;SEF.eventing.Proxies.set(SEF.context.browserObject.webRequest,SEF.eventing.WebRequestListener)})()})(this);(function(){(function(){const {EventListenerType:a}=SEF.eventing;SEF.eventing.webContent={onScript:new a("onScript"),onPhoneNumber:new a("onPhoneNumber"),...!1};SEF.eventing.webPages={onVisibilityChange:new a("onVisibilityChange"),onMouseEvent:new a("onMouseEvent"),onKeyEvent:new a("onKeyEvent"),onMediaEvent:new a("onMediaEvent")};class b extends SEF.eventing.EventBase{constructor(a,c,l,f){super(a,c,l,f);this.contextMap=b.contextMap;this.port=l.port}Consolidate(...a){super.Consolidate(...a);a=this[SEF.symbols.EventContext];
b.contextMap.delete(`${a.tabId}:${a.requestId}`)}}b.contextMap=new Map;class c extends SEF.eventing.ListenerBase{constructor(a,c,l,...f){super(a,SEF.eventing.webContent,c,l,...f);this.EventTypeImpl=b}Listen(){return super.Listen("addWebContentListener")}static CreateRequestId(){return Infinity===++c.requestId?c.requestId=1:c.requestId}static onScript(a){return new b("webcontent",{cancelable:!0},a)}static onPhoneNumber(a){return new b("webcontent",{cancelable:!0},a)}static Setup(){SEF.bridge.portManager.OnConnect(a=>
{a.OnReceive(function(a){const b={tabId:this.port.sender.tab.id,frameId:this.port.sender.frameId||0,url:this.port.sender.url,requestId:`__webcontent__${c.CreateRequestId()}`,buffer:a.buffer,info:a.info,port:this};switch(a.type){case "script":SEF.eventing.webContent.onScript.emit(b);break;case "phonenumber":SEF.eventing.webContent.onPhoneNumber.emit(b);break;case "visibilitychange":SEF.eventing.webPages.onVisibilityChange.emit(b);break;case "mouseevent":SEF.eventing.webPages.onMouseEvent.emit(b);break;
case "keyevent":SEF.eventing.webPages.onKeyEvent.emit(b);break;case "mediaevent":SEF.eventing.webPages.onMediaEvent.emit(b)}})},"webcontent");return{target:SEF.eventing.webContent,consolidators:{onScript:[],onPhoneNumber:[],...!1},resetTrigger:"addWebContentListener"}}}c.requestId=0;SEF.eventing.WebContentListener=c;SEF.eventing.Proxies.set(SEF.eventing.webContent,SEF.eventing.WebContentListener)})()})(this);(function(){(function(){const {EventListenerType:a}=SEF.eventing;SEF.eventing.reputationResult={onReputationResult:new a("onReputationResult"),...!1};class b extends SEF.eventing.EventBase{constructor(a,c,l,f){super(a,c,l,f);this.contextMap=b.contextMap;this.port=l.port}Consolidate(...a){super.Consolidate(...a);a=this[SEF.symbols.EventContext];b.contextMap.delete(`${a.tabId}:${a.requestId}`)}}b.contextMap=new Map;class c extends SEF.eventing.ListenerBase{constructor(a,c,l,...f){super(a,SEF.eventing.reputationResult,
c,l,...f);this.EventTypeImpl=b}Listen(){return super.Listen("addReputationResultListener")}Stop(){return super.Stop("removeReputationResultListener")}static onReputationResult(a){return new b("reputationresult",{cancelable:!0},a)}static Setup(){return{target:SEF.eventing.reputationResult,consolidators:{onReputationResult:[],...!1},resetTrigger:"addReputationResultListener"}}}SEF.eventing.ReputationResultListener=c;SEF.eventing.Proxies.set(SEF.eventing.reputationResult,SEF.eventing.ReputationResultListener)})()})(this);(function(){function a(a){return{get(a,e){return SEF.eventing.Proxies.has(a)?{addListener(d,...b){return r.Add(this[SEF.symbols.Module],SEF.eventing.Proxies.get(a),e,d,...b)},removeListener(a){return r.Remove(this[SEF.symbols.Module],a)},hasListener(a){return r.Has(this[SEF.symbols.Module],a)},[SEF.symbols.Module]:this.module}:a[e]},module:a}}function b(a,...d){"function"!==typeof a||Object.isFrozen(a)||(a.bind=()=>{throw new SEF.exceptions.RebindingProhibited(...d);},a.call=()=>{throw new SEF.exceptions.RebindingProhibited(...d);
},a.apply=()=>{throw new SEF.exceptions.RebindingProhibited(...d);});return Object.freeze(a)}function c(a){if(null===a||void 0===a)throw Error("Cannot escalate null object");if(a[SEF.symbols.ModuleId]===this[SEF.symbols.ModuleId])throw Error("Cannot escalate self");if(!1===a instanceof SEF.core.ModuleBase)throw Error("Object must be a SEF.ModuleBase");if(!0!==a.Grant(this))throw new SEF.exceptions.OperationNotPermitted;return k.has(a)?Object.assign(Object.create(a),k.get(a),{[SEF.symbols.IsEscalated]:!0}):
a}const g=Symbol("Resolve"),h=Symbol("Reject"),l=Symbol("InitFuture");let f=0;const q=new SEF.utils.Logger("PROLOGUE"),k=new WeakMap;class r{static Add(a,d,b,m,...c){return new d(a,b,m,...c)}static Remove(a,d){a[SEF.symbols.Listeners].has(d)&&a[SEF.symbols.Listeners].get(d).Stop()}static Has(a,d){return a[SEF.symbols.Listeners].has(d)?a[SEF.symbols.Listeners].get(d).IsListening():!1}}SEF.core=SEF.core||{};SEF.utils=SEF.utils||{};class p extends SEF.eventing.EventTarget{constructor(a={}){try{super();
if(new.target===SEF.core.ModuleBase)throw new SEF.exceptions.AbstractClassException("Cannot instantiate SEF.ModuleBase");if(!a.name)throw new SEF.exceptions.ModuleParamMissingException("name");if(!a.version)throw new SEF.exceptions.ModuleParamMissingException("version");a.configurations&&(a.configAccessRoot=SEF.config.Add(this,a.name,a.configurations));a.protected&&k.set(this,a.protected);this[SEF.symbols.ErrorInfo]={};Object.defineProperties(this,{[SEF.symbols.ModuleName]:{writable:!1,value:a.name},
[SEF.symbols.Version]:{writable:!1,value:a.version},[SEF.symbols.ModuleType]:{writable:!1,value:a.type||"soft"},[SEF.symbols.ModulePublicKey]:{writable:!1,value:a.publicKey},[SEF.symbols.ModuleId]:{writable:!1,value:Symbol("ModuleId")},[SEF.symbols.ModuleSequenceId]:{writable:!1,value:f++},[SEF.symbols.Listeners]:{writable:!1,value:new Map},[SEF.symbols.Pollers]:{writable:!1,value:a.pollers&&Array.isArray(a.pollers)?a.pollers.reduce((a,d)=>{try{a.push(new SEF.common.Poller(...d))}catch(v){q.error(`Invalid poller configs. ${v}`)}return a},
[]):[]},[SEF.symbols.ConfigurationServer]:{writable:!0,value:a.configurationServer}});const d=new Promise((a,d)=>{this[g]=a;this[h]=d}),e="hard"===this[SEF.symbols.ModuleType]?null:a=>{let d=`[${this[SEF.symbols.ModuleName]}] Not initialized: ${a}`;q.error(d);SEF.utils.OpState.Malfunctioned(d);this[SEF.symbols.ErrorInfo].error=a;return{[SEF.symbols.Self]:this,error:a}};Object.defineProperty(this,l,{value:d.then(a=>{if(a instanceof Error||void 0===a||null===a||!1===a)throw a instanceof Error?a:Error("[SEF.core.Module] "+
`<${this[SEF.symbols.ModuleName]}> Initialize returned '${a}'.`);return{[SEF.symbols.Self]:this,result:a}}).catch(e),writable:!1});const m=this.Initialize.bind(this);this.Initialize=()=>this[l];let n=()=>null,t=(...a)=>{t=()=>{throw Error(`Multiple init attempts on ${this[SEF.symbols.ModuleName]}`);};try{n=c.bind(this),this[g](m(...a))}catch(w){q.error(`[${this[SEF.symbols.ModuleName]}] Error: ${w}`),this[h](w)}finally{n=()=>null}return this[l]};this.weight=200;Object.defineProperties(this,{Grant:{value:b(this.Grant,
"Grant","ModuleBase"),writable:!1},Escalate:{value:b((...a)=>n.bind(this)(...a),"Escalate","ModuleBase"),writable:!1},[SEF.symbols.Initialize]:{value:(...a)=>t(...a),writable:!1}});Promise.resolve().then(()=>{})}catch(d){throw q.error(`Error while constructing ${a.name} ${d}`),d;}}Grant(){return!1}StartListening(){this[SEF.symbols.Listeners].forEach(a=>a.Listen())}StopListening(){this[SEF.symbols.Listeners].forEach(a=>a.Stop())}StartPolling(){this[SEF.symbols.Pollers].forEach(a=>a.Run())}StopPolling(){this[SEF.symbols.Pollers].forEach(a=>
a.Stop())}Initialize(){return{}}OnInitComplete(){return this[l]}DispatchEvent(a){super.DispatchEvent(a);a.cancelBubble||a.__cancelBubble||SEF.Propagate(a);return!a.defaultPrevented}ApplyConfigs(a,d=null){if(this.hasOwnProperty("config")){SEF.common.JWTVerify(a,this[SEF.symbols.ModulePublicKey]);a=a.payload;var b=a=>{if(!a.hasOwnProperty("filters"))return!0;const d={"no-apply":(a,d)=>d.includes(this.config.Get(a)),apply:(a,d)=>!d.includes(this.config.Get(a))};for(const b of Object.keys(a.filters))if(this.config.Has(b))for(const e of Object.keys(d))if(a.filters[b].hasOwnProperty(e)){const m=
a.filters[b][e];if(Array.isArray(m)&&d[e](b,m))return!1}return!0},e=(a,b)=>d?d.ForceSet(a,b):this.config.hasOwnProperty("IsLocked")&&this.config.IsLocked(a)?null:this.config.Set(a,b);Array.isArray(a)&&a.forEach(a=>{try{b(a)&&a.hasOwnProperty("key")&&Object.keys(a).forEach(b=>{switch(b.toLowerCase()){case "key":case "filters":break;case "value":e(a.key,a[b]);break;case "lock":d&&(!0===a[b]?d.Lock(a.key):d.Unlock(a.key));break;case "hide":d&&(!0===a[b]?d.Hide(a.key):d.Unhide(a.key));break;case "notify":d&&
d.NotifyOnChange(a.key,!0===a[b]);break;default:q.warn(`Unexpected property <${b}> while applying configs`)}})}catch(A){q.error(`Error while applying configs on ${this[SEF.symbols.ModuleName]} : ${A}`)}})}}}class t extends p{constructor(a){super(a);if(SEF.hasOwnProperty(a.name))throw Error(`Module name conflict: ${a.name}`);SEF[a.name]=this}IsModuleDisabled(){return!this.hasOwnProperty("config")||this.hasOwnProperty("config")&&this.config.Get("state")===SEF.constants.moduleStates.DISABLED}IsModuleSilent(){return this.hasOwnProperty("config")&&
this.config.Get("state")===SEF.constants.moduleStates.SILENT}SetModuleState(a){if(!this.hasOwnProperty("config"))return q.error(`There is no config for module ${this[SEF.symbols.ModuleName]}`),!1;this.config.Set("state",a);return!0}}class n extends p{constructor(a){super(a);if(SEF.utils.hasOwnProperty(a.name))throw Error(`Utility name conflict: ${a.name}`);SEF.utils[a.name]=this}}class m extends t{constructor(b){super(b);this.webRequest=new Proxy(SEF.context.browserObject.webRequest,new a(this));
this.webContent=new Proxy(SEF.eventing.webContent,new a(this));this.reputationResult=new Proxy(SEF.eventing.reputationResult,new a(this))}}SEF.core.ModuleBase=p;SEF.core.Module=t;SEF.core.Utility=n;SEF.core.Plugin=m})(this);(function(){(function(){function a(a){if(!a)throw new SEF.exceptions.ValidationError("Invalid init configs");const b=["productName","productVersion","partnerKey"];if(b.reduce((b,c)=>{a.hasOwnProperty(c)&&b++;return b},0)!==b.length)throw new SEF.exceptions.ValidationError("Missing init configs");}const {utils:b}=SEF,c=new b.Logger("EPILOGUE"),{ModuleBase:g}=SEF.core;let h=!1;SEF.Initialize=function(b){SEF.Initialize=()=>SEF._initFuture;a(b);Promise.all(Object.values(SEF).filter(a=>a instanceof g).reduce((a,
c)=>{a.push(c[SEF.symbols.Initialize](b));return a},[])).then(()=>{SEF.Enable();SEF._initFuture.resolve({[SEF.symbols.Self]:SEF});c.info("Module initialization complete.")}).catch(a=>{SEF._initFuture.reject(a);c.error(`Module initialization failed: ${a}`)});return SEF._initFuture.promise};SEF.Enable=()=>{h||(Object.values(SEF).filter(a=>a instanceof g).forEach(a=>{a[SEF.symbols.ErrorInfo].error||(a[SEF.symbols.Listeners].forEach(a=>{!1!==a.autoStart&&a.Listen()}),a[SEF.symbols.Pollers].filter(a=>
a.autoStart).forEach(a=>a.Run()))}),h=!0,SEF.DispatchEvent(new SEF.eventing.CustomEvent("onenabled")))};SEF.Disable=()=>{h&&(Object.values(SEF).filter(a=>a instanceof g).forEach(a=>{a.StopListening();a.StopPolling()}),h=!1,SEF.DispatchEvent(new SEF.eventing.CustomEvent("ondisabled")))};SEF.IsEnabled=()=>h})()})(this);(function(){(function(){const {utils:a}=SEF,b=new a.Logger("STORAGE"),c={browser:null,CreateFlatPromise:()=>{const a={};a.promise=new Promise((b,c)=>{a.resolve=b;a.reject=c});return a},Fulfill:(a,b)=>{const f=c.browser?c.browser.runtime.lastError:"StorageIO.browser not initlaized";f?a.reject(f):a.resolve(b)}};class g{constructor(a){if(!a)throw Error("Invalid storage object");Object.defineProperty(this,"browser",{value:SEF.context.BROWSER,writable:!1});Object.defineProperty(this,"storage",{value:a,
writable:!1});Object.defineProperty(this,"isChrome",{get(){return"Chrome"===this.browser}});Object.defineProperty(this,"isEdge",{get(){return"Edge"===this.browser}});Object.defineProperty(this,"isFirefox",{get(){return"Firefox"===this.browser}});try{if(this.isChrome||this.isEdge)this.storage.getBytesInUse(null,a=>{});else if(!this.isFirefox)throw Error(`Sorage::ManagedStorage Error: Browser '${this.browser}' is not supported.`);}catch(f){throw Error(`Exception while querying storage: ${f}`);}}SafeInvoke(a,
b=[]){try{if(this.isChrome||this.isEdge){const f=c.CreateFlatPromise();b.push((a=null)=>{c.Fulfill(f,a)});a.bind(this.storage)(...b);return f.promise}return a.bind(this.storage)(...b)}catch(q){throw q;}}get(a=null){return this.SafeInvoke(this.storage.get,[a])}}class h extends g{set(a){return this.SafeInvoke(this.storage.set,[a])}clear(){return this.SafeInvoke(this.storage.clear)}remove(a){return this.SafeInvoke(this.storage.remove,[a])}getBytesInUse(a){return this.isFirefox?Promise.reject(Error("getBytesInUse is not supported on Firefox")):
this.SafeInvoke(this.storage.getBytesInUse,[a])}}return new class extends SEF.core.Module{constructor(){super({name:"storage",version:"1.0.0"});c.browser=SEF.context.browserObject;"Edge"!==SEF.context.BROWSER&&(this.managed=new g(c.browser.storage.managed));this.local=new h(c.browser.storage.local);this.sync=new h(c.browser.storage.sync)}Initialize(a){try{return!1===a.storage?Error("storage disabled"):{}}catch(f){throw b.error(`Error while initializing storage: ${f}`),f;}}}})()})(this);(function(){(function(){const {utils:a,common:b}=SEF;new a.Logger("DB");class c{constructor(a){this._fp=new b.Future;this._db=a;this._fp.result=[]}Select(...a){let b={};0===a.length?b=null:1!==a.length||a[0].startsWith("/")?a.forEach(a=>{let [c,k,n]=[b,null,null];if(!a.startsWith("/"))throw Error(`Invalid path <${a}>. Must start with a "/"`);a=a.split("/");a.shift();for(n of a)c.hasOwnProperty(n)||(c[n]={}),k=c,c=c[n];k[n]=-1}):[b]=a;Object.defineProperty(this,"keyOrValue",{value:b,writable:!1});
Object.defineProperty(this,"mode",{value:"readonly",writable:!1});return this}Insert(a){Object.defineProperties(this,{keyOrValue:{value:a,writable:!1},mode:{value:"readwrite",writable:!1},isUpdate:{value:!1,writable:!1}});return this}Update(a){Object.defineProperties(this,{keyOrValue:{value:a,writable:!1},mode:{value:"readwrite",writable:!1},isUpdate:{value:!0,writable:!1}});return this}Clear(a){Object.defineProperties(this,{stores:{value:a,writable:!1},mode:{value:"delete",writable:!1},clear:{value:!0,
writable:!1}});return this}Delete(...a){0<a.length&&Object.defineProperty(this,"keyMatcher",{value:new Set(a),writable:!1});Object.defineProperty(this,"mode",{value:"delete",writable:!1});return this}As(a){Object.defineProperty(this,"keyName",{value:a,writable:!1});return this}From(a){Object.defineProperty(this,"stores",{value:a,writable:!1});return this}Into(a){Object.defineProperty(this,"stores",{value:a,writable:!1});return this}Where(a){Object.defineProperty(this,"index",{value:a,writable:!1});
return this}By(a){Object.defineProperty(this,"index",{value:a,writable:!1});Object.defineProperty(this,"keyRange",{value:null,writable:!1});return this}WherePrimaryKey(){Object.defineProperty(this,"index",{value:null,writable:!1});return this}Equals(a){Object.defineProperty(this,"keyRange",{value:IDBKeyRange.only(a),writable:!1});return this}Between(a,b,c,f){Object.defineProperty(this,"keyRange",{value:IDBKeyRange.bound(a,b,c,f),writable:!1});return this}Are(...a){Object.defineProperty(this,"keyMatcher",
{value:new Set(a),writable:!1});return this}LessThan(a,b){Object.defineProperty(this,"keyRange",{value:IDBKeyRange.upperBound(a,b),writable:!1});return this}GreaterThan(a,b){Object.defineProperty(this,"keyRange",{value:IDBKeyRange.lowerBound(a,b),writable:!1});return this}Matches(a){Object.defineProperty(this,"keyMatcher",{value:new RegExp(a),writable:!1});return this}Order(a){Object.defineProperty(this,"direction",{value:a,writable:!1});return this}Run(a=""){function b(a,c,m=[]){for(const e of Object.keys(c))"object"===
typeof c[e]?m=b(a?a[e]:void 0,c[e],m):m.push(a?a[e]:void 0);return m}function c(a,b){return!a||(a instanceof RegExp?a.test(b.key):a.has(b.key))}this.transactionId=`${this instanceof h?"S":"U"}`+`${(new Date).getTime()}.${Math.floor(1E4*Math.random())}${a?`-${a}`:""}`;if(!this.mode)throw Error(`[TrxId: ${this.transactionId}]: Invalid query: mode is undefined`);a=this.stores?Array.isArray(this.stores)?this.stores:[this.stores]:this._db.objectStoreNames;if(0===a.length)return this._fp.resolve(this._fp.result),
this._fp.promise;const f=this._db.transaction(a,"readonly"===this.mode?"readonly":"readwrite");f.oncomplete=()=>{this._fp.resolve(this._fp.result)};f.onabort=a=>{this._fp.reject(a)};f.onerror=a=>{this._fp.reject(a)};try{for(let k=0;k<a.length;k++){const n=f.objectStore(a[k]);if("readwrite"===this.mode)this.isUpdate?"function"==typeof this.keyOrValue&&this.keyName?n.get(this.keyName).onsuccess=a=>{n.put(this.keyOrValue(a.target.result),this.keyName)}:n.put(this.keyOrValue,this.keyName):n.add(this.keyOrValue,
this.keyName);else if("readonly"===this.mode){const a=this.direction||"next";this.keyOrValue&&"string"==typeof this.keyOrValue&&!this.keyOrValue.startsWith("/")?n.openCursor(this.keyOrValue,a).onsuccess=a=>{if(a=a.target.result)this._fp.result.push({key:a.primaryKey,value:a.value,store:a.source.name}),a.continue()}:(this.index?n.index(this.index):n).openCursor(this.keyRange,a).onsuccess=a=>{if(a=a.target.result)c(this.keyMatcher,a)&&this._fp.result.push({key:a.primaryKey,value:this.keyOrValue?b(a.value,
this.keyOrValue):a.value,store:a.source.objectStore?a.source.objectStore.name:a.source.name}),a.continue()}}else if("delete"===this.mode)this.clear?n.clear():(this.index?n.index(this.index):n).openCursor(this.keyRange).onsuccess=a=>{if(a=a.target.result)c(this.keyMatcher,a)&&a.delete(),a.continue()};else throw Error(`Invalid query mode: <${this.mode}>`);}}catch(t){this._fp.reject(`[TrxId ${this.transactionId}] Failed: ${t}`),f.abort()}return this._fp.promise}}class g extends c{constructor(a){super(null);
this.future=a}Run(...a){return this.future.then(b=>{this._db=b;return super.Run(...a)})}}class h extends c{constructor(a,b,c){super(a);Object.defineProperty(this,"__encrypt",{value:a=>{const k=forge.cipher.createCipher("AES-CBC",forge.util.decode64(KJUR.crypto.Cipher.decrypt(b[1].datakey,KEYUTIL.getKey(b[0],c),"RSAOAEP")));k.start({iv:forge.util.decode64(b[1].iv)});k.update(forge.util.createBuffer(a));if(!k.finish())throw Error("cipher failure");return forge.util.encode64(k.output.getBytes())},writable:!1});
Object.defineProperty(this,"__decrypt",{value:a=>{if(!a||"string"!==typeof a)return a;const k=forge.cipher.createDecipher("AES-CBC",forge.util.decode64(KJUR.crypto.Cipher.decrypt(b[1].datakey,KEYUTIL.getKey(b[0],c),"RSAOAEP")));k.start({iv:forge.util.decode64(b[1].iv)});k.update(forge.util.createBuffer(forge.util.decode64(a)));if(!k.finish())return a;a=k.output.getBytes();try{a=JSON.parse(a)}finally{return a}},writable:!1})}Select(...a){return super.Select(...a.map(a=>this.__encrypt(a)))}Insert(a){return super.Insert(this.__encrypt(JSON.stringify(a)))}Update(a){return super.Update(this.__encrypt(JSON.stringify(a)))}Delete(...a){return super.Delete(...a.map(a=>
this.__encrypt(a)))}As(a){return super.As(this.__encrypt("string"===typeof a?a:JSON.stringify(a)))}Where(){throw Error("Not supported");}Equals(){throw Error("Not supported");}Between(){throw Error("Not supported");}Are(...a){return super.Are(...a.map(a=>this.__encrypt(a)))}LessThan(){throw Error("Not supported");}GreaterThan(){throw Error("Not supported");}Matches(){throw Error("Not supported");}Order(){throw Error("Not supported");}Run(a){this.passcode="";return super.Run(a).then(a=>{"readonly"===
this.mode&&(a=a.map(a=>{a.key=this.__decrypt(a.key);a.value=this.__decrypt(a.value);return a}));return a})}}class l{constructor(a){if(!window.indexedDB)throw Error("IndexedDB not supported");if(!a||"string"!==typeof a)throw Error("Must specify a database name");this.name=a;this.database=null}Open(a={},...c){if(this.database)throw Error("Cannot reopen an active database connection");const k=new b.Future,f=a.version?window.indexedDB.open(this.name,a.version):window.indexedDB.open(this.name);f.onsuccess=
a=>{this.database=a.target.result;this.database.onversionchange=a=>{this.Close();this.Open({},...c)};k.resolve(this)};f.onerror=a=>{k.reject(a.target.error)};f.onupgradeneeded=b=>{const c=b.target.result,{objectStoreNames:m}=c,e={create:a=>{if(a.hasOwnProperty("name")&&!m.contains(a.name)){var d=c.createObjectStore(a.name,a.options);a.hasOwnProperty("indices")&&a.indices.hasOwnProperty("create")&&Array.isArray(a.indices.create)&&a.indices.create.forEach(a=>{d.createIndex(a.name,a.keyPath,a.params)})}},
delete:a=>{m.contains(a)&&c.deleteObjectStore(a)},modify:a=>{const b={create:(a,b)=>{a.createIndex(b.name,b.keyPath,b.params)},delete:(a,b)=>{a.deleteIndex(b)}};a.hasOwnProperty("name")&&m.contains(a.name)&&a.hasOwnProperty("indices")&&["create","delete"].forEach(d=>{if(Array.isArray(a.indices[d])){const e=f.transaction.objectStore(a.name);a.indices[d].forEach(a=>{b[d](e,a)})}})}};["delete","create","modify"].forEach(b=>{Array.isArray(a[b])&&a[b].forEach(a=>e[b](a))})};return k.promise}Close(){this.database&&
(this.database.close(),this.database=null)}Upgrade(a){if(!this.database)throw Error("Database not ready");if(!a||!a.version||this.Version()>=a.version)throw Error(`Schema is invalid or the DB is already at higher version (v${this.Version()})`);this.Close();return this._wait=this.Open(a)}Query(){if(!this.database)throw Error("Database not ready");return new c(this.database)}Delete(){if(!this.database)throw Error("Database not ready");return window.indexedDB.deleteDatabase(this.database.name)}Version(){if(!this.database)throw Error("Database not ready");
return this.database.version}static Query(a){return a instanceof Promise?new g(a):new c(a)}}class f extends l{constructor(a){if(new.target!==f)throw Error("Cannot extend SecureDB");super(a);Object.defineProperty(this,"isSecure",{value:!0,writable:!1})}Open(a={},b,c="default"){const k=()=>{if(!b)throw new SEF.exceptions.DatabaseNotSeededException(this.name);return super.Query().Insert(this._keys=Object.values(KEYUTIL.generateKeypair("RSA",1024)).map(a=>a.isPrivate?KEYUTIL.getPEM(a,"PKCS8PRV",b):{datakey:KJUR.crypto.Cipher.encrypt(forge.util.encode64(forge.random.getBytesSync(32)),
a,"RSAOAEP"),iv:forge.util.encode64(forge.random.getBytesSync(16))})).Into(f.keyStore).As(c).Run("SEED").finally(()=>{const a=[];for(let b=0;b<this.database.objectStoreNames.length;b++)this.database.objectStoreNames[b]!==f.keyStore&&a.push(this.database.objectStoreNames[b]);return super.Query().Clear(a).Run("SCLR")})};a.hasOwnProperty("create")&&Array.isArray(a.create)||(a.create=[]);a.create.push({name:f.keyStore,options:{autoIncrement:!0}});return super.Open(a).then(a=>super.Query().Select(c).From(f.keyStore).Run("SDEF").then(b=>
{b&&void 0!==b[0]&&(this._keys=b[0].value);return this._keys?a:k().then(()=>a)}))}ChangePasscode(a,b,c="default"){if(!this.database)throw Error("Database not ready");return super.Query().Update(c=>{c[0]=KEYUTIL.getPEM(KEYUTIL.getKey(c[0],a),"PKCS8PRV",b);return this._keys=c}).Into(f.keyStore).As(c).Run()}Query(a){if(!this.database)throw Error("Database not ready");return new h(this.database,this._keys,a)}}f.keyStore="__keystore";return new class extends SEF.core.Module{constructor(){super({name:"db",
version:"1.0"});this.DB=l;this.SecureDB=f}Initialize(){if(!window.indexedDB)throw Error(`[${this[SEF.symbols.ModuleName]}]: IndexedDB is not supported on this implementation.`);return{}}}})()})(this);(function(){(function(){const {utils:a,db:b,storage:c}=SEF,g=new a.Logger("CACHE"),h=new WeakMap;SEF.utils.Logger.DisableModules("CACHE");class l{constructor(a,n,m=null){if(!l.instance){var e=function(){l.prototype.Get=(a,b,d)=>k.bind(v(b,d))(a);l.prototype.Has=(a,b,c)=>d.bind(v(b,c))(a);l.prototype.Set=(a,b,d,c)=>r.bind(v(d,c))(a,b);l.prototype.Remove=(a,b,d)=>h.bind(v(b,d))(a);l.prototype.Clear=(a,b)=>f.bind(v(a,b))();l.prototype.SetVolatile=(a,b,d,c)=>r.bind(v(d,c))(a,b,!0);l.prototype.Flush=function(a){return t.bind(v())(a)};
l.prototype.Stage=function(a,b){try{return this.staged[a]=w(b,2),r.bind(v())(a,b,!0)}catch(F){return{cache:!1,error:F}}}},d=function(a){return q.bind(this)(this.map.has,[a])},k=function(a){function b(a){a.return&&a.return.hasOwnProperty("_0")&&(a.return=a.return._0);return a}a=q.bind(this)(this.map.get,[a]);return a instanceof Promise?a.then(a=>b(a)):b(a)},t=function(a=""){if(!this.storage)return{return:0,storage:Promise.reject(Error("storage undefined"))};const b={storage:Promise.resolve(null)},
d={};for(const b of Object.keys(this.staged).filter(b=>b.startsWith(a)))d[b]=this.staged[b],delete this.staged[b];b.return=Object.keys(d).length;0<b.return&&(b.storage=this.storage.set(d).then(()=>{Object.keys(d).forEach(a=>{y(this.map.get(a),2)})}));return b},f=function(){const a=q.bind(this)(this.map.clear);this.staged={};a.storage=this.storage?p.bind(this)(this.storage.clear):Promise.reject(Error("storage undefined"));return a},h=function(a){const b=this.map.get(a),d=this.map.has(a)&&G(b,2),c=
q.bind(this)(this.map.delete,[a]);c.storage=G(b,1)?Promise.resolve("Volatile"):this.storage?p.bind(this)(this.storage.remove,[a]):Promise.reject(Error("storage undefined"));this.staged.hasOwnProperty(a)&&(delete this.staged[a],c.staged=!0);c.return=d;return c},r=function(a,b,d=!1,c={}){var e=this.map.has(a),m=(e?this.map.get(a)._f:0)|(d?0:8);b=w(b,m);d?y(b,1):C(b,1);c.set&&y(b,c.set);c.unset&&C(b,c.unset);e=!e||2!==(m&2);c=!d&&e;d&&e||y(b,2);({size:e}=this.map);m=q.bind(this)(this.map.set,[a,b]);
C(b,8);m.return=d?1===this.map.size-e?!0:!1:c;m.storage=d?Promise.resolve(null):this.storage?p.bind(this)(this.storage.set,[{[a]:b}]):Promise.reject(Error("storage undefined"));m.storage.then(()=>{this.map.has(a)&&C(this.map.get(a),8)}).catch(b=>{this.map.has(a)&&y(this.map.get(a),4)});return m},w=function(a,b=0){return{_0:a,_f:0|b,_t:(new Date).getTime()}},p=function(b,d=[]){try{if(!this.storage)throw Error("storage is undefined");const c=b.bind(this.storage)(...d);c.then(()=>{}).catch(c=>{const e=
`Store failure: ${b.name}(${JSON.stringify(d)}). (${c.message})`;a.push(e);z.bind(this)(c)});return c}catch(F){return z.bind(this)(F),Promise.reject(F)}},q=function(a,b=[]){const d={cache:!0};try{d.return=a.bind(this.map)(...b)}catch(J){d.cache=!1,d.error=J}return d},G=function(a,b){return a?(a._f&b)===b:!1},C=function(a,b){"object"==typeof a&&(a._f&=~b)},y=function(a,b){"object"==typeof a&&(a._f|=b)},z=function(a){setTimeout(a=>{try{for(const b of this.onError.entries())b[0](a)}catch(F){g.error(`notifyError handler error: ${F}`)}},
0,a)};const a=[];this.onSuccess=new Set;this.onError=new Set;this.staged={};this.quotaExceeded=!1;Object.defineProperty(this,"syncErrors",{get(){return a},set(){return null}});const D={set(a){return Promise.all(Object.entries(a).reduce((a,b)=>{a.push(this.database.Query(this.getPasscode()).Update(b[1]).Into(this.store).As(b[0]).Run("CI"));return a},[]))},remove(a){return Array.isArray(a)?this.database.Query(this.getPasscode()).Delete(...a).From(this.store).Run("CI"):this.database.Query(this.getPasscode()).Delete(a).From(this.store).Run("CI")},
clear(){return this.database.Query(this.getPasscode()).Clear(this.store).Run("CI")},bind(a,b,d){if(a)return D.database=a,D.store=b,D.getPasscode=()=>{D.getPasscode=()=>null;return d},D}},v=(a,b)=>{const d=this.dbmaps[b?"sefsm.sdb":"sefsm.db"][a];b&&d.setPasscode(b);return a?{map:d,storage:D.bind(b?this.securedb:this.db,a,b),staged:{}}:this};l.prototype.GetCacheMapByContext=function(a,b,d){return"db"===a?this.dbmaps?this.dbmaps[d?"sefsm.sdb":"sefsm.db"][b]:void 0:this.map};this._initFutureUpg=this._initFutureRoot=
this._initFuture=Promise.all([c.OnInitComplete(),b.OnInitComplete()]).then(([a,b])=>{if(a[SEF.symbols.Self]||b[SEF.symbols.Self])a[SEF.symbols.Self]?b[SEF.symbols.Self]||g.warn("IndexedDB init has failed. All IDB backed stores will fallback to "+`'volatile storage only'. error: ${a.error}`):g.warn("Storage init has failed. All storage backed stores will fallback to "+`'volatile storage only'. error: ${a.error}`);else throw Error(`Null Storage: storeErr: [${a.error}], DBErr: [${b.error}]`);var d=[];
a[SEF.symbols.Self]&&(this.storage=l.syncStore?a[SEF.symbols.Self].sync:a[SEF.symbols.Self].local,d.push(this.storage.get().then(a=>{this.map=new Map(this._process(a));r.bind(this)("__SyncManagerInit0__",(new Date).getTime());h.bind(this)("__SyncManagerInit0__");return{storage:!0}}).catch(a=>({storage:!1}))));if(b[SEF.symbols.Self]){this.db=new b[SEF.symbols.Self].DB("sefsm.db");this.securedb=new b[SEF.symbols.Self].SecureDB("sefsm.sdb");const c={["sefsm.db"]:{},["sefsm.sdb"]:{}};a=[this.db,this.securedb].reduce((a,
b)=>{a.push(b.Open({},m,n).then(a=>a.Query().Select().Where("_t").Run("DB").then(a=>a).catch(b=>{g.error(`Query by index failed: ${b}. Attempting non indexed query`);return a.Query().Select().Run("DB2")}).then(b=>{for(const b of a.database.objectStoreNames)c[a.name][b]=a.isSecure?new SecureDBMapFacade(a,b):new Map;b.forEach(b=>{c[a.name][b.store].set(b.key,b.value)});return{[a.name]:!0}})).catch(a=>({[b.name]:!1})));return a},[]);Promise.all(a).finally(()=>{this.dbmaps=c});d=d.concat(a)}d=Promise.all(d).then(a=>
{e.bind(this)();return a.reduce((a,b)=>Object.assign(a,b),{self:this})});d.catch(a=>{g.error(`Storage fulfillments failed: ${a}`)});return d}).catch(a=>{g.error(`Backing store failure (${a}). Falling back to 'volatile storage only' mode.`);e.bind(this)();return{self:this,error:a}}).finally(()=>{this.map=this.map||new Map;this.dbmaps=this.dbmaps||{["sefsm.db"]:{},["sefsm.sdb"]:{}}});l.prototype.Get=function(a,b,d){return this._initFuture.then(()=>k.bind(v(b,d))(a))};l.prototype.Has=function(a,b,c){return this._initFuture.then(()=>
d.bind(v(b,c))(a))};l.prototype.Set=function(a,b,d,c){return this._initFuture.then(()=>r.bind(v(d,c))(a,b))};l.prototype.SetVolatile=function(a,b,d,c){return this._initFuture.then(()=>r.bind(v(d,c))(a,b,!0))};l.prototype.Remove=function(a,b,d){return this._initFuture.then(()=>h.bind(v(b,d))(a))};l.prototype.Clear=function(a,b){return this._initFuture.then(()=>f.bind(v(a,b))())};l.prototype.Flush=function(a){return this._initFuture.then(()=>t.bind(v())(a))};l.prototype.Stage=function(a,b){const d=
this._initFuture.then(()=>r.bind(v())(a,b,!0));this.staged[a]=w(b,2);return d};Object.defineProperty(l,"instance",{value:this,writable:!1});Object.defineProperty(l.instance,"storeCreationRequestQueue",{value:[],writable:!1})}if("db"===a){const a=(a,b)=>{const d=b?"sefsm.sdb":"sefsm.db",{instance:c}=l;let e=c._initFutureRoot;c.dbmaps[d].hasOwnProperty(a)||(c.dbmaps[d][a]=b?new SecureDBMapFacade:new Map,c.storeCreationRequestQueue.push({isSecure:b,name:a}),e=c._initFutureRoot.then(a=>{if(0<c.storeCreationRequestQueue.length){const [b,
d]=[{create:[]},{create:[]}];c.storeCreationRequestQueue.forEach(a=>{(a.isSecure?d:b).create.push({name:a.name,indices:{create:[{name:"_t",keyPath:"_t"},{name:"_f",keyPath:"_f"}]}})});c.storeCreationRequestQueue.length=0;c._initFutureUpg=Promise.all([{schema:b,db:c.db},{schema:d,db:c.securedb}].reduce((a,b)=>{0<b.schema.create.length&&b.db&&(b.schema.version=b.db.Version()+1,a.push(b.db.Upgrade(b.schema)));return a},[])).then(()=>a)}return c._initFutureUpg}));return e};l.instance._initFuture=l.instance.dbmaps?
a(n,null!==m):l.instance._initFutureRoot.then(()=>a(n,null!==m))}return l.instance}OnInitComplete(){return this._initFuture}SyncErrors(){return this.syncErrors}AddStorageNotifiers(a,b){"function"===typeof a&&this.onSuccess.add(a);"function"===typeof b&&this.onError.add(b)}RemoveStorageNotifiers(a,b){a&&this.onSuccess.delete(a);b&&this.onError.delete(b)}_process(a){return Object.keys(a).sort((b,c)=>a[b].hasOwnProperty("_t")&&a[c].hasOwnProperty("_t")?a[b]._t-a[c]._t:-1).map(b=>[b,a[b]])}}l.syncStore=
!1;class f extends l{constructor(a,b,c,e=null){if(!a||!c||!b)throw Error("Invalid params to NamespacedSyncManager constructor");super(b,c,e);if(!f._initFuture){f.properties={};const b=super.OnInitComplete().then(()=>{var b=this.map.keys();for(let d of b){const [c,e,m,n]=d.split(".",4);c===a&&e&&m&&n&&({properties:b}=f,b.hasOwnProperty(e)||(b[e]={}),b[e].hasOwnProperty(m)||(b[e][m]={size:0,staged:0,__size:0}),b[e][m].size++,b[e][m].__size++)}return{self:this}});f.Clear=()=>{const a=super.Clear();Object.keys(f.properties).forEach(a=>
{Object.keys(f.properties[a]).forEach(b=>{f.properties[a][b].size=0;f.properties[a][b].__size=0;f.properties[a][b].staged=0})});return a};f.Flush=()=>{function a(a){const {properties:b}=f;if(a.return&&0<a.return)for(const a of Object.keys(b))for(const d of Object.keys(b[a]))0<b[a][d].staged&&(b[a][d].size+=b[a][d].staged,b[a][d].staged=0)}const b=super.Flush();b instanceof Promise?b.then(b=>{a(b)}):a(b);return b};Object.defineProperty(f,"_initFuture",{value:b,writable:!1})}f.properties.hasOwnProperty(b)||
(f.properties[b]={});f.properties[b].hasOwnProperty(c)||(f.properties[b][c]={size:0,staged:0,__size:0});const d=Object.create(this);d.isIDBBacked="db"===b;d.prefix=d.isIDBBacked?"":`${a}.${b}.${c}.`;d.dbStoreName=d.isIDBBacked?c:null;d.basename=a;d.storetype=b;d.storename=c;h.set(d,e);super.OnInitComplete().then(()=>{d.cacheMap=this.GetCacheMapByContext(d.storetype,d.storename,h.get(d));d.cacheMapIterator=d.cacheMap.entries();Object.defineProperty(d,"NextByInsertionOrder",{value(){let a;if(0<this.Size())for(let b=
0;b<this.cacheMap.size;b++)if((a=this.cacheMapIterator.next()).done&&(a=(this.cacheMapIterator=this.cacheMap.entries()).next()),a.value&&a.value[0].startsWith(this.prefix))return a.value[0].replace(this.prefix,"");return null}});Object.defineProperty(d,"BuildOrderedList",{value(a){return 0<this.Size()?[...this.cacheMap.entries()].filter(a=>a[0].startsWith(this.prefix)).sort((b,d)=>a([b[0].replace(this.prefix,""),b[1]._0._1],[d[0].replace(this.prefix,""),d[1]._0._1])).map(a=>a[0].replace(this.prefix,
"")):[]}})});return d}*Keys(){const a=this.GetCacheMapByContext(this.storetype,this.storename,h.get(this)).entries();let b;for(;!(b=a.next()).done;)b.value&&b.value[0].startsWith(this.prefix)&&(yield b.value[0])}GetCurrentStore(){return f.properties[this.storetype][this.storename]}Has(a){return super.Has(this.prefix+a,this.dbStoreName,h.get(this))}Get(a){function b(a){a.return&&a.return.hasOwnProperty("_1")&&(a.return=a.return._1);return a}a=super.Get(this.prefix+a,this.dbStoreName,h.get(this));return a instanceof
Promise?a.then(a=>b(a)):b(a)}SetVolatile(a,b){b={_1:b};return super.SetVolatile(this.prefix+a,b,this.dbStoreName,h.get(this))}Flush(){function a(a){a.storage.catch(()=>null);const b=this.GetCurrentStore();a.return&&0<a.return&&(a.storage.then(()=>{b.__size+=a.return}).catch(()=>null),b.size+=b.staged,b.staged=0)}if(this.isIDBBacked)throw Error("Not supported on IDB backed stores");const b=super.Flush(this.prefix);b instanceof Promise?b.then(b=>{a.bind(this)(b)}):a.bind(this)(b);return b}Set(a,b){function c(a){const b=
this.GetCurrentStore();a.storage.catch(()=>null);!0===a.cache&&!0===a.return&&(b.size++,a.storage.then(()=>{b.__size++}).catch(()=>null))}b={_1:b};a=super.Set(this.prefix+a,b,this.dbStoreName,h.get(this));this.isIDBBacked||(a instanceof Promise?a.then(a=>{c.bind(this)(a)}):c.bind(this)(a));return a}Stage(a,b){function c(a){a.storage.then(()=>null);!0===a.cache&&!0===a.return&&e[this.storetype][this.storename].staged++}if(this.isIDBBacked)throw Error("Not supported on IDB backed stores");const {properties:e}=
f;b={_1:b};a=super.Stage(this.prefix+a,b);a instanceof Promise?a.then(a=>{c.bind(this)(a)}):c.bind(this)(a);return a}Remove(a){function b(a){const b=this.GetCurrentStore();a.storage.catch(()=>null);!0===a.cache&&(!0===a.return&&(b.size--,a.storage.then(()=>{b.__size--})),!0===a.staged&&b.staged--)}a=super.Remove(this.prefix+a,this.dbStoreName,h.get(this));this.isIDBBacked||(a instanceof Promise?a.then(a=>{b.bind(this)(a)}):b.bind(this)(a));return a}Clear(){if(!this.cacheMap)return!1;if(this.isIDBBacked)super.Clear(this.dbStoreName,
h.get(this));else{const a=this.GetCurrentStore();for(const b of this.cacheMap.keys()){if(!b.startsWith(this.prefix))continue;const c=super.Remove(b);!0===c.cache&&(!0===c.return&&(a.size--,c.storage.then(()=>{a.__size--})),!0===c.staged&&a.staged--);c.storage.catch(()=>null)}}return!0}Size(){const {properties:a}=f;return!this.isIDBBacked&&a.hasOwnProperty(this.storetype)&&a[this.storetype].hasOwnProperty(this.storename)?a[this.storetype][this.storename].size:this.cacheMap?this.cacheMap.size:null}static OnInitComplete(){return f._initFuture}OnInitComplete(){return Promise.all([f.OnInitComplete(),
super.OnInitComplete()])}}class q{constructor(a,b,c=!0){if("function"!==typeof b)throw Error("comparator must be callable");this.rebuildOnWrap=c;Object.defineProperty(this,"name",{value:a,writable:!1});Object.defineProperty(this,"comparator",{value:b,writable:!1})}rebuild(){this.__iterable=this.store.BuildOrderedList(this.comparator);return this.__iterator=this.__iterable[Symbol.iterator]()}bind(a){if(!(a instanceof f))throw Error("Must be a NamespacedSyncManager object to bind");this.close();this.store=
a;return this}next(){let a;this.__iterator||this.rebuild();a=this.__iterator.next();a.done&&(a=(this.rebuildOnWrap?this.rebuild():this.__iterator=this.__iterable[Symbol.iterator]()).next());return a.value}close(){this.store=this.__iterable=this.__iterator=null}}class k{constructor(a){Object.defineProperty(this,"Create",{value:a,writable:!1})}}class r{constructor(a,b,c="cache",e=null){this.store=new f("SEFWeb",c,a,e);this.storeName=a;this.storeType=c;this.maxEntries=b;let d=null;Object.defineProperty(this,
"policy",{get(){return d},set(a){if(null!==a&&!(a instanceof k))throw Error(`Invalid policy <${typeof a}>`);d&&d.close();d=a?a.Create(this.store):null}});this._initFuture=f.OnInitComplete().then(()=>({self:this}))}__NotifyPolicy(a,...b){if(this.policy&&this.policy.onActivity)try{this.policy.onActivity(a,...b)}catch(m){}}OnInitComplete(){return Promise.all([this._initFuture,this.store.OnInitComplete()]).then(()=>({self:this}))}Keys(){return this.store.Keys()}Size(){return this.store.Size()}Insert(a,
b,c=null){function e(){try{const a=this.policy.next();return void 0===a||!1===r.prototype.Remove.bind(this)(a)?!1:!0}catch(d){return!1}}if(!this.store.Has(a).return){const a=r.prototype.Size.bind(this)();if(this.maxEntries&&a===this.maxEntries&&this.policy){if(!e.bind(this)())return!1}else if(this.store.quotaExceeded){if(!this.policy)return!1;e.bind(this)()}else if(this.maxEntries&&a>=this.maxEntries)return!1}b=this.store.Set(a,{_v:b,_x:c?(new Date).getTime()+1E3*c:null});r.prototype.__NotifyPolicy.bind(this)("insert",
a,null);return b instanceof Promise?b:b.cache}InsertVolatile(a,b,c=null){a=this.store.SetVolatile(a,{_v:b,_x:c?(new Date).getTime()+1E3*c:null});return a instanceof Promise?a:a.cache}Remove(a){const b=this.store.Remove(a);r.prototype.__NotifyPolicy.bind(this)("remove",a);return b instanceof Promise?null:b.cache?b.return:!1}Get(a){a=r.prototype.GetEx.bind(this)(a);return a instanceof Promise?null:a}GetEx(a){function b(b){return!0===b.cache&&b.return?b.return._x&&b.return._x<(new Date).getTime()?(r.prototype.Remove.bind(this)(a),
null):b.return._v:null}const c=this.store.Get(a);r.prototype.__NotifyPolicy.bind(this)("get",a);return c instanceof Promise?c.then(a=>b.bind(this)(a)):b.bind(this)(c)}Clear(){r.prototype.__NotifyPolicy.bind(this)("clear");return this.store.Clear()}Has(a){return null===r.prototype.Get.bind(this)(a)?!1:!0}}const p={None:new k(()=>null),FIFO:new k(a=>{const b=new q("FIFO",()=>null);b.next=function(){return this.store.NextByInsertionOrder()};return a?b.bind(a):b}),ImminentExpiry:new k(a=>{const b=new q("OIE",
(a,b)=>a[1].hasOwnProperty("_x")&&b[1].hasOwnProperty("_x")?a[1]._x-b[1]._x:-1);return a?b.bind(a):b}),LeastRecentlyUsed:new k(a=>{let b=new q("LRU",()=>0);b.rebuild=function(){this.__iterable=new Set(this.store.BuildOrderedList(this.comparator))};b.next=function(){this.__iterable||this.rebuild();return this.__iterable.values().next().value};b.onActivity=function(a,...b){if(this.__iterable)switch(a){case "get":case "insert":this.__iterable.delete(b[0]);this.__iterable.add(b[0]);break;case "remove":this.__iterable.delete(b[0]);
break;case "clear":this.__iterable=null}};a&&(b=b.bind(a),b.rebuild());return b}),LeastFrequentlyUsed:new k(()=>null)};r.Policy=Object.freeze(p);return new class extends SEF.core.Module{constructor(){super({name:"cache",version:"1.0"});this.Cache=r;this.NamespacedSyncManager=f;this.SyncManager=l}}})()})(this);(function(){(function(){const {exceptions:a,utils:b,constants:c,common:g}=SEF,{isNil:h,isntNil:l,Contract:f}=g,q=new b.Logger("CONFIG"),k=new WeakMap,r=new WeakMap,p=new WeakMap,{StopIteration:t}=a,n=new Map([["SEF",new SEF.cache.Cache("Config.SEF",null,"db")]]);class m{constructor(a,b=null,d,c={},e="SEF"){if(h(a))throw Error("Cannot create a PropertyValue with null value");if(d&&!Array.isArray(d))throw Error(`Invalid accessor type <${typeof accessor}>. Must be an array`);let m=a;a=typeof m;this._accessors=
d?d:[];this._locked=c.hasOwnProperty("locked")?c.locked:!1;this._hidden=c.hasOwnProperty("hidden")?c.hidden:!1;this._notify=c.hasOwnProperty("notify")?c.notify:!0;Object.defineProperty(this,"label",{value:b,writable:!1});Object.defineProperty(this,"type",{value:a,writable:!1});Object.defineProperty(this,"parent",{value:e,writable:!1});Object.defineProperty(this,"value",{get(){let a=m;try{return this._accessors.forEach(d=>{a=d.get.bind(this)(a,b)}),l(a)?a:m}catch(z){return z instanceof t?l(z.value)?
z.value:m:m}},set(a){if(this._locked)throw Error(`Cannot modify a locked PropertyValue <${this.label}>`);let d=a;try{this._accessors.forEach(a=>{d=a.set.bind(this)(d,b)}),l(d)&&(m=d)}catch(E){E instanceof t&&l(E.value)&&(m=E.value)}}})}AddAccessor(a,b,d=[]){return this._accessors&&m.Accessors.hasOwnProperty(a)?(a=m.Accessors[a],this._accessors.splice(b,0,"function"==typeof a?a(...d):a),!0):!1}DropAccessor(a){if(this._accessors){const b=this._accessors.findIndex(b=>b.__id__===a);if(0<=b)return this._accessors.splice(b,
1),!0}return!1}Lock(){return this._locked=!0}Unlock(){this._locked=!1;return!this._locked}Hide(){return this._hidden=!0}Unhide(){this._hidden=!1;return!this._hidden}SetNotify(a){this._notify="boolean"==typeof a&&!0===a?!0:!1;return this._notify===a}static CreateAccessor(a,b=null,d={get(){return null},set(){return null}}){Object.defineProperty(m.Accessors,a,{value:"function"==typeof b?(...c)=>Object.assign(Object.create(d),b(...c),{__id__:a}):Object.assign(Object.create(d),b,{__id__:a}),enumerable:!0});
return a}}m.Accessors={};m.CreateAccessor("persist",{get(a,b){return n.get(this.parent).Get(b).value},set(a,b){n.get(this.parent).Insert(b,{value:a,lock:this._locked,hide:this._hide,notify:this._notify});return a}});m.CreateAccessor("asyncAndPersistent",{get(a,b){b=n.get(this.parent).GetEx(b);return b instanceof Promise?b.then(b=>b&&null!==b.value?b.value:a):b.value}},m.Accessors.persist);m.CreateAccessor("validate",a=>({get(a){return a},set(b){if(!Object.values(a).includes(b))throw new t(null);return b},
args(){return a}}));m.CreateAccessor("firefox",{get(a){return"Firefox"===SEF.context.BROWSER?a:!1},set(a){return a}});m.CreateAccessor("bounded",(a,b)=>({get(a){return a},set(d){if(d<a||d>b)throw t(null);return d},args(){return[a,b]}}));var e=class extends g.JSScope{OverrideLock(){(this.isLockedSetting=this.args[0]._locked)&&this.args[0].Unlock()}["~OverrideLock"](){this.isLockedSetting&&this.args[0].Lock()}};const d=a=>class extends g.MakePrototype(a){constructor(a,...b){super(...b);p.has(a)||p.set(a,
new Set);Object.defineProperty(this,"module",{value:a,writable:!1});Object.defineProperty(this,"listeners",{get(){return p.get(a)},set(){return null}})}Get(a){if(k.get(this.module).hasOwnProperty(a))return k.get(this.module)[a].value;q.error(`[SEF.Web Error]: Config::Get: Cannot 'Get' non existing property: ${a}`);return null}Set(a,b){if(k.get(this.module).hasOwnProperty(a)){if(typeof b===k.get(this.module)[a].type){if("number"==typeof b&&isNaN(b))return q.error("[SEF.Web Error]: Config::Set: Cannot set property to NaN"),
!1;const d=k.get(this.module)[a].value;k.get(this.module)[a].value=b;this.listeners.forEach(c=>{setTimeout((b,d)=>{const e=this.Set;try{this.Set=()=>{throw Error("Action is prohibited in this context");},c(a,b,d)}finally{this.Set=e}},0,d,b)});return!0}q.error(`[SEF.Web Error]: config::Set: Unexpected type <${typeof b}> for property `+`'${a}' of type <${typeof k.get(this.module)[a].value}>`)}else q.error(`[SEF.Web Error]: config::Set: Property does not exist: ${a}`);return!1}Keys(){return Object.keys(k.get(this.module)).filter(a=>
!1===k.get(this.module)[a]._hidden)}Has(a){return k.get(this.module).hasOwnProperty(a)}IsLocked(a){return k.get(this.module).hasOwnProperty(a)?k.get(this.module)[a]._locked:null}IsHidden(a){return k.get(this.module).hasOwnProperty(a)?k.get(this.module)[a]._hidden:null}IsNotifying(a){return k.get(this.module).hasOwnProperty(a)?k.get(this.module)[a]._notify:null}AddListener(a){return"function"==typeof a?(this.listeners.add(a),!0):!1}RemoveListener(a){return this.listeners.delete(a)}HasListener(a){return this.listeners.has(a)}Reset(){n.get(this.module[SEF.symbols.ModuleName]).Clear()}},
B=d();class x extends B{AddAccessor(a,b,d,c=[]){return k.get(this.module).hasOwnProperty(a)?k.get(this.module)[a].AddAccessor(b,d,c):!1}DropAccessor(a,b){return k.get(this.module).hasOwnProperty(a)?k.get(this.module)[a].DropAccessor(b):!1}Lock(a){return k.get(this.module).hasOwnProperty(a)?k.get(this.module)[a].Lock():null}Unlock(a){return k.get(this.module).hasOwnProperty(a)?k.get(this.module)[a].Unlock():null}Hide(a){return k.get(this.module).hasOwnProperty(a)?k.get(this.module)[a].Hide():null}Unhide(a){return k.get(this.module).hasOwnProperty(a)?
k.get(this.module)[a].Unhide():null}NotifyOnChange(a,b){return k.get(this.module).hasOwnProperty(a)?k.get(this.module)[a].SetNotify(b):null}GetPropertyInfo(a){return(a=k.get(this.module)[a])?{accessors:a._accessors.map(a=>({id:a.__id__,args:a.hasOwnProperty("args")?a.args():void 0})),locked:a._locked,hidden:a._hidden,notify:a._notify,type:a._type}:null}ForceSet(a,b){if(!k.get(this.module).hasOwnProperty(a))return!1;let d=null;new e(()=>{d=this.Set(a,b)},k.get(this.module)[a]);return d}}var u=m.Accessors;
u={allowTelemetry:new m(!0,"allowTelemetry",[u.persist]),returnSafeLandingPage:new m(!0,"returnSafeLandingPage",[u.persist]),actionConsolidation:new m(!0,"actionConsolidation",[u.persist]),productName:new m("None",null),productVersion:new m("0.0.0.0",null),machineID:new m("00000000-0000-0000-0000-000000000000",null),sourceID:new m("",null),partnerKey:new m("",null),watchdogFrequency:new m(c.POLL_FREQUENCY.MAX,"watchdogFrequency",[u.bounded(c.POLL_FREQUENCY.MIN-1,c.POLL_FREQUENCY.MAX),u.persist]),
actionProfile:new m(c.actionProfiles.SECURE,"actionProfile",[u.validate(c.actionProfiles),u.persist]),networkUsage:new m(c.networkUsage.UNLIMITED,"networkUsage",[u.validate(c.networkUsage),u.persist]),nativeConnectRetry:new m(c.NATIVE_MESSAGING_APP_CONNECT_RETRY_DEFAULT,"nativeConnectRetry",[u.persist]),nativeMessasingAppId:new m(c.NATIVE_MESSAGING_APP_ID,"nativeMessasingAppId",[u.persist]),pulseFrequency:new m(c.PULSE_FREQUENCY,"pulseFrequency",[u.persist]),syncFrequency:new m(c.SYNC_FREQUENCY,"syncFrequency",
[u.persist]),httpHeaderNameSourceId:new m(c.HTTP_HEADER_NAME_SOURCE_ID,"httpHeaderNameSourceId",[u.persist]),...!1};const A={[SEF.symbols.ModuleName]:"SEF"};k.set(A,u);r.set(SEF,new x(A));return new (class extends d(SEF.core.Module){constructor(a,...b){super(a,...b);this.Accessors=m.Accessors}CreateAccessor(a,...b){m.CreateAccessor(a,...b);return this.Accessors[a]}Initialize(a={}){return Object.keys(a).every(b=>this.Has(b)?this.Set(b,a[b]):!0)?{}:Error("Invalid configurations")}Grant(a){return"config"===
this[SEF.symbols.ModuleName]&&a[SEF.symbols.ModuleId]===SEF.policyOrchestrator[SEF.symbols.ModuleId]}Add(a,b,d){if(!d||!Array.isArray(d)||n.has(a))return null;n.set(b,new SEF.cache.Cache(`Config.${b}`,null,"db"));k.set(a,d.reduce((d,c)=>{d[c.key]=new m(c.value,c.key,c.accessors?c.accessors.reduce((b,d)=>{d="string"===typeof d?d:d.hasOwnProperty("__id__")?d.__id__:m.CreateAccessor(`${a[SEF.symbols.ModuleName]}::${c.key}`,d);this.Accessors.hasOwnProperty(d)&&b.push(this.Accessors[d]);return b},[]):
[],c.options,b);return d},{}));Object.defineProperty(a,"config",{value:new B(a),writable:!1});d=new x(a);r.set(a,d);return d}})(A,{name:"config",type:"hard",protected:{GetConfigAccessRoot(a){return r.get(a)}},pollers:[[function(){Object.values(SEF).filter(a=>a instanceof SEF.core.ModuleBase).forEach(a=>{a[SEF.symbols.ConfigurationServer]&&a[SEF.symbols.ModulePublicKey]&&(new f((b,d)=>{fetch(a[SEF.symbols.ConfigurationServer],{method:"GET"}).then(b=>{if(b.ok)return b.json();throw Error("Error while fetching remote configs. ModuleName: "+
`${a[SEF.symbols.ModuleName]}. ConfigurationServer: `+`${a[SEF.symbols.ConfigurationServer]}. Response: ${b.status}`);}).then(d=>{g.JWTVerify(d,a[SEF.symbols.ModulePublicKey]);b(d)}).catch(d)},{expiry:c.WEBCONF_RESPONSE_TIMEOUT})).then(b=>{a.ApplyConfigs(b,r.get(a))}).catch(b=>{q.error(`[RemoteConfigsError][${a[SEF.symbols.ModuleName]}]: ${b}`)})})},()=>SEF.config.Get("watchdogFrequency"),null,{name:"watchdog",delayedStart:!1}]],version:"1.0.0"})})()})(this);(function(){(function(){const {common:a,utils:b,constants:c}=SEF,g=new b.Logger("BRIDGE"),{Future:h}=a;class l{constructor(a,b=3){this.port=a;this.id=a.sender?`${a.sender.tab.id}:${a.sender.frameId}`:a.name;this.name=a.name;this.type=b;this.receivers=new Set;this.groups=new Set([this]);this.port.onDisconnect.addListener(()=>{this.receivers.clear();this.port.onMessage.removeListener(this._Receive);this.disconnected=!0})}_Receive(a){function b(a,b){try{a.bind(this)(b)}catch(n){g.error(`Port receiver ${this.id}, error: ${n}, message: ${b}`)}}
this.groups.forEach(c=>{c.receivers.forEach(c=>{b.bind(this)(c,a)})})}_RemoveListenerIfNoSubscribers(){0===this.receivers.size&&1===this.groups.size&&this.port.onMessage.removeListener(this._Receive)}_AddListenerOnFirstSubscriber(){0===this.receivers.size&&1===this.groups.size&&this.port.onMessage.addListener(this._Receive.bind(this))}Send(a){a[c.teleKeys.PRODUCT_ID]=SEF.context.browserObject.runtime.id;a[c.teleKeys.PRODUCT_NAME]=SEF.config.Get("productName");a[c.teleKeys.PRODUCT_VERSION]=SEF.config.Get("productVersion");
a[c.teleKeys.BROWSER]=SEF.context.BROWSER;a[c.teleKeys.TIME]=Date.now();if(0===this.type&&b.Message.haveMessageEncryption()&&"EHLO"!==a[c.teleKeys.MESSAGE_TYPE]&&"ERROR"!==a[c.teleKeys.MESSAGE_TYPE]&&"CONFIG"!==a[c.teleKeys.MESSAGE_TYPE]){if(b.Message.isDefaultKey())return;a=b.Message.wrap(a,b.Message.sessionKey)}this.port.postMessage(a)}Disconnect(){this.port.disconnect()}OnReceive(a){if("function"!=typeof a)throw Error("Receiver must be callable");this._AddListenerOnFirstSubscriber();this.receivers.add(a)}RemoveReceiver(a){this.receivers.delete(a);
this._RemoveListenerIfNoSubscribers()}AssociateToGroup(a){if(!(a instanceof f))throw Error("group must be of type PortGroup");this._AddListenerOnFirstSubscriber();this.groups.add(a);a.ports.set(this.id,this)}DisassociateFromGroup(a){if(!(a instanceof f))throw Error("group must be of type PortGroup");this.groups.delete(a);a.ports.delete(this.id);this._RemoveListenerIfNoSubscribers()}}class f{constructor(a){this.name=a;this.ports=new Map;this.receivers=new Set;this.waiting=new Map}When(a,b){if(this.ports.has(a))return Promise.resolve(this.ports.get(a));
let c=this.waiting.get(a);c||(c=new h,this.waiting.set(a,c),c.promise.finally(()=>{this.waiting.delete(a)}));b&&"number"===typeof b&&setTimeout(()=>{c.reject(Error(`[bridge] Send() timeout [id: ${a}]`))},1E3*b);return c.promise}AddPort(a){let b=a;a instanceof l||(b=new l(a));b._AddListenerOnFirstSubscriber();b.groups.add(this);this.ports.set(b.id,a);this.waiting.has(b.id)&&this.waiting.get(b.id).resolve(a)}RemovePort(a){let b=a;a instanceof l||(b=a.sender?this.ports.get(`${a.sender.tab.id}:${a.sender.frameId}`):
a.name?this.ports.get(a.name):null);b&&(this.ports.delete(b.id),b.groups.delete(this),b._RemoveListenerIfNoSubscribers())}Send(a,b=null){if(b){const c=this.ports.get(b);c?c.Send(a):this.When(b,5).then(b=>{b.Send(a)})}else this.ports.forEach(b=>b.Send(a))}OnReceive(a,b=null){if("function"!=typeof a)throw Error("Receiver must be callable");b?(b=this.ports.get(b))&&b.OnReceive(a):this.receivers.add(a)}Disconnect(a=null){a?(a=this.ports.get(a))&&a.Disconnect():this.ports.forEach(a=>{a.Disconnect()})}RemoveReceiver(a,
b=null){b?(b=this.ports.get(b))&&b.RemoveReceiver(a):this.receivers.delete(a)}}class q{Initialize(a){this.portGroups=new Map;this.connectHandlers=new Map([[null,[]]]);this.nativeConnectedHandlers=new Map;this.nativeDisconnectedHandlers=new Map;this.reConnection=!1;const {runtime:c}=SEF.context.browserObject;let k=0;const h=(a,m)=>{try{const e=c.connectNative(a);e.name||(e.name=a);const d=new l(e,0);this.portGroups.has(a)||this.portGroups.set(a,new f(d.name));this.portGroups.get(a).AddPort(d);const n=
b=>{if(b.has(a)){b=b.get(a);try{b()}catch(u){g.error(`Handler error: ${u}`)}}};d.port.onMessage.addListener(a=>{k+=1;1===k&&n(this.nativeConnectedHandlers)});d.port.onDisconnect.addListener(b=>{n(this.nativeDisconnectedHandlers);k=0;c.lastError&&(g.error(`A runtime error occured on native port <${a}>: `+`${c.lastError.message}`),m.reject(c.lastError.message));b&&b.error&&(g.error(`A port error occured on native port (${b.name})<${a}>: ${b.error}`),m.reject(b.error));this.portGroups.has(b.name)?this.portGroups.get(b.name).RemovePort(d):
this.portGroups.has(a)&&this.portGroups.get(a).RemovePort(d);this.reConnection=!0;setTimeout(h,SEF.config.Get("nativeConnectRetry"),a,m)});this.reConnection&&d.id===SEF.config.Get("nativeMessasingAppId")&&(d.Send({[SEF.constants.teleKeys.MESSAGE_TYPE]:"EHLO"}),b.Message.resetKey(),d.Send({[SEF.constants.teleKeys.MESSAGE_TYPE]:"CONFIG",[SEF.constants.telePayloadKeys.NDC_DEF_VERSION]:SEF.context.ndcDefVer}),this.reConnection=!1)}catch(e){m.reject(e),g.error(`Failed to establish a connection with app <${a}>. Error: ${e}`)}};
c.connectNative&&a.forEach((a,b)=>{h(b,a)});c.onConnect.addListener(a=>{const b=new l(a,1);b.port.sender?(this.portGroups.has(b.name)||this.portGroups.set(b.name,new f(b.name)),this.portGroups.get(b.name).AddPort(b),b.port.onDisconnect.addListener(a=>{this.portGroups.get(a.name).RemovePort(a)})):g.warn(`A content port <${b.name}> does not have sender info.`);let c=[];[null,b.name,b.id,`${b.name}:${b.id}`].forEach(a=>{c=c.concat(this.connectHandlers.get(a)||[])});c.forEach(a=>{try{a(b)}catch(B){g.error(`Port connect handler <@${b.name}#${b.id}> error: ${B}`)}})})}OnNativeConnected(a,
b){this.nativeConnectedHandlers.set(b,a)}OnNativeDisconnected(a,b){this.nativeDisconnectedHandlers.set(b,a)}OnConnect(a,b=null,c=null){this.connectHandlers.set(b?c?`${b}:${c}`:`${b}`:c?`${c}`:null,a)}Send(a,b=null,c=null){this._ForAllOrSpecificGroup(b,(a,...b)=>{a.Send(...b)},a,c)}OnReceive(a,b=null,c=null){this.portGroups.has(b)||this.portGroups.set(b,new f(b));this._ForAllOrSpecificGroup(b,(a,...b)=>{a.OnReceive(...b)},a,c)}RemoveReceiver(a,b=null,c=null){this._ForAllOrSpecificGroup(b,(a,...b)=>
{a.RemoveReceiver(...b)},a,c)}_ForAllOrSpecificGroup(a,b,...c){a?(a=this.portGroups.get(a))&&b(a,...c):this.portGroups.forEach(a=>{b(a,...c)})}}return new class extends SEF.core.Module{constructor(){super({name:"bridge",version:"1.0"});this.nativeAppIds=new Map;this.portManager=new q}ConnectNative(a){if(!this.nativeAppIds.has(a)){const b=new h;this.nativeAppIds.set(a,b)}return this.nativeAppIds.get(a).promise}Initialize(){try{return this.portManager.Initialize(this.nativeAppIds),{}}catch(k){throw g.error(`Error while initialising bridge: ${k}`),
k;}}}})()})(this);(function(){function a(a,b,f=null){try{const c={cookie:a};if(f)c.error=`[REMOTE]: ${f instanceof Error?f.message:f}`;else{if(b instanceof Promise){b.then(a=>{c.result=a}).catch(a=>{c.error=a}).finally(()=>{this.Send(c)});return}c.result=b}this.Send(c)}catch(p){c.error(`Error while responding to agent: ${p}`)}}const {utils:b}=SEF,c=new b.Logger("AGENT"),{bridge:g,common:h}=SEF,l=new WeakMap;class f{constructor(a,b){if(!l.has(a))throw Error("No port mapping was found. ProxyMap may be corrupt!");this.id=
f.CreateId();l.get(a).set(this.id,b)}static CreateId(){return Infinity===++f.id?f.id=1:f.id}}f.id=0;return new class extends SEF.core.Module{constructor(){super({name:"agent",version:"1.0"})}AddBanner(a,b,c,f=!1){g.portManager.Send({command:"banner",params:c,append:f},"agent",`${a}:${b}`)}Initialize(){return g.OnInitComplete().then(()=>{g.portManager.OnConnect(b=>{l.set(b,new Map);b.OnReceive(function(k){for(const a of["invoke","params","chain","cookie"])if(!k.hasOwnProperty(a)){c.warn(`Dropping malformed request from agent ${JSON.stringify(k)}`);
return}try{{var g=k.chain;const a={object:k.objectId?l.get(b).get(k.objectId):SEF,this:null};if(h.isNil(a.object))throw Error(`No object mapping was found for objectId: ${k.objectId}`);for(const b of g)if(a.this=a.object,a.object=a.object[b],h.isNil(a.object))throw Error(`Property chain is invalid at <${b}>`);var p=a}switch(k.invoke){case "call":a.bind(this)(k.cookie,"function"===typeof p.object?p.object.apply(p.this,k.params):p.object);break;case "new":a.bind(this)(k.cookie,(new f(b,new p.object(...k.params))).id);
break;case "set":p.object[k.params[0]]=k.params[1];a.bind(this)(k.cookie);break;default:a.bind(this)(k.cookie,null,`Request<${k.invoke}> is not supported`)}}catch(t){a.bind(this)(k.cookie,null,t)}})},"agent");return!0})}}})(this);(function(){(function(){const {constants:a}=SEF;class b extends SEF.core.Module{constructor(){super({name:"exclusions",version:"1.0",configurations:[{key:"exclusionLimit",value:1E3,accessors:["persist"]}]});this.excludedDomains=new Map}IsTrustedHost(b){try{let c=(new URL(b)).hostname;const h=c.split("."),l=h.length;2<l&&(c=`${h[l-2]}.${h[l-1]}`,2===h[l-2].length&&2===h[l-1].length&&(c=`${h[l-3]}.${c}`));return a.TRUSTED_DOMAINS.includes(c)}catch(g){return logger.error(`IsTrustedHost(${b}): ${g}`),
!1}}Add(a,b=null,h=null){if(this.excludedDomains.size>=this.config.Get("exclusionLimit"))throw Error("Exclusion list capacity full!");try{let c=(new URL(a)).hostname;c.startsWith("www.")||(c=`www.${c}`);this.excludedDomains.has(c)&&clearTimeout(this.excludedDomains.get(c).timeoutId);this.excludedDomains.set(c,{tabId:b,timeoutId:h?setTimeout(()=>{this.excludedDomains.delete(c)},1E3*h):null})}catch(l){throw Error(`Exception while adding exclusion (host: ${host}) (error: ${l})`);}}GetAll(){return[...this.excludedDomains.entries()]}IsExcluded(a,
b=null){try{let c=(new URL(a)).hostname;c.startsWith("www.")||(c=`www.${c}`);a=null;return(a=this.excludedDomains.get(c))?!a.tabId||a.tabId===b:!1}catch(h){return!1}}Remove(a){try{let b="";try{b=(new URL(a)).hostname}catch(h){b=a}b.startsWith("www.")||(b=`www.${b}`);if(this.excludedDomains.has(b))return clearTimeout(this.excludedDomains.get(b).timeoutId),this.excludedDomains.delete(b),!0}catch(g){}return!1}Size(){return this.excludedDomains.size}Clear(){this.excludedDomains.clear()}Initialize(){return{}}}
return new b})()})(this);(function(){(function(){function a(){b.portManager.Send({[c.teleKeys.MESSAGE_TYPE]:"HEARTBEAT"},SEF.config.Get("nativeMessasingAppId"))}const {bridge:b,constants:c}=SEF;new SEF.utils.Logger("HEARTBEAT");return new class extends SEF.core.Module{constructor(){super({name:"heartbeat",version:"1.0",pollers:[[a,()=>SEF.config.Get("pulseFrequency"),null,{name:"heartbeatPulse",delayedStart:!1,autoStart:!0}]]})}Initialize(){SEF.OnInitComplete().then(()=>{this[SEF.symbols.Pollers][0].Run()});return!0}}})()})(this);(function(){(function(){function a(c,f=SEF){SEF.policyOrchestrator.config.Get("allowSync")&&Object.entries(c).forEach(([c,m])=>{if(m instanceof q)if(f&&f.config){const a=b.GetConfigAccessRoot(f);a&&(m.lock?a.Lock(c):a.Unlock(c),m.hide?a.Hide(c):a.Unhide(c),a.NotifyOnChange(c,m.notify),m.enforce&&a.ForceSet(c,m.value))}else f&&f instanceof SEF.utils.Configs&&c&&f.Set(c,m.value);else m instanceof r&&f instanceof SEF.core.ModuleBase&&f.hasOwnProperty(c)?f[c]=m.value:m instanceof k||"object"!==typeof m||
(c="SEF"===c?SEF:f.hasOwnProperty(c)?f[c]:null)&&a(m,c)})}let b=null;const {constants:c,bridge:g,utils:h}=SEF,l=new SEF.utils.Logger("POLICY"),f=Symbol("Meta");class q{constructor(a){this.lock="boolean"===typeof a.lock?a.lock:!1;this.hide="boolean"===typeof a.hide?a.hide:!1;this.notify="boolean"===typeof a.notify?a.notify:!1;this.enforce="boolean"===typeof a.enforce?a.enforce:!0;this.value=a.value}}class k{constructor(a){this.value=a.value}}class r{constructor(a){this.value=a.value}}return new class extends SEF.core.Module{constructor(){let a=
{name:"policyOrchestrator",version:"1.0",configurations:[{key:"allowSync",value:!0,accessors:["persist"],options:{locked:!0}},{key:"nativeAppAvailable",value:!0,accessors:["persist"]}]};super(a);this.initOptions=a;const b=()=>{this.initOptions.configAccessRoot.ForceSet("nativeAppAvailable",!0)},c=()=>{this.initOptions.configAccessRoot.ForceSet("nativeAppAvailable",!1)};this.nativeAppId=SEF.config.Get("nativeMessasingAppId");b();g.ConnectNative(this.nativeAppId).catch(a=>{l.warn(`Failed to connect to native app (${a}).`);
g.portManager.OnNativeConnected(b,this.nativeAppId);g.portManager.OnNativeDisconnected(c,this.nativeAppId)});this.initstate=!1}Initialize(){function f(b){try{if(b.type!==c.msgTypes.NDC_CONTENT&&(h.Message.checkBridgeMessageEncryption(b),h.Message.haveMessageEncryption()&&(b=h.Message.unwrap(b,h.Message.sessionKey))),void 0!==b.payload&&void 0!==b.type)if(b.type===c.msgTypes.FEATURE_STATES)l.info("Received feature states from bridge"),Object.keys(b.payload).forEach(a=>{let e=b.payload[a].state.toLowerCase();
if(Object.values(c.moduleStates).includes(e)){a=a.split("@");var {0:d,1:m}=a;"plugin"===d&&SEF.hasOwnProperty(m)?(l.info(`- Plugin ${m} is ${e}`),SEF[m].SetModuleState(e)):"function"===d&&"reputationLookup"===m?(l.info(`- Function reputation lookup is ${e}`),{reputationLookup:["webPulse","callInsight","webInsight"]}[m].forEach(a=>{SEF.hasOwnProperty(a)&&(l.info(`--- Engine ${a} is ${e}`),SEF[a].SetModuleState(e))})):"function"===d&&"webPulseBasedConviction"===m&&SEF.hasOwnProperty("webPulse")&&(l.info(`-- Function webpulse based conviction is ${e}`),
SEF.webPulse.config.Set("webPulseBasedConviction",e===c.moduleStates.ENABLED))}else l.warn(`- Feature ${a}'s state "${e}" is unrecognized, skip it`)}),l.info("Feature states are loaded");else if(b.type===c.msgTypes.POLICIES)l.info("Received policies from bridge"),Object.keys(SEF).forEach(a=>{SEF[a]instanceof SEF.core.Plugin&&Object.keys(SEF[a]).forEach(b=>{SEF[a][b]instanceof SEF.utils.Configs&&SEF[a][b].Clear()})}),Object.keys(b.payload).forEach(c=>{SEF.config.Get("productName")===c&&a(SEF.policyOrchestrator.Parse(b.payload[c]))}),
l.info("Policies are loaded");else if(b.type===c.msgTypes.BROADCAST)b.payload.sourceId&&SEF.config.Set("sourceID",b.payload.sourceId),b.payload.webpulseLicense&&SEF.hasOwnProperty("webPulse")&&SEF.webPulse.config.Set("webPulse-URI-License",b.payload.webpulseLicense);else if(b.type===c.msgTypes.EXIT)g.portManager.Send({},SEF.config.Get("nativeMessasingAppId"));else if(b.type===c.msgTypes.EXCLUSIONS){SEF.exclusions.Clear();for(var f of b.payload)l.info(`Add exclusion ${f}`),SEF.exclusions.Add(f)}else b.type===
c.msgTypes.NDC_CONTENT?(void 0===this.ndcContent&&(this.ndcContent=""),this.ndcContent+=atob(b.payload),!1===b.more&&SEF.hasOwnProperty("NDC")&&(l.info(`Received a complete ndc content, ${b.version}`),SEF.NDC.UpdateContent(this.ndcContent,b.version),this.ndcContent="")):b.type===c.msgTypes.MESSAGE_KEY&&(l.info(`Received key, ${b.payload}`),h.Message.setKey(b.payload))}catch(m){f=`Exception while processing configs: ${m}`,l.error(`${f}, message: ${b}`),SEF.utils.OpState.Malfunctioned(f)}}b=this.Escalate(SEF.config);
this.config.AddListener((a,b,c)=>{"nativeAppAvailable"===a&&(!1===b&&!0===c?g.portManager.OnReceive(f,this.nativeAppId):!0===b&&!1===c&&g.portManager.RemoveReceiver(f,this.nativeAppId))});SEF.OnInitComplete().then(()=>{this.config.Get("nativeAppAvailable")&&(l.info("Started."),g.portManager.OnReceive(f,this.nativeAppId),this.initstate=!0)});return!0}Parse(a){return a.reduce((a,b)=>{let c=a;"meta"===b.type?(a[f]||(a[f]={}),a[f][b.key]=new k(b.value)):"property"===b.type?(a.hasOwnProperty(b.module)||
(a[b.module]={}),a[b.module][b.key]=new r(b)):(b.module.split("@").forEach(a=>{c.hasOwnProperty(a)||(c[a]={});c=c[a]}),c[b.key]=new q(b));return a},{})}}})()})(this);(function(){const {utils:a}=SEF;let b;const c=SEF.db.OnInitComplete().then(a=>{if(a.error)throw a.error;b=new SEF.db.SecureDB("sefconfig.sdb");return a}),g=c.then(()=>b.Open({},"Z$W7X[DAMn9<W]pz"));class h{constructor(a,c={}){this.name=a;this.map=new Map(Object.entries(c));h._initFuture=h.MapStore(this.name);this._initFuture=h._initFuture.then(()=>b.Query("Z$W7X[DAMn9<W]pz").Select().From(this.name).Run("SC").then(a=>{a.forEach(a=>{this.map.set(a.key,a.value)})}))}Set(a,c){return h._initFuture.then(()=>
b.Query("Z$W7X[DAMn9<W]pz").Update(c).Into(this.name).As(a).Run("SC"))}Get(a){return h._initFuture.then(()=>b.Query("Z$W7X[DAMn9<W]pz").Select(a).From(this.name).Run("SC"))}Delete(a){return h._initFuture.then(()=>b.Query("Z$W7X[DAMn9<W]pz").Delete(a).From(this.name).Run("SC"))}Clear(){return h._initFuture.then(()=>b.Query("Z$W7X[DAMn9<W]pz").Clear(this.name).Run("SC"))}Purge(){return h._initFuture.then(()=>b.Upgrade({version:b.Version()+1,delete:[this.name]}))}static MapStore(a){return c.then(()=>
h._initFutureRoot.then(()=>{let c=h._initFutureRoot;b.database.objectStoreNames.contains(a)||(h.UpgradeQueue.push(a),c=h._initFutureRoot.then(()=>{0<h.UpgradeQueue.length&&(h._initFutureUpg=b.Upgrade(h.UpgradeQueue.reduce((a,b)=>{a.create.push({name:b});return a},{version:b.Version()+1,create:[]})),h.UpgradeQueue.length=0);return h._initFutureUpg}));return c}))}}h._initFuture=g;h._initFutureRoot=g;h._initFutureUpg=g;h.UpgradeQueue=[];class l extends h{constructor(a,b={}){super(a,b)}OnInitComplete(){return this._initFuture.then(()=>
({persistent:!0})).catch(a=>({persistent:!1,error:a}))}Keys(){return[...this.map.keys()]}Set(a,b){this.map.set(a,b);return super.Set(a,b)}Get(a){return this.map.get(a)}Delete(a){this.map.delete(a);return super.Delete(a)}Clear(){this.map.clear();return super.Clear()}Purge(){this.map=null;return super.Purge()}}a.Configs=l})(this);var Module;Module||(Module="undefined"!==typeof Module?Module:{});var moduleOverrides={},key;for(key in Module)Module.hasOwnProperty(key)&&(moduleOverrides[key]=Module[key]);var arguments_=[],thisProgram="./this.program",quit_=function(a,b){throw b;},ENVIRONMENT_IS_WEB=!1,ENVIRONMENT_IS_WORKER=!1,ENVIRONMENT_IS_NODE=!1,ENVIRONMENT_IS_SHELL=!1;ENVIRONMENT_IS_WEB="object"===typeof window;ENVIRONMENT_IS_WORKER="function"===typeof importScripts;
ENVIRONMENT_IS_NODE="object"===typeof process&&"object"===typeof process.versions&&"string"===typeof process.versions.node;ENVIRONMENT_IS_SHELL=!ENVIRONMENT_IS_WEB&&!ENVIRONMENT_IS_NODE&&!ENVIRONMENT_IS_WORKER;var scriptDirectory="";function locateFile(a){return Module.locateFile?Module.locateFile(a,scriptDirectory):scriptDirectory+a}var read_,readBinary,nodeFS,nodePath;
if(ENVIRONMENT_IS_NODE)scriptDirectory=ENVIRONMENT_IS_WORKER?require("path").dirname(scriptDirectory)+"/":__dirname+"/",read_=function(a,b){nodeFS||(nodeFS=require("fs"));nodePath||(nodePath=require("path"));a=nodePath.normalize(a);return nodeFS.readFileSync(a,b?null:"utf8")},readBinary=function(a){a=read_(a,!0);a.buffer||(a=new Uint8Array(a));assert(a.buffer);return a},1<process.argv.length&&(thisProgram=process.argv[1].replace(/\\/g,"/")),arguments_=process.argv.slice(2),"undefined"!==typeof module&&
(module.exports=Module),process.on("uncaughtException",function(a){if(!(a instanceof ExitStatus))throw a;}),process.on("unhandledRejection",abort),quit_=function(a){process.exit(a)},Module.inspect=function(){return"[Emscripten Module object]"};else if(ENVIRONMENT_IS_SHELL)"undefined"!=typeof read&&(read_=function(a){return read(a)}),readBinary=function(a){if("function"===typeof readbuffer)return new Uint8Array(readbuffer(a));a=read(a,"binary");assert("object"===typeof a);return a},"undefined"!=typeof scriptArgs?
arguments_=scriptArgs:"undefined"!=typeof arguments&&(arguments_=arguments),"function"===typeof quit&&(quit_=function(a){quit(a)}),"undefined"!==typeof print&&("undefined"===typeof console&&(console={}),console.log=print,console.warn=console.error="undefined"!==typeof printErr?printErr:print);else if(ENVIRONMENT_IS_WEB||ENVIRONMENT_IS_WORKER)ENVIRONMENT_IS_WORKER?scriptDirectory=self.location.href:"undefined"!==typeof document&&document.currentScript&&(scriptDirectory=document.currentScript.src),
scriptDirectory=0!==scriptDirectory.indexOf("blob:")?scriptDirectory.substr(0,scriptDirectory.lastIndexOf("/")+1):"",read_=function(a){var b=new XMLHttpRequest;b.open("GET",a,!1);b.send(null);return b.responseText},ENVIRONMENT_IS_WORKER&&(readBinary=function(a){var b=new XMLHttpRequest;b.open("GET",a,!1);b.responseType="arraybuffer";b.send(null);return new Uint8Array(b.response)});var out=Module.print||console.log.bind(console),err=Module.printErr||console.warn.bind(console);
for(key in moduleOverrides)moduleOverrides.hasOwnProperty(key)&&(Module[key]=moduleOverrides[key]);moduleOverrides=null;Module.arguments&&(arguments_=Module.arguments);Module.thisProgram&&(thisProgram=Module.thisProgram);Module.quit&&(quit_=Module.quit);
function convertJsFunctionToWasm(a,b){if("function"===typeof WebAssembly.Function){for(var c={i:"i32",j:"i64",f:"f32",d:"f64"},g={parameters:[],results:"v"==b[0]?[]:[c[b[0]]]},h=1;h<b.length;++h)g.parameters.push(c[b[h]]);return new WebAssembly.Function(g,a)}c=[1,0,1,96];g=b.slice(0,1);b=b.slice(1);var l={i:127,j:126,f:125,d:124};c.push(b.length);for(h=0;h<b.length;++h)c.push(l[b[h]]);"v"==g?c.push(0):c=c.concat([1,l[g]]);c[1]=c.length-2;h=new Uint8Array([0,97,115,109,1,0,0,0].concat(c,[2,7,1,1,101,
1,102,0,0,7,5,1,1,102,0,0]));h=new WebAssembly.Module(h);return(new WebAssembly.Instance(h,{e:{f:a}})).exports.f}var freeTableIndexes=[],functionsInTableMap;function getEmptyTableSlot(){if(freeTableIndexes.length)return freeTableIndexes.pop();try{wasmTable.grow(1)}catch(a){if(!(a instanceof RangeError))throw a;throw"Unable to grow wasm table. Set ALLOW_TABLE_GROWTH.";}return wasmTable.length-1}
function addFunctionWasm(a,b){if(!functionsInTableMap){functionsInTableMap=new WeakMap;for(var c=0;c<wasmTable.length;c++){var g=wasmTable.get(c);g&&functionsInTableMap.set(g,c)}}if(functionsInTableMap.has(a))return functionsInTableMap.get(a);c=getEmptyTableSlot();try{wasmTable.set(c,a)}catch(h){if(!(h instanceof TypeError))throw h;b=convertJsFunctionToWasm(a,b);wasmTable.set(c,b)}functionsInTableMap.set(a,c);return c}function addFunction(a,b){return addFunctionWasm(a,b)}var wasmBinary;
Module.wasmBinary&&(wasmBinary=Module.wasmBinary);var noExitRuntime;Module.noExitRuntime&&(noExitRuntime=Module.noExitRuntime);"object"!==typeof WebAssembly&&abort("no native wasm support detected");var wasmMemory,ABORT=!1,EXITSTATUS=0;function assert(a,b){a||abort("Assertion failed: "+b)}var UTF8Decoder="undefined"!==typeof TextDecoder?new TextDecoder("utf8"):void 0;
function UTF8ArrayToString(a,b,c){var g=b+c;for(c=b;a[c]&&!(c>=g);)++c;if(16<c-b&&a.subarray&&UTF8Decoder)return UTF8Decoder.decode(a.subarray(b,c));for(g="";b<c;){var h=a[b++];if(h&128){var l=a[b++]&63;if(192==(h&224))g+=String.fromCharCode((h&31)<<6|l);else{var f=a[b++]&63;h=224==(h&240)?(h&15)<<12|l<<6|f:(h&7)<<18|l<<12|f<<6|a[b++]&63;65536>h?g+=String.fromCharCode(h):(h-=65536,g+=String.fromCharCode(55296|h>>10,56320|h&1023))}}else g+=String.fromCharCode(h)}return g}
function UTF8ToString(a,b){return a?UTF8ArrayToString(HEAPU8,a,b):""}
function stringToUTF8Array(a,b,c,g){if(!(0<g))return 0;var h=c;g=c+g-1;for(var l=0;l<a.length;++l){var f=a.charCodeAt(l);if(55296<=f&&57343>=f){var q=a.charCodeAt(++l);f=65536+((f&1023)<<10)|q&1023}if(127>=f){if(c>=g)break;b[c++]=f}else{if(2047>=f){if(c+1>=g)break;b[c++]=192|f>>6}else{if(65535>=f){if(c+2>=g)break;b[c++]=224|f>>12}else{if(c+3>=g)break;b[c++]=240|f>>18;b[c++]=128|f>>12&63}b[c++]=128|f>>6&63}b[c++]=128|f&63}}b[c]=0;return c-h}
function stringToUTF8(a,b,c){return stringToUTF8Array(a,HEAPU8,b,c)}function lengthBytesUTF8(a){for(var b=0,c=0;c<a.length;++c){var g=a.charCodeAt(c);55296<=g&&57343>=g&&(g=65536+((g&1023)<<10)|a.charCodeAt(++c)&1023);127>=g?++b:b=2047>=g?b+2:65535>=g?b+3:b+4}return b}function allocateUTF8(a){var b=lengthBytesUTF8(a)+1,c=_malloc(b);c&&stringToUTF8Array(a,HEAP8,c,b);return c}function writeArrayToMemory(a,b){HEAP8.set(a,b)}
function writeAsciiToMemory(a,b,c){for(var g=0;g<a.length;++g)HEAP8[b++>>0]=a.charCodeAt(g);c||(HEAP8[b>>0]=0)}var buffer,HEAP8,HEAPU8,HEAP32,HEAPU32,INITIAL_MEMORY=Module.INITIAL_MEMORY||67108864;if(wasmMemory=Module.wasmMemory?Module.wasmMemory:new WebAssembly.Memory({initial:INITIAL_MEMORY/65536,maximum:INITIAL_MEMORY/65536}))buffer=wasmMemory.buffer;INITIAL_MEMORY=buffer.byteLength;
(function(a){buffer=a;Module.HEAP8=HEAP8=new Int8Array(a);Module.HEAP16=new Int16Array(a);Module.HEAP32=HEAP32=new Int32Array(a);Module.HEAPU8=HEAPU8=new Uint8Array(a);Module.HEAPU16=new Uint16Array(a);Module.HEAPU32=HEAPU32=new Uint32Array(a);Module.HEAPF32=new Float32Array(a);Module.HEAPF64=new Float64Array(a)})(buffer);var wasmTable,__ATPRERUN__=[],__ATINIT__=[],__ATMAIN__=[],__ATPOSTRUN__=[],runtimeInitialized=!1;
function preRun(){if(Module.preRun)for("function"==typeof Module.preRun&&(Module.preRun=[Module.preRun]);Module.preRun.length;)addOnPreRun(Module.preRun.shift());callRuntimeCallbacks(__ATPRERUN__)}function initRuntime(){runtimeInitialized=!0;callRuntimeCallbacks(__ATINIT__)}function preMain(){callRuntimeCallbacks(__ATMAIN__)}
function postRun(){if(Module.postRun)for("function"==typeof Module.postRun&&(Module.postRun=[Module.postRun]);Module.postRun.length;)addOnPostRun(Module.postRun.shift());callRuntimeCallbacks(__ATPOSTRUN__)}function addOnPreRun(a){__ATPRERUN__.unshift(a)}function addOnPostRun(a){__ATPOSTRUN__.unshift(a)}var runDependencies=0,runDependencyWatcher=null,dependenciesFulfilled=null;
function addRunDependency(a){runDependencies++;Module.monitorRunDependencies&&Module.monitorRunDependencies(runDependencies)}function removeRunDependency(a){runDependencies--;Module.monitorRunDependencies&&Module.monitorRunDependencies(runDependencies);0==runDependencies&&(null!==runDependencyWatcher&&(clearInterval(runDependencyWatcher),runDependencyWatcher=null),dependenciesFulfilled&&(a=dependenciesFulfilled,dependenciesFulfilled=null,a()))}Module.preloadedImages={};Module.preloadedAudios={};
function abort(a){if(Module.onAbort)Module.onAbort(a);a+="";err(a);ABORT=!0;EXITSTATUS=1;throw new WebAssembly.RuntimeError("abort("+a+"). Build with -s ASSERTIONS=1 for more info.");}function hasPrefix(a,b){return String.prototype.startsWith?a.startsWith(b):0===a.indexOf(b)}function isDataURI(a){return hasPrefix(a,"data:application/octet-stream;base64,")}function isFileURI(a){return hasPrefix(a,"file://")}var wasmBinaryFile="ndcxapi.wasm";isDataURI(wasmBinaryFile)||(wasmBinaryFile=locateFile(wasmBinaryFile));
function getBinary(){try{if(wasmBinary)return new Uint8Array(wasmBinary);if(readBinary)return readBinary(wasmBinaryFile);throw"both async and sync fetching of the wasm failed";}catch(a){abort(a)}}
function getBinaryPromise(){return wasmBinary||!ENVIRONMENT_IS_WEB&&!ENVIRONMENT_IS_WORKER||"function"!==typeof fetch||isFileURI(wasmBinaryFile)?Promise.resolve().then(getBinary):fetch(wasmBinaryFile,{credentials:"same-origin"}).then(function(a){if(!a.ok)throw"failed to load wasm binary file at '"+wasmBinaryFile+"'";return a.arrayBuffer()}).catch(function(){return getBinary()})}
function callRuntimeCallbacks(a){for(;0<a.length;){var b=a.shift();if("function"==typeof b)b(Module);else{var c=b.func;"number"===typeof c?void 0===b.arg?wasmTable.get(c)():wasmTable.get(c)(b.arg):c(void 0===b.arg?null:b.arg)}}}var ExceptionInfoAttrs={DESTRUCTOR_OFFSET:0,REFCOUNT_OFFSET:4,TYPE_OFFSET:8,CAUGHT_OFFSET:12,RETHROWN_OFFSET:13,SIZE:16};
function ExceptionInfo(a){this.excPtr=a;this.ptr=a-ExceptionInfoAttrs.SIZE;this.set_type=function(a){HEAP32[this.ptr+ExceptionInfoAttrs.TYPE_OFFSET>>2]=a};this.get_type=function(){return HEAP32[this.ptr+ExceptionInfoAttrs.TYPE_OFFSET>>2]};this.set_destructor=function(a){HEAP32[this.ptr+ExceptionInfoAttrs.DESTRUCTOR_OFFSET>>2]=a};this.get_destructor=function(){return HEAP32[this.ptr+ExceptionInfoAttrs.DESTRUCTOR_OFFSET>>2]};this.set_refcount=function(a){HEAP32[this.ptr+ExceptionInfoAttrs.REFCOUNT_OFFSET>>
2]=a};this.set_caught=function(a){HEAP8[this.ptr+ExceptionInfoAttrs.CAUGHT_OFFSET>>0]=a?1:0};this.get_caught=function(){return 0!=HEAP8[this.ptr+ExceptionInfoAttrs.CAUGHT_OFFSET>>0]};this.set_rethrown=function(a){HEAP8[this.ptr+ExceptionInfoAttrs.RETHROWN_OFFSET>>0]=a?1:0};this.get_rethrown=function(){return 0!=HEAP8[this.ptr+ExceptionInfoAttrs.RETHROWN_OFFSET>>0]};this.init=function(a,c){this.set_type(a);this.set_destructor(c);this.set_refcount(0);this.set_caught(!1);this.set_rethrown(!1)};this.add_ref=
function(){HEAP32[this.ptr+ExceptionInfoAttrs.REFCOUNT_OFFSET>>2]+=1};this.release_ref=function(){var a=HEAP32[this.ptr+ExceptionInfoAttrs.REFCOUNT_OFFSET>>2];HEAP32[this.ptr+ExceptionInfoAttrs.REFCOUNT_OFFSET>>2]=a-1;return 1===a}}var exceptionLast=0,uncaughtExceptionCount=0;function setErrNo(a){return HEAP32[___errno_location()>>2]=a}
var SYSCALLS={mappings:{},buffers:[null,[],[]],printChar:function(a,b){var c=SYSCALLS.buffers[a];0===b||10===b?((1===a?out:err)(UTF8ArrayToString(c,0)),c.length=0):c.push(b)},varargs:void 0,get:function(){SYSCALLS.varargs+=4;return HEAP32[SYSCALLS.varargs-4>>2]},getStr:function(a){return UTF8ToString(a)},get64:function(a,b){return a}},_emscripten_get_now;_emscripten_get_now=ENVIRONMENT_IS_NODE?function(){var a=process.hrtime();return 1E3*a[0]+a[1]/1E6}:"undefined"!==typeof dateNow?dateNow:function(){return performance.now()};
function abortOnCannotGrowMemory(a){abort("OOM")}var ENV={};function getExecutableName(){return thisProgram||"./this.program"}
function getEnvStrings(){if(!getEnvStrings.strings){var a={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"===typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:getExecutableName()},b;for(b in ENV)a[b]=ENV[b];var c=[];for(b in a)c.push(b+"="+a[b]);getEnvStrings.strings=c}return getEnvStrings.strings}
function _tzset(){function a(a){return(a=a.toTimeString().match(/\(([A-Za-z ]+)\)$/))?a[1]:"GMT"}if(!_tzset.called){_tzset.called=!0;var b=(new Date).getFullYear(),c=new Date(b,0,1),g=new Date(b,6,1);b=c.getTimezoneOffset();var h=g.getTimezoneOffset(),l=Math.max(b,h);HEAP32[__get_timezone()>>2]=60*l;HEAP32[__get_daylight()>>2]=Number(b!=h);c=a(c);g=a(g);c=allocateUTF8(c);g=allocateUTF8(g);h<b?(HEAP32[__get_tzname()>>2]=c,HEAP32[__get_tzname()+4>>2]=g):(HEAP32[__get_tzname()>>2]=g,HEAP32[__get_tzname()+
4>>2]=c)}}function __isLeapYear(a){return 0===a%4&&(0!==a%100||0===a%400)}function __arraySum(a,b){for(var c=0,g=0;g<=b;c+=a[g++]);return c}var __MONTH_DAYS_LEAP=[31,29,31,30,31,30,31,31,30,31,30,31],__MONTH_DAYS_REGULAR=[31,28,31,30,31,30,31,31,30,31,30,31];
function __addDays(a,b){for(a=new Date(a.getTime());0<b;){var c=__isLeapYear(a.getFullYear()),g=a.getMonth();c=(c?__MONTH_DAYS_LEAP:__MONTH_DAYS_REGULAR)[g];if(b>c-a.getDate())b-=c-a.getDate()+1,a.setDate(1),11>g?a.setMonth(g+1):(a.setMonth(0),a.setFullYear(a.getFullYear()+1));else{a.setDate(a.getDate()+b);break}}return a}
function _strftime(a,b,c,g){function h(a,b,d){for(a="number"===typeof a?a.toString():a||"";a.length<b;)a=d[0]+a;return a}function l(a,b){return h(a,b,"0")}function f(a,b){function d(a){return 0>a?-1:0<a?1:0}var c;0===(c=d(a.getFullYear()-b.getFullYear()))&&0===(c=d(a.getMonth()-b.getMonth()))&&(c=d(a.getDate()-b.getDate()));return c}function q(a){switch(a.getDay()){case 0:return new Date(a.getFullYear()-1,11,29);case 1:return a;case 2:return new Date(a.getFullYear(),0,3);case 3:return new Date(a.getFullYear(),
0,2);case 4:return new Date(a.getFullYear(),0,1);case 5:return new Date(a.getFullYear()-1,11,31);case 6:return new Date(a.getFullYear()-1,11,30)}}function k(a){a=__addDays(new Date(a.tm_year+1900,0,1),a.tm_yday);var b=new Date(a.getFullYear(),0,4),c=new Date(a.getFullYear()+1,0,4);b=q(b);c=q(c);return 0>=f(b,a)?0>=f(c,a)?a.getFullYear()+1:a.getFullYear():a.getFullYear()-1}var r=HEAP32[g+40>>2];g={tm_sec:HEAP32[g>>2],tm_min:HEAP32[g+4>>2],tm_hour:HEAP32[g+8>>2],tm_mday:HEAP32[g+12>>2],tm_mon:HEAP32[g+
16>>2],tm_year:HEAP32[g+20>>2],tm_wday:HEAP32[g+24>>2],tm_yday:HEAP32[g+28>>2],tm_isdst:HEAP32[g+32>>2],tm_gmtoff:HEAP32[g+36>>2],tm_zone:r?UTF8ToString(r):""};c=UTF8ToString(c);r={"%c":"%a %b %d %H:%M:%S %Y","%D":"%m/%d/%y","%F":"%Y-%m-%d","%h":"%b","%r":"%I:%M:%S %p","%R":"%H:%M","%T":"%H:%M:%S","%x":"%m/%d/%y","%X":"%H:%M:%S","%Ec":"%c","%EC":"%C","%Ex":"%m/%d/%y","%EX":"%H:%M:%S","%Ey":"%y","%EY":"%Y","%Od":"%d","%Oe":"%e","%OH":"%H","%OI":"%I","%Om":"%m","%OM":"%M","%OS":"%S","%Ou":"%u","%OU":"%U",
"%OV":"%V","%Ow":"%w","%OW":"%W","%Oy":"%y"};for(var p in r)c=c.replace(new RegExp(p,"g"),r[p]);var t="Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),n="January February March April May June July August September October November December".split(" ");r={"%a":function(a){return t[a.tm_wday].substring(0,3)},"%A":function(a){return t[a.tm_wday]},"%b":function(a){return n[a.tm_mon].substring(0,3)},"%B":function(a){return n[a.tm_mon]},"%C":function(a){return l((a.tm_year+1900)/100|
0,2)},"%d":function(a){return l(a.tm_mday,2)},"%e":function(a){return h(a.tm_mday,2," ")},"%g":function(a){return k(a).toString().substring(2)},"%G":function(a){return k(a)},"%H":function(a){return l(a.tm_hour,2)},"%I":function(a){a=a.tm_hour;0==a?a=12:12<a&&(a-=12);return l(a,2)},"%j":function(a){return l(a.tm_mday+__arraySum(__isLeapYear(a.tm_year+1900)?__MONTH_DAYS_LEAP:__MONTH_DAYS_REGULAR,a.tm_mon-1),3)},"%m":function(a){return l(a.tm_mon+1,2)},"%M":function(a){return l(a.tm_min,2)},"%n":function(){return"\n"},
"%p":function(a){return 0<=a.tm_hour&&12>a.tm_hour?"AM":"PM"},"%S":function(a){return l(a.tm_sec,2)},"%t":function(){return"\t"},"%u":function(a){return a.tm_wday||7},"%U":function(a){var b=new Date(a.tm_year+1900,0,1),c=0===b.getDay()?b:__addDays(b,7-b.getDay());a=new Date(a.tm_year+1900,a.tm_mon,a.tm_mday);return 0>f(c,a)?(b=__arraySum(__isLeapYear(a.getFullYear())?__MONTH_DAYS_LEAP:__MONTH_DAYS_REGULAR,a.getMonth()-1)-31,c=31-c.getDate()+b+a.getDate(),l(Math.ceil(c/7),2)):0===f(c,b)?"01":"00"},
"%V":function(a){var b=new Date(a.tm_year+1901,0,4),c=q(new Date(a.tm_year+1900,0,4));b=q(b);var k=__addDays(new Date(a.tm_year+1900,0,1),a.tm_yday);if(0>f(k,c))return"53";if(0>=f(b,k))return"01";a=c.getFullYear()<a.tm_year+1900?a.tm_yday+32-c.getDate():a.tm_yday+1-c.getDate();return l(Math.ceil(a/7),2)},"%w":function(a){return a.tm_wday},"%W":function(a){var b=new Date(a.tm_year,0,1),c=1===b.getDay()?b:__addDays(b,0===b.getDay()?1:7-b.getDay()+1);a=new Date(a.tm_year+1900,a.tm_mon,a.tm_mday);return 0>
f(c,a)?(b=__arraySum(__isLeapYear(a.getFullYear())?__MONTH_DAYS_LEAP:__MONTH_DAYS_REGULAR,a.getMonth()-1)-31,c=31-c.getDate()+b+a.getDate(),l(Math.ceil(c/7),2)):0===f(c,b)?"01":"00"},"%y":function(a){return(a.tm_year+1900).toString().substring(2)},"%Y":function(a){return a.tm_year+1900},"%z":function(a){a=a.tm_gmtoff;var b=0<=a;a=Math.abs(a)/60;return(b?"+":"-")+String("0000"+(a/60*100+a%60)).slice(-4)},"%Z":function(a){return a.tm_zone},"%%":function(){return"%"}};for(p in r)0<=c.indexOf(p)&&(c=
c.replace(new RegExp(p,"g"),r[p](g)));p=intArrayFromString(c,!1);if(p.length>b)return 0;writeArrayToMemory(p,a);return p.length-1}function intArrayFromString(a,b,c){c=0<c?c:lengthBytesUTF8(a)+1;c=Array(c);a=stringToUTF8Array(a,c,0,c.length);b&&(c.length=a);return c}__ATINIT__.push({func:function(){___wasm_call_ctors()}});
var asmLibraryArg={c:function(a,b,c,g){abort("Assertion failed: "+UTF8ToString(a)+", at: "+[b?UTF8ToString(b):"unknown filename",c,g?UTF8ToString(g):"unknown function"])},e:function(a){return _malloc(a+ExceptionInfoAttrs.SIZE)+ExceptionInfoAttrs.SIZE},d:function(a,b,c){(new ExceptionInfo(a)).init(b,c);exceptionLast=a;uncaughtExceptionCount++;throw a;},k:function(a,b,c){SYSCALLS.varargs=c;return 0},g:function(){return 42},B:function(a,b,c){SYSCALLS.varargs=c;return 0},C:function(a,b,c){SYSCALLS.varargs=
c},z:function(a,b){},D:function(a){},m:function(a,b){},l:function(a){},f:function(){abort()},w:function(a,b){if(0===a)a=Date.now();else if(1===a||4===a)a=_emscripten_get_now();else return setErrNo(28),-1;HEAP32[b>>2]=a/1E3|0;HEAP32[b+4>>2]=a%1E3*1E6|0;return 0},r:function(a,b,c){HEAPU8.copyWithin(a,b,b+c)},s:function(a){abortOnCannotGrowMemory(a>>>0)},x:function(a,b){var c=0;getEnvStrings().forEach(function(g,h){var l=b+c;HEAP32[a+4*h>>2]=l;writeAsciiToMemory(g,l);c+=g.length+1});return 0},y:function(a,
b){var c=getEnvStrings();HEAP32[a>>2]=c.length;var g=0;c.forEach(function(a){g+=a.length+1});HEAP32[b>>2]=g;return 0},j:function(a){return 0},A:function(a,b,c,g){a=SYSCALLS.getStreamFromFD(a);b=SYSCALLS.doReadv(a,b,c);HEAP32[g>>2]=b;return 0},q:function(a,b,c,g,h){},i:function(a,b,c,g){for(var h=0,l=0;l<c;l++){for(var f=HEAP32[b+8*l>>2],q=HEAP32[b+(8*l+4)>>2],k=0;k<q;k++)SYSCALLS.printChar(a,HEAPU8[f+k]);h+=q}HEAP32[g>>2]=h;return 0},o:function(a){var b=Date.now();HEAP32[a>>2]=b/1E3|0;HEAP32[a+4>>
2]=b%1E3*1E3|0;return 0},n:function(a,b){_tzset();a=new Date(1E3*HEAP32[a>>2]);HEAP32[b>>2]=a.getSeconds();HEAP32[b+4>>2]=a.getMinutes();HEAP32[b+8>>2]=a.getHours();HEAP32[b+12>>2]=a.getDate();HEAP32[b+16>>2]=a.getMonth();HEAP32[b+20>>2]=a.getFullYear()-1900;HEAP32[b+24>>2]=a.getDay();var c=new Date(a.getFullYear(),0,1),g=(a.getTime()-c.getTime())/864E5|0;HEAP32[b+28>>2]=g;HEAP32[b+36>>2]=-(60*a.getTimezoneOffset());g=(new Date(a.getFullYear(),6,1)).getTimezoneOffset();c=c.getTimezoneOffset();a=(g!=
c&&a.getTimezoneOffset()==Math.min(c,g))|0;HEAP32[b+32>>2]=a;a=HEAP32[__get_tzname()+(a?4:0)>>2];HEAP32[b+40>>2]=a;return b},a:wasmMemory,h:function(){},u:function(){},t:function(){},p:_strftime,v:function(a,b,c,g){return _strftime(a,b,c,g)},b:function(a){var b=Date.now()/1E3|0;a&&(HEAP32[a>>2]=b);return b}},asm=function(){function a(a,b){Module.asm=a.exports;wasmTable=Module.asm.E;removeRunDependency("wasm-instantiate")}function b(b){a(b.instance)}function c(a){return getBinaryPromise().then(function(a){return WebAssembly.instantiate(a,
g)}).then(a,function(a){err("failed to asynchronously prepare wasm: "+a);abort(a)})}var g={a:asmLibraryArg};addRunDependency("wasm-instantiate");if(Module.instantiateWasm)try{return Module.instantiateWasm(g,a)}catch(h){return err("Module.instantiateWasm callback failed with error: "+h),!1}(function(){return wasmBinary||"function"!==typeof WebAssembly.instantiateStreaming||isDataURI(wasmBinaryFile)||isFileURI(wasmBinaryFile)||"function"!==typeof fetch?c(b):fetch(wasmBinaryFile,{credentials:"same-origin"}).then(function(a){return WebAssembly.instantiateStreaming(a,
g).then(b,function(a){err("wasm streaming compile failed: "+a);err("falling back to ArrayBuffer instantiation");return c(b)})})})();return{}}(),___wasm_call_ctors=Module.___wasm_call_ctors=function(){return(___wasm_call_ctors=Module.___wasm_call_ctors=Module.asm.F).apply(null,arguments)},_xapiSubmitBuffer=Module._xapiSubmitBuffer=function(){return(_xapiSubmitBuffer=Module._xapiSubmitBuffer=Module.asm.G).apply(null,arguments)},_xapiSubmitSingletonBuffer=Module._xapiSubmitSingletonBuffer=function(){return(_xapiSubmitSingletonBuffer=
Module._xapiSubmitSingletonBuffer=Module.asm.H).apply(null,arguments)},_xapiOnScanComplete=Module._xapiOnScanComplete=function(){return(_xapiOnScanComplete=Module._xapiOnScanComplete=Module.asm.I).apply(null,arguments)},_xapiScopedExecute=Module._xapiScopedExecute=function(){return(_xapiScopedExecute=Module._xapiScopedExecute=Module.asm.J).apply(null,arguments)},_xapiGenerate=Module._xapiGenerate=function(){return(_xapiGenerate=Module._xapiGenerate=Module.asm.K).apply(null,arguments)},_xapiSetLogLevel=
Module._xapiSetLogLevel=function(){return(_xapiSetLogLevel=Module._xapiSetLogLevel=Module.asm.L).apply(null,arguments)},_xapiRemoveTab=Module._xapiRemoveTab=function(){return(_xapiRemoveTab=Module._xapiRemoveTab=Module.asm.M).apply(null,arguments)},_xapiEndSession=Module._xapiEndSession=function(){return(_xapiEndSession=Module._xapiEndSession=Module.asm.N).apply(null,arguments)},_xapiUnregisterOnScanComplete=Module._xapiUnregisterOnScanComplete=function(){return(_xapiUnregisterOnScanComplete=Module._xapiUnregisterOnScanComplete=
Module.asm.O).apply(null,arguments)},_xapiGetMMD=Module._xapiGetMMD=function(){return(_xapiGetMMD=Module._xapiGetMMD=Module.asm.P).apply(null,arguments)},_xapiAddSignatureExclusions=Module._xapiAddSignatureExclusions=function(){return(_xapiAddSignatureExclusions=Module._xapiAddSignatureExclusions=Module.asm.Q).apply(null,arguments)},_xapiRemoveSignatureExclusions=Module._xapiRemoveSignatureExclusions=function(){return(_xapiRemoveSignatureExclusions=Module._xapiRemoveSignatureExclusions=Module.asm.R).apply(null,
arguments)},_xapiGetEngineVersion=Module._xapiGetEngineVersion=function(){return(_xapiGetEngineVersion=Module._xapiGetEngineVersion=Module.asm.S).apply(null,arguments)},_xapiUpdateContent=Module._xapiUpdateContent=function(){return(_xapiUpdateContent=Module._xapiUpdateContent=Module.asm.T).apply(null,arguments)},_xapiGetSignatureExclusions=Module._xapiGetSignatureExclusions=function(){return(_xapiGetSignatureExclusions=Module._xapiGetSignatureExclusions=Module.asm.U).apply(null,arguments)},_xapiGetMetadata=
Module._xapiGetMetadata=function(){return(_xapiGetMetadata=Module._xapiGetMetadata=Module.asm.V).apply(null,arguments)},_xapiGetMaxEventsPerAlert=Module._xapiGetMaxEventsPerAlert=function(){return(_xapiGetMaxEventsPerAlert=Module._xapiGetMaxEventsPerAlert=Module.asm.W).apply(null,arguments)},_malloc=Module._malloc=function(){return(_malloc=Module._malloc=Module.asm.X).apply(null,arguments)},_free=Module._free=function(){return(_free=Module._free=Module.asm.Y).apply(null,arguments)},___errno_location=
Module.___errno_location=function(){return(___errno_location=Module.___errno_location=Module.asm.Z).apply(null,arguments)},__get_tzname=Module.__get_tzname=function(){return(__get_tzname=Module.__get_tzname=Module.asm._).apply(null,arguments)},__get_daylight=Module.__get_daylight=function(){return(__get_daylight=Module.__get_daylight=Module.asm.$).apply(null,arguments)},__get_timezone=Module.__get_timezone=function(){return(__get_timezone=Module.__get_timezone=Module.asm.aa).apply(null,arguments)},
stackAlloc=Module.stackAlloc=function(){return(stackAlloc=Module.stackAlloc=Module.asm.ba).apply(null,arguments)};Module.intArrayFromString=intArrayFromString;Module.allocate=function(a,b){b=1==b?stackAlloc(a.length):_malloc(a.length);a.subarray||a.slice?HEAPU8.set(a,b):HEAPU8.set(new Uint8Array(a),b);return b};Module.stringToUTF8=stringToUTF8;Module.addFunction=addFunction;Module.ALLOC_NORMAL=0;Module.ALLOC_STACK=1;var calledRun;
function ExitStatus(a){this.name="ExitStatus";this.message="Program terminated with exit("+a+")";this.status=a}dependenciesFulfilled=function runCaller(){calledRun||run();calledRun||(dependenciesFulfilled=runCaller)};
function run(a){function b(){if(!calledRun&&(calledRun=!0,Module.calledRun=!0,!ABORT)){initRuntime();preMain();if(Module.onRuntimeInitialized)Module.onRuntimeInitialized();postRun()}}0<runDependencies||(preRun(),0<runDependencies||(Module.setStatus?(Module.setStatus("Running..."),setTimeout(function(){setTimeout(function(){Module.setStatus("")},1);b()},1)):b()))}Module.run=run;if(Module.preInit)for("function"==typeof Module.preInit&&(Module.preInit=[Module.preInit]);0<Module.preInit.length;)Module.preInit.pop()();
noExitRuntime=!0;run();(function(){(function(){function a(a,b,c,e){let d=[];if(a instanceof Uint8Array){e=new TextDecoder(e);for(let f=0;f<b;f++)d.push(e.decode(a.subarray(f*c,(f+1)*c).filter(a=>0!==a)))}return d}function b(b,c){var d=[];let e;const k=p.heapManager.AllocateIntArray(new Uint32Array(b));switch(c){case t.enEventField.CIDS_ThreatLevel:case t.enEventField.ResponseAction:e=p.heapManager.AllocateIntArray(b.length);d=p.heapManager.MakeIntArray(e,b.length);c=_xapiGetMetadata(k,b.length,c,e);c!==t.status.STATUS_OK&&
f.error("Failed to get metadata. Status: %d",c);d=Array.from(d);break;case t.enEventField.Name:e=p.heapManager.AllocateUInt8Array(b.length*t.MAX_SIGNATURE_NAME_LENGTH),d=p.heapManager.MakeUInt8Array(e,b.length*t.MAX_SIGNATURE_NAME_LENGTH),c=_xapiGetMetadata(k,b.length,c,e,t.MAX_SIGNATURE_NAME_LENGTH),c!==t.status.STATUS_OK&&f.error("Failed to get metadata. Status: %d",c),d=a(d,b.length,t.MAX_SIGNATURE_NAME_LENGTH,"windows-1251")}return d}const {isNil:c}=SEF.common,{common:g,db:h}=SEF;var {utils:l}=
SEF;const f=new l.Logger("NDC I/F"),{Contract:q,GenericResult:k}=g;let r=()=>null;const p={},t={MAX_HEAP:1572864,CONTRACT_EXPIRY:1E3,MAX_SIGNATURE_NAME_LENGTH:256,status:{STATUS_OK:0,scanner:{ERR_WASM_NOT_INIT:-90042,ERR_NULL_PARAM:-90043,ERR_INVALID_PARAM:-90044,ERR_PARAM_EMPTY:-90045,ERR_CONTENT_UPDATE_FAILURE:-90046}},enEventField:{SigID:1,Name:2,ResponseAction:16,CIDS_ThreatLevel:27},enEventAction:{ALLOW:1,BLOCK:2,TERMINATE:3,SAFELANDINGPAGE:4}};l={};for(let a in t.enEventField)l[t.enEventField[a].toString()]=
a;l=Object.freeze(l);const n=t.status.scanner;class m{constructor(a=t.MAX_HEAP,b=0,c=!0){if(!m.instance){this.maxHeap=a;this.current=0;this.allowDynamicAlloc=c;this.isHeapInit=!1;this.allocType=b;this.pool=void 0;try{this.pool=_malloc(this.maxHeap),this.isHeapInit=!0}catch(u){if(f.error(`Error: Exception while pre-allocating heap: ${u.message}`),this.allowDynamicAlloc)this.allocType=1;else throw u;}Object.defineProperty(m,"instance",{value:this,writable:!1})}return m.instance}get GetMaxHeap(){return this.maxHeap}WrapIfNeeded(a){return a>
this.maxHeap-this.current?(this.current=0,!0):!1}AllocateString(a){if(!this.isHeapInit&&!this.allowDynamicAlloc)throw f.error("Error: No heap is preallocated and dynamic allocation is not allowed"),Error("No heap is preallocated and dynamic allocation is not allowed");if(a.length>this.maxHeap)throw f.error(`Error: Buffer too large to handle: ${a.length}`),Error("Buffer too large to handle");const b=a.length+1;let c;this.WrapIfNeeded(b);this.isHeapInit?(c=this.pool+this.current,stringToUTF8(a,c,a.length+
1),this.current+=b+(4-b%4)):(a=intArrayFromString(a),c=_malloc(a));return c}AllocateIntArray(a){if(!this.isHeapInit&&!this.allowDynamicAlloc)throw f.error("Error: No heap is preallocated and dynamic allocation is not allowed"),Error("No heap is preallocated and dynamic allocation is not allowed");if("number"!=typeof a&&!(a instanceof Uint32Array))throw Error('Invalid param "arrayOrSize". Must be an Uint32Array or a number');const b=a instanceof Uint32Array?a.byteLength:a*Uint32Array.BYTES_PER_ELEMENT;
if(0===b||b>this.maxHeap)throw f.error(`Requested allocation size <${b}> is invalid or too large to handle`),Error(`Requested allocation size <${b}> is invalid or too large to handle`);this.WrapIfNeeded(b);let c;this.isHeapInit?(c=this.pool+this.current,this.current+=b):c=_malloc(b);c&&a instanceof Uint32Array&&HEAPU32.set(a,c>>2);return c}MakeIntArray(a,b){return new Uint32Array(HEAPU8.buffer,a,b)}AllocateUInt8Array(a){if(!this.isHeapInit&&!this.allowDynamicAlloc)throw f.error("Error: No heap is preallocated and dynamic allocation is not allowed"),
Error("No heap is preallocated and dynamic allocation is not allowed");if("number"!=typeof a&&!(a instanceof Uint8Array))throw Error('Invalid param "arrayOrSize". Must be an Uint8Array or a number');const b=a instanceof Uint8Array?a.byteLength:a*Uint8Array.BYTES_PER_ELEMENT;if(0===b||b>this.maxHeap)throw f.error(`Requested allocation size <${b}> is invalid or too large to handle`),Error(`Requested allocation size <${b}> is invalid or too large to handle`);this.WrapIfNeeded(b);let c;this.isHeapInit?
(c=this.pool+this.current,this.current+=b):c=_malloc(b);c&&a instanceof Uint8Array&&HEAPU8.set(a,c);return c}MakeUInt8Array(a,b){return new Uint8Array(HEAPU8.buffer,a,b)}SetForceDynamicAllocation(a){a?(this.isHeapInit=!1,this.allowDynamicAlloc=!0,this.allocType=1):this.isHeapInit=!0}}p.MakeContractId=function(a,b,c){return`${a.toString()}:${b}:${c.toString()}`};p.ScanBuffer=()=>(new k(n.ERR_WASM_NOT_INIT,null,{error:"ScannerInterface not initialized"})).Set(Error("ScannerInterface not initialized"));
p.ScanBufferAsync=()=>q.reject(Error("Scanner not initialized"));p.ScanBufferOOB=()=>q.reject(Error("Scanner not initialized"));p.removeTab=()=>n.ERR_WASM_NOT_INIT;p.EndSession=()=>n.ERR_WASM_NOT_INIT;const e={};p._initFuture=(new Promise((a,g)=>{(Module||{}).onRuntimeInitialized=()=>{try{p.heapManager=new m;p.scanContracts={};SEF.context=SEF.context||{};SEF.constants.versionInfo={};_xapiSetLogLevel(1);const d=_xapiGetMaxEventsPerAlert(),l=a=>{SEF.context.ndcDefVer=a;SEF.bridge.portManager.Send({[SEF.constants.teleKeys.MESSAGE_TYPE]:"CONFIG",
[SEF.constants.telePayloadKeys.NDC_DEF_VERSION]:a},SEF.config.Get("nativeMessasingAppId"));f.info(`NDC content version is updated to ${a}`)};p.ScanBufferAsync=(a,b,e,n,h,m,g={forceSingleton:!1})=>c(a)||c(b)||c(e)||c(n)||c(h)||c(m)?q.reject(Error("One or more null parameter to ScanBufferAsync")):new q((c,l)=>{setTimeout(()=>{try{const f=p.heapManager.AllocateString(a),l=p.heapManager.AllocateString(n),w=p.heapManager.AllocateIntArray(d),r=p.heapManager.MakeIntArray(w,d),v=g.forceSingleton?_xapiSubmitSingletonBuffer(e,
l,h,m,f,w,0,g.contentId):_xapiSubmitBuffer(e,l,h,m,f,w);c((new k(v,e,{url:b,frameId:h})).Set(r))}catch(E){f.error(`ScanBufferAsync exception: [${e}:${n}] (${E})`),l(E)}},0)},{contractId:p.MakeContractId(e,n,m),expiry:t.CONTRACT_EXPIRY});p.ScanBuffer=function(a,b,e,n,h,m,g={forceSingleton:!1}){if(c(a)||c(b)||c(e)||c(n)||c(h)||c(m))return(new k(-1,e,{error:Error("One or more parameters is null")})).Set([]);try{const c=this.heapManager.AllocateString(a),f=this.heapManager.AllocateString(n),l=this.heapManager.AllocateIntArray(d),
w=this.heapManager.MakeIntArray(l,d),p=g.forceSingleton?_xapiSubmitSingletonBuffer(e,f,h,m,c,l,0,g.contentId):_xapiSubmitBuffer(e,f,h,m,c,l);return(new k(p,e,{url:b,frameId:h})).Set(w)}catch(y){return f.error(`ScanBuffer exception: [${e}:${n}] (${y})`),(new k(-1,e,{error:y})).Set([])}};p.ScanBufferOOB=function(a,b,d,e,k,n){if(c(a)||c(b)||c(d)||c(e)||c(k)||c(n))return q.reject(Error("One or more null parameter to ScanBufferOOB"));const h={postMessage:function(a){setTimeout(a=>{this.onMessage(`{"tabId":"${a.tabId}","requestId":"${a.requestId}",`+
`"direction":"${a.direction}","status":"0","sigIds":["12","34","67"]}`)},100,a)},onMessage:a=>{a=JSON.parse(a);r(a.tabId,a.requestId,a.direction,a.status,a.sigIds)}},m={tabId:d,requestId:e,frameId:k,direction:n,buffer:a},g=this.MakeContractId(d,e,n);a=new q((a,b)=>{try{p.scanContracts[g]=[a,b],h.postMessage(m)}catch(I){f.error(`Error: ScanBufferOOB: postMessage error: ${I}`),b(I)}},{contractId:g,expiry:t.CONTRACT_EXPIRY});a.then(()=>{delete p.scanContracts[g]},()=>{delete p.scanContracts[g]});return a};
p.GetSigName=function(a){return b(a,t.enEventField.Name)};p.GetResponseAction=function(a){return b(a,t.enEventField.ResponseAction)};p.GetThreatLevel=function(a){return b(a,t.enEventField.CIDS_ThreatLevel)};p.removeTab=(a,b)=>_xapiRemoveTab(a);p.EndSession=(a,b)=>{if(c(a)||c(b))return n.ERR_NULL_PARAM;b=p.heapManager.AllocateString(b);return _xapiEndSession(a,b)};e.AddSignatureExclusions=function(a){if(!(a instanceof Set))return n.ERR_INVALID_PARAM;if(0===a.size)return n.ERR_PARAM_EMPTY;const b=this.heapManager.AllocateIntArray(new Uint32Array(a));
return _xapiAddSignatureExclusions(a.size,b)};e.RemoveSignatureExclusions=function(a){if(!(a instanceof Set))return n.ERR_INVALID_PARAM;if(0===a.size)return n.ERR_PARAM_EMPTY;const b=this.heapManager.AllocateIntArray(new Uint32Array(a));return _xapiRemoveSignatureExclusions(a.size,b)};e.GetSignatureExclusions=function(){const a=_xapiGetSignatureExclusions(0);if(0===a)return new Uint32Array;const b=this.heapManager.AllocateIntArray(a);_xapiGetSignatureExclusions(b);return Uint32Array.from(this.heapManager.MakeIntArray(b,
a))};e.UpdateContent=function(a){if(!(a&&a instanceof Uint8Array))return _xapiUpdateContent(0,0);let b=n.ERR_CONTENT_UPDATE_FAILURE,c=null;try{c=_malloc(a.length),HEAPU8.set(a,c),b=_xapiUpdateContent(c,a.length)}catch(v){f.error(`Exception while xapiUpdateContent: ${v}`)}finally{c&&_free(c)}return b};e.SetupLastKnownGoodContent=function(){return(new h.DB("ndccontent.db")).Open({create:[{name:"content"},{name:"engine"}]}).then(a=>{if(a)return a.Query().Select().From("content").WherePrimaryKey().Are("blob",
"version").Run("SI").then(a=>{let b={blob:void 0,version:void 0};a.forEach(a=>{switch(a.key){case "blob":b.blob=a.value;break;case "version":b.version=a.value}});return b}).catch(a=>{f.error(`Content fetch from DB failed : ${a}`)});throw Error("DB object not initialized");}).catch(a=>{f.error(`DBError: ${a} (using factory content)`)}).then(a=>{let b=e.UpdateContent(a.blob);void 0===a.blob?f.info(`No previous updated content found, update using the embedded one, ret: ${b}`):b!==t.status.STATUS_OK?
(f.error(`Update content fails, ret: ${b}`),b=e.UpdateContent(),f.info(`Update using the embedded one, ret: ${b}`)):(f.info("Update using last known good one succeeds"),l(a.version));return b}).catch(a=>{f.error(`Exception while updating content: ${a}`);return n.ERR_CONTENT_UPDATE_FAILURE})};p.UpdateContent=(a,b)=>SEF.context.ndcDefVer===b?(f.info(`Skip NDC content update, ${b}`),t.status.STATUS_OK):(new h.DB("ndccontent.db")).Open().then(c=>{if(!c)throw Error("NDC DB object not initialized");for(var d=
a.length,k=new Uint8Array(d),n=0;n<d;n++)k[n]=a.charCodeAt(n);f.info(`NDC content size: ${k.byteLength}`);if(0!==k.byteLength&&e.UpdateContent(k)===t.status.STATUS_OK)return c.Query().Update(k).Into("content").As("blob").Run().then(()=>{c.Query().Update(b).Into("content").As("version").Run().then(()=>{l(b)})}).catch(a=>{f.error(`NDC content db transaction error: ${a}`)}),t.status.STATUS_OK;f.error("NDC content update failed (using last known good content)");return e.SetupLastKnownGoodContent()}).catch(a=>
{f.error(`NDC content update failed (using embedded content): ${a}`);return e.UpdateContent()});r=(a,b,c,e,f)=>{f=Array.isArray(f)?f:p.heapManager.MakeIntArray(f,d);b="string"===typeof b?b:UTF8ToString(b);e=(new k(e,a,{url:null})).Set(f);a=p.MakeContractId(a,b,c);if(a in p.scanContracts)p.scanContracts[a][0](e)};addFunction(r,"viiiii");SEF._JSScope=_xapiScopedExecute;e.SetupLastKnownGoodContent().then(b=>{var c=p.heapManager.AllocateIntArray(4);c=p.heapManager.MakeIntArray(c,4);SEF.constants.versionInfo.NDC_VERSION_INFO=
{MAJOR:c[0],MINOR:c[1],PATCH:c[2],BUILD:c[3]};f.info(`NDC engine version: ${JSON.stringify(SEF.constants.versionInfo.NDC_VERSION_INFO)}`);b===t.status.STATUS_OK?a(e):g(Error(`Content init failed: ${b}`))})}catch(x){g(Error(`ScannerInterface runtime init failed: ${x.message}`))}}})).then(a=>a).catch(a=>a);p.OnInitComplete=function(){return this._initFuture};return new class extends SEF.core.Module{constructor(){super({name:"NDC",version:"1.0.0",configurations:[{key:"state",value:SEF.constants.moduleStates.ENABLED,
accessors:["persist"]}]})}Initialize(){return p.OnInitComplete().then(()=>!0)}ScanBuffer(...a){return p.ScanBuffer(...a)}ScanBufferAsync(...a){return p.ScanBufferAsync(...a)}ScanBufferOOB(...a){return p.ScanBufferOOB(...a)}GetResponseAction(...a){return p.GetResponseAction(...a)}GetSigName(...a){return p.GetSigName(...a)}GetThreatLevel(...a){return p.GetThreatLevel(...a)}removeTab(...a){return p.removeTab(...a)}EndSession(...a){return p.EndSession(...a)}UpdateContent(...a){return p.UpdateContent(...a)}ApplyConfigs(){}}})()})(this);(function(){(function(){function a(b,c,f,g,k){if(f>g)return-1;const h=Math.floor((f+g)/2),l=k(b[h],c);return 0===l?h:null===l?-1:0<l?a(b,c,f,h-1,k):a(b,c,h+1,g,k)}function b(a,c,f,g,k){if(0===a.length||f>g)return 0;const h=Math.floor((f+g)/2),l=k(a[h],c);let q=void 0;h+1<a.length&&(q=k(a[h+1],c));return 0===l||null===l?-1:0>l&&(0<q||void 0===q)?h+1:0<l?b(a,c,f,h-1,k):b(a,c,h+1,g,k)}const c=(a,b)=>a-b;class g extends Array{constructor(a=c,b=c,...f){super(...f);this.compareFn=a;this.matchFn=b}push(...a){a.forEach(a=>
{const c=b(this,a,0,this.length-1,this.compareFn);-1!==c&&this.splice(c,0,a)},this);return this.length}indexOf(b){return a(this,b,0,this.length-1,this.compareFn)}find(b){b=a(this,void 0,0,this.length-1,b);if(-1!==b)return this[b]}}SEF.utils.SortedArray=g;SEF.utils.searchIndexToInsert=b;SEF.utils.binarySearch=a;SEF.constants.FAILRETURN1=-1;SEF.constants.FAILRETURN2=void 0})()})(this);(function(){(function(){function a(){let a="SEF.WEB-";if(""!==SEF.config.Get("sourceID"))a+=`SID-${btoa(SEF.config.Get("sourceID")).replace("=","")}`;else{const b=new Uint32Array(4);window.crypto.getRandomValues(b);for(let c=0;c<b.length;c++)a+=b[c].toString(16).padStart(8,"0")}return a}const {config:b,constants:c,common:g,utils:h}=SEF,l=new h.Logger("WEBPULSE"),{isNil:f,Contract:q}=g,k=["DomC","DirC","FileC"],r=["host","directory"];class p extends SEF.cache.Cache{Insert(a,b,c){return a?super.Insert(g.hash.SHA256(a),
b,c):!1}InsertVolatile(a,b,c){return a?super.InsertVolatile(g.hash.SHA256(a),b,c):!1}Remove(a){return a?super.Remove(g.hash.SHA256(a)):!1}GetEx(a,b="GET"){a=this.ConductCachingKey(a,b);return super.GetEx(a.PathHash())||super.GetEx(a.DirectoryHash())||super.GetEx(a.HostHash())}Get(a,b="GET"){a=this.ConductCachingKey(a,b);return super.Get(a.PathHash())||super.Get(a.DirectoryHash())||super.Get(a.HostHash())}ConductCachingKey(a,b=""){let c={host:"",directory:"",path:"",HostHash:void 0,DirectoryHash:void 0,
PathHash:void 0};a=new URL(a);if(a.host.startsWith("www.")){let b=a.host.indexOf("www.");c.host=a.host.substring(b+4)}else c.host=a.host;c.host=b.concat(":",c.host);b=a.pathname.substring(a.pathname.lastIndexOf("/"));0<=b.indexOf(".")||"/"===b?c.directory=c.host.concat([a.pathname.substring(0,a.pathname.lastIndexOf("/"))]):c.directory=c.host.concat(a.pathname);c.directory=c.directory.concat("/*");c.path=c.host.concat(a.pathname);c.HostHash=()=>g.hash.SHA256(c.host);c.DirectoryHash=()=>g.hash.SHA256(c.directory);
c.PathHash=()=>g.hash.SHA256(c.path);return c}}class t{constructor(){var a="[0,16777215] [167772160,184549375] [2130706432,2147483647] [2886729728,2887778303] [2851995648,2852061183] [3232235520,3232301055] [3758096384,4294967295]".split(" ");this.sortedArray=new h.SortedArray(g.Ipv4RangeMatcher.compareFn);for(const b of a)a=g.Ipv4RangeMatcher.CreateIpv4RangeMatcherFromIpv4Range(b),null!==a&&this.sortedArray.push(a)}IsExcludedIpv4(a){if(!g.url.isValid(a))return!1;a=new g.ParsedUrl(a);a=g.Ipv4RangeMatcher.Preprocess(a.host);
return null===a?!1:this.sortedArray.find(g.Ipv4RangeMatcher.matchFn(a))?!0:!1}}return new class extends SEF.core.Module{constructor(){super({name:"webPulse",version:"1.0.0",configurations:[{key:"state",value:c.moduleStates.ENABLED,accessors:["persist"]},{key:"allowUrlParams",value:!0,accessors:["persist"]},{key:"webPulseBasedConviction",value:!0,accessors:["persist"]},{key:"webPulseUrl",value:"https://sp.cwfservice.net",accessors:["persist"]},{key:"webPulse-URI-Type",value:"2",accessors:["persist"]},
{key:"webPulse-URI-Mode",value:"R",accessors:["persist"]},{key:"webPulse-URI-Vendor",value:"-",accessors:["persist"]},{key:"webPulse-URI-License",value:"-",accessors:["persist"]},{key:"webPulse-URI-Cache-hits",value:"-",accessors:["persist"]},{key:"webPulse-URI-Method",value:"GET",accessors:["persist"]}]});this.cache=new p("Reputation",c.CACHE_LIMIT,"db");this.cache.policy=SEF.cache.Cache.Policy.FIFO;this.ipv4LookupExclusion=new t}ResolveUrl(a){a=new URL(this.config.Get("allowUrlParams")?a:g.url.PIIClean(a));
const b=a.protocol.substring(0,a.protocol.length-1);let c=80;"https"===b&&(c=443);""!==a.port&&({port:c}=a);const d=a.pathname.substring(1,a.pathname.length);return{scheme:b,host:a.hostname,port:c,path:d,query:a.search}}FetchReputation(g,h,e=[]){if(b.Get("networkUsage")===c.networkUsage.NONE)return Promise.reject(Error("Network usage is disabled"));try{const b=this.cache.ConductCachingKey(g,h),c={};let m;for(m=0;m<e.length;m++)if("user-agent"===e[m].name.toLowerCase()||"referer"===e[m].name.toLowerCase())c["X-Orig-".concat(e[m].name)]=
e[m].value;const {scheme:l,host:n,port:p,path:w,query:v}=this.ResolveUrl(g);let q=SEF.webPulse.config.Get("webPulse-URI-Vendor");if(!q.startsWith("SEF.WEB-SID-")&&""!==SEF.config.Get("sourceID")||!/SEF.WEB-(SID-)?[a-zA-Z0-9]+/.test(q))q=a(),this.config.Set("webPulse-URI-Vendor",q);const t=[this.config.Get("webPulseUrl"),this.config.Get("webPulse-URI-Type"),this.config.Get("webPulse-URI-Mode"),this.config.Get("webPulse-URI-Vendor"),this.config.Get("webPulse-URI-License"),this.config.Get("webPulse-URI-Cache-hits"),
h,l,n,p,w].join("/")+(""!==v?v:"");let C,y,z=0;const E=Date.now(),H=fetch(t,{headers:c}).then(a=>{if(!a.ok)throw Error(`Reputation response KO: ${a.status}`);return a}).then(a=>{({status:C,url:y}=a);const b=a.headers.get("cache-control");!f(b)&&0<=b.toLowerCase().indexOf("max-age")&&(z=parseInt(b.substring(b.toLowerCase().indexOf("=")+1,b.length),10));return a.text()}).then(a=>{var c=(new DOMParser).parseFromString(a,"text/xml");const d=[];let e;for(a=0;a<k.length;a++){const b=c.getElementsByTagName(k[a]);
if(!(0>=b.length)){for(c=0;c<b.length;c++)e=a,b[c].childNodes[0].nodeValue.match(/.{2}/g).forEach(a=>{d.push(parseInt(a,16))});break}}a={type:"webpulse",categories:d,cacheLevel:e};if(0<z)switch(e){case 0:case 1:this.cache.Insert(b[r[e]],a,z);this.cache.Remove(b.path);break;default:this.cache.InsertVolatile(b.path,a,z)}else this.cache.Remove(b.path);a.status=C;a.responsed_url=y;return a}).then(a=>{a.eventTabIdSet=new Set;a.queryTimeMs=Date.now()-E;return a});this.cache.InsertVolatile(b.path,H);H.catch(()=>
{this.cache.Remove(b.path)});return H}catch(d){return Promise.reject(d)}}GetReputation(a,b=!1){var c=null;c=null;g.url.isValidHttp(a.url)?this.ipv4LookupExclusion.IsExcludedIpv4(a.url)?c=Promise.reject(Error(`URL is excluded ipv4: ${a.url}`)):(c=this.cache.GetEx(a.url,a.method),f(c)?c=this.FetchReputation(a.url,a.method,a.headers).then(c=>{b&&(a.eventContext.queryTimeMs=c.queryTimeMs,SEF.eventing.reputationResult.onReputationResult.emit(a.eventContext),c.eventTabIdSet.add(a.tabId));c.tabId=a.tabId;
return c}):c instanceof Promise||c instanceof q?c=c.then(c=>{b&&!c.eventTabIdSet.has(a.tabId)&&(a.eventContext.queryTimeMs=c.queryTimeMs,SEF.eventing.reputationResult.onReputationResult.emit(a.eventContext),c.eventTabIdSet.add(a.tabId));c.tabId=a.tabId;return c}):(c.tabId=a.tabId,c=Promise.resolve(c))):c=Promise.reject(Error(`Invalid URL: ${a.url}`));c.then(a=>{}).catch(a=>{l.error(`[SEF.Web Error]: Error while reputation fetch: ${a}`)});return c}Initialize(){return{}}}})()})(this);(function(){(SEF.utils=SEF.utils||{}).OpState=function(){const a=new SEF.utils.Logger("OPSTATE");class b{static Malfunctioned(b=""){a.error(`Malfunctioned. Error: ${b}`);void 0!==SEF.bridge&&SEF.bridge.portManager.Send({[SEF.constants.teleKeys.MESSAGE_TYPE]:"ERROR",[SEF.constants.teleKeys.PAYLOAD]:b},SEF.config.Get("nativeMessasingAppId"));return!0}}return b}()})(this);(function(){(function(){const a=new SEF.utils.Logger("SERVING"),{utils:b,common:c}=SEF;return new class extends SEF.core.Module{constructor(){super({name:"serving",version:"1.0"})}Initialize(){SEF.OnInitComplete().then(()=>{try{let g=120;for(;(void 0===SEF.policyOrchestrator||!SEF.policyOrchestrator.initstate)&&(a.info("policyOrchestrator is not ready"),--g,c.Sleep(1E3),0<g););a.info("Sending halo to connector and starting service");b.Message.resetKey();SEF.bridge.portManager.Send({[SEF.constants.teleKeys.MESSAGE_TYPE]:"EHLO"},
SEF.config.Get("nativeMessasingAppId"))}catch(g){a.error(`Failed to send halo to connector: ${JSON.stringify(g)}`)}});return!0}}})()})(this);(function(){(SEF.utils=SEF.utils||{}).Telemetry=function(){const {constants:a}=SEF;new SEF.utils.Logger("TELEMETRY");class b{static SendTelemetry(b){if(!SEF.config.Get("allowTelemetry"))return!1;b={[a.teleKeys.MESSAGE_TYPE]:"TELEMETRY",[a.teleKeys.BROWSER_VERSION]:SEF.common.GetBrowserVersion().version,[a.teleKeys.URL]:b.url,[a.teleKeys.SOURCE]:b.source,[a.teleKeys.SILENT]:b.silent,[a.teleKeys.EXCLUDED]:b.excluded,[a.teleKeys.ACTION]:b.action,[a.teleKeys.CATEGORY_IDS]:b.categoryIds,[a.teleKeys.THREAT_LEVEL]:b.threatLevel,
[a.teleKeys.SIG_ID]:b.sigId,[a.teleKeys.SIG_NAME]:b.sigName,[a.teleKeys.PAYLOAD]:JSON.stringify(b.payload),[a.teleKeys.LANGUAGE]:SEF.context.browserObject.i18n.getUILanguage()};SEF.bridge.portManager.Send(b,SEF.config.Get("nativeMessasingAppId"));return!0}}return b}()})(this);(function(){(function(){const {common:a,NDC:b,constants:c,utils:g}=SEF,h=new g.Logger("scanner");class l extends SEF.utils.Configs{constructor(){super("IdsFilter")}Set(a,b){a=Number(a);return isNaN(a)?null:super.Set(a,b)}Match(a){return super.Get(a)}}class f extends SEF.core.Plugin{constructor(){super({name:"scanner",version:"1.0.0",configurations:[{key:"state",value:c.moduleStates.DISABLED,accessors:["persist"]},{key:"asyncScan",value:!1,accessors:["persist"]},{key:"notify",value:!0,accessors:["persist"]},
{key:"fullNotifyMode",value:!0,accessors:["persist"]}]});this.weight=c.consolPriorities.MEDIUM_LOW;this.idsFilter=new l}ProcessResult(a,b,c){if(a&&a.hasOwnProperty("sigIds")){var f=[],k=[],g=[],m=!1;for(const [,b]of Object.entries(a.sigIds))if(0!==b){const a=SEF.scanner.idsFilter.Match(b);m?void 0!==a&&a.cancel&&g.push(b):void 0===a||void 0!==a&&a.cancel?f.push(b):k.push(b)}else m||(m=!0);g.reverse();f=f.concat(g);if(0<f.length||0<k.length){g={cancel:!1};0<f.length&&(g.cancel=!0,k=f,g.suppress=c?
!1:!0);SEF.scanner.IsModuleSilent()&&(g.silent=!0);try{const e=SEF.NDC.GetSigName(k),d=SEF.NDC.GetThreatLevel(k);b.incidents=[];for(f=0;f<k.length;f++){const h=k[f],m=SEF.scanner.idsFilter.Match(h);if(void 0===m&&SEF.scanner.config.Get("notify")||void 0!==m&&m.log)c={},c.url=a.optional.url,c.source="scanner",c.silent=g.hasOwnProperty("silent"),c.action=g,c.sigId=h,c.sigName=e[f],c.threatLevel=d[f],c.payload={[SEF.constants.telePayloadKeys.NDC_DEF_VERSION]:SEF.context.ndcDefVer},b.incidents.push(c);
if(!SEF.scanner.config.Get("fullNotifyMode"))break}}catch(e){h.error(`Failed to map metadata, : ${e}`)}return g}}return{cancel:!1}}Initialize(){return Promise.all([this.idsFilter.OnInitComplete(),b.OnInitComplete()]).then(()=>{const c={cancel:!1};this.webRequest.onBeforeSendHeaders.addListener(function(f){if(SEF.scanner.IsModuleDisabled()||-1===f.tabId)return c;if(f.requestHeaders){const {url:c,tabId:h,requestId:m,frameId:e,requestHeaders:d}=f;var {method:k}=f;f=0<=f.type.indexOf("main_frame")&&0===
e;k=k.toUpperCase();var g=new a.ParsedUrl(c);({hostname:g}=g);const l=c.substr(c.indexOf(g)+g.length);let p=[`${k} ${l} HTTP/1.1`];d.forEach(({name:a,value:b})=>p.push(`${a}: ${b}`));p.push(`X-Request-Id: ${m}`);p.push(`Host: ${g}`);["POST","PUT","PATCH","DELETE"].includes(k)&&p.push("Content-Length: 0");p=`${p.join("\r\n")}\r\n`;k=(SEF.scanner.config.Get("asyncScan")?b.ScanBufferAsync:b.ScanBuffer).bind(b)(p,c,h,m,e,0);return k instanceof a.Contract||k instanceof Promise?Promise.all([k.then((a,b)=>
SEF.scanner.ProcessResult(a,this.detail,b)).catch(()=>({cancel:!1}))]).then(a=>a[0]):SEF.scanner.ProcessResult(k,this.detail,f)}return c},{urls:["<all_urls>"]},["requestHeaders","blocking"]);this.webRequest.onHeadersReceived.addListener(function(){return c},{urls:["<all_urls>"]},["responseHeaders","blocking"]);this.webRequest.onCompleted.addListener(function(a){b.EndSession(a.tabId,a.requestId)},{urls:["<all_urls>"]});this.webContent.onScript.addListener(function(f){if(SEF.scanner.IsModuleDisabled())return c;
var g=new a.ParsedUrl(f.url);b.ScanBuffer(`GET ${g.pathname} HTTP/1.1\r\nHOST: ${g.host}\r\n\r\n`,f.url,f.tabId,f.requestId,f.frameId,0);g=b.ScanBuffer("HTTP/1.1 200 OK\r\ncontent-type: application/javascript\r\n"+`content-length: ${f.buffer.length}\r\n\r\n${f.buffer}`,f.url,f.tabId,f.requestId,f.frameId,1);b.EndSession(f.tabId,f.requestId);return SEF.scanner.ProcessResult(g,this.detail,!0)});SEF.context.browserObject.tabs.onRemoved.addListener(function(a,c){b.removeTab(a,c)});return!0})}}return new f})()})(this);(function(){(function(){function a(a){var {accessFilter:b}=SEF;let c={cancel:!1};return b.IsModuleDisabled()?c:(b=b.ztFilter.Match(a.requestHeaders))&&b.accessControl?(a.requestHeaders.push({name:SEF.config.Get("httpHeaderNameSourceId"),value:SEF.config.Get("sourceID")}),{requestHeaders:a.requestHeaders}):c}const {utils:b,exceptions:c,constants:g}=SEF,{ValidationError:h}=c,l=new b.Logger("accessFilter");class f extends SEF.utils.Configs{constructor(){super("ZeroTrustFilter");this.filters=new Map;
this.OnInitComplete().then(()=>{this._Load()})}_Load(){for(const a of super.Keys())this.filters.set(a,super.Get(a))}Set(a,b){if(!b||b&&"boolean"!==typeof b.accessControl)throw new h(`Invalid value type <${typeof b.accessControl}>, `+"expecting Boolean");this.filters.set(a,b);return super.Set(a,b)}Match(a){if(a)try{for(const [b,c]of this.filters.entries()){const [f,g]=b.split("=");for(const b of a)if(f.toLowerCase()===b.name.toLowerCase()){if(!g||g&&g.toLowerCase()===b.value.toLowerCase())return c;
break}}}catch(r){l.error(`Match zero trust filter rule error: ${r}`)}}Clear(){this.filters.clear();super.Clear()}}class q extends SEF.core.Plugin{constructor(){super({name:"accessFilter",version:"1.0.0",configurations:[{key:"state",value:g.moduleStates.DISABLED,accessors:["persist"]}]});this.ztFilter=new f}Initialize(){return Promise.all([this.ztFilter.OnInitComplete()]).then(()=>{this.webRequest.onBeforeSendHeaders.addListener(a,{urls:["<all_urls>"]},["requestHeaders","extraHeaders"]);return!0})}}
return new q})()})(this);(function(){(function(){function a(a,b){this.engine="WebPulse";const c=new h.ParsedUrl(a.url);var d=0<=a.type.indexOf("main_frame")&&0===a.frameId;const {webFilter:e}=SEF;var g={cancel:!1};if(e.IsModuleDisabled())return g;const l=(c,d,f,g=[])=>{b===m.OnReputationResult&&5E3<a.queryTimeMs&&(c.suppress=!0);if(!1===c.cancel&&"HID"!==f)return c;e.IsModuleSilent()&&(c={...c,silent:!0});const h={};h.url=d;h.source=`webFilter@${f.toLowerCase()}Filter`;h.silent=c.silent||!1;h.action=c;h.categoryIds=g;switch(f){case "IPV4":case "URL":h.sigId=
k.sigInfo.RULE_BASED_SIG_ID;h.sigName=k.sigInfo.RULE_BASED_SIG_NAME;h.threatLevel=k.sigInfo.RULE_BASED_THREAT_LEVEL;break;case "CATEGORY":case "HID":h.sigId=k.sigInfo.WEBPULSE_BASED_SIG_ID;h.sigName=k.sigInfo.WEBPULSE_BASED_SIG_NAME;h.threatLevel=k.sigInfo.WEBPULSE_BASED_THREAT_LEVEL;break;default:throw Error(`Found unsupported filter type ${f}`);}this.detail.incidents=[h];return c};if(b!==m.OnReputationResult){var p=c.href;k.URL_MAX_LENGTH<p.length&&(p=p.substring(0,k.URL_MAX_LENGTH));if(p=e.urlFilter.Match(p))return p.suppress=
d?!1:!0,l(p,c,"URL");if(p=e.ipv4Filter.Match(c.hostname))return p.suppress=d?!1:!0,l(p,c,"IPV4")}if(f.IsModuleDisabled()||!f.config.Get("webPulseBasedConviction"))return g;if(d&&(p=f.cache.Get(a.url,a.method),null===p&&b!==m.OnReputationResult&&(f.GetReputation({url:a.url,method:a.method,headers:a.requestHeaders,eventContext:a,tabId:a.tabId,isMainFrame:d,Method:a.method,BrowserURL:a.documentUrl,ReferrerURL:a.originUrl},!0),p=f.cache.Get(a.url,a.method)),p)){this.detail.result=p;var w=e.categoryExclusion.Match(p.categories);
d=e.categoryFilter.Match(w);w=e.urlInspectorFilter.Match(w);w=e.hidFilter.Match(w);if(d||w){g=n.Rank(d);const a=n.Rank(w);let b="CATEGORY";g<a&&(d=w,b="HID");return l(d,c,b,p.categories)}}return g}function b(b){return a.bind(this)(b,m.OnBeforeSendHeadrs)}function c(b){return a.bind(this)(b,m.OnHeadersReceived)}function g(b){return a.bind(this)(b,m.OnReputationResult)}const {common:h,utils:l,webPulse:f,exceptions:q,constants:k}=SEF,{ValidationError:r,UnsupportedError:p}=q,t=new l.Logger("webFilter");
class n{static get Schema(){return{cancel:{supported:!0,type:"boolean",rank(a){return a?1E3:100}},redirectUrl:{supported:!0,type:"string",rank:()=>900},isolationUrl:{supported:!0,type:"string",rank:()=>800},upgradeToSecure:{supported:!1,type:"boolean",rank:()=>700},authCredentials:{supported:!1,type:"object",rank:()=>600},requestHeaders:{supported:!1,type:"object",rank:()=>500},responseHeaders:{supported:!0,type:"object",rank:()=>400}}}static Validate(a){if(!a)throw new r("null action");a=Object.entries(a);
let b="",c="";if(1!==a.length){let d=!1;if(2!==a.length)throw new r("Multiple actions are not supported");for(const [e,f]of a)"silent"===e?d=!0:(b=e,c=f);if(!d)throw new r("The second action is not silent");}else[[b,c]]=a;if(!n.Schema.hasOwnProperty(b)||!1===n.Schema[b].supported)throw new p(`Action <${b}> is not supported.`);if(typeof c!==n.Schema[b].type)throw new r(`Invalid value type <${typeof c}>, `+`expecting <${n.Schema[b].type}>`);}static Rank(a){if(a){a.hasOwnProperty("silent")&&(a={...a},
delete a.silent);const [[b,c]]=Object.entries(a);return n.Schema[b].rank(c)}return 0}}const m={OnBeforeSendHeadrs:0,OnHeadersReceived:1,OnReputationResult:2};class e extends SEF.utils.Configs{constructor(){super("UrlFilter");this.filters=new Map;super.OnInitComplete().then(()=>{this._Load()})}_Load(){for(const a of super.Keys()){let b=h.UrlMatcher.CreateUrlMatcher(a);null!==b&&(b.action=super.Get(a),this.filters.set(b.url,b))}}Match(a){let b=0,c={action:void 0};for(const [,d]of this.filters.entries()){const e=
d.Match(a);e>b&&(b=e,c=d)}return c.action}Set(a,b){if(!b)return null;let c=h.UrlMatcher.CreateUrlMatcher(a);if(null===c)return null;n.Validate(b);c.action=b;this.filters.set(a,c);return super.Set(a,b)}Delete(a){this.filters.delete(a);return super.Delete(a)}Clear(){this.filters.clear();super.Clear()}}class d extends SEF.utils.Configs{constructor(){super("Ipv4RangeFilter");this.sortedArray=new l.SortedArray(h.Ipv4RangeMatcher.compareFn);super.OnInitComplete().then(()=>{this._Load()})}_Load(){for(const a of super.Keys()){const b=
h.Ipv4RangeMatcher.CreateIpv4RangeMatcherFromIpv4Range(a.substring(6));null!==b&&(b.action=super.Get(`range:${a}`),this.sortedArray.push(b))}}Match(a){let b={action:void 0};a=h.Ipv4RangeMatcher.Preprocess(a);if(null===a)return b.action;(a=this.sortedArray.find(h.Ipv4RangeMatcher.matchFn(a)))&&(b=a);return b.action}Set(a,b){if(!b)return null;const c=h.Ipv4RangeMatcher.CreateIpv4RangeMatcherFromIpv4Range(a);if(null===c)return null;n.Validate(b);c.action=b;this.sortedArray.push(c);return super.Set(`range:${a}`,
b)}Get(a){return super.Get(`range:${a}`)}Delete(a){const b=h.Ipv4RangeMatcher.CreateIpv4RangeMatcherFromIpv4Range(a);this.sortedArray.splice(this.sortedArray.indexOf(b),1);return super.Delete(`range:${a}`)}Clear(){this.sortedArray.splice(0,this.sortedArray.length);super.Clear()}}class B extends SEF.utils.Configs{constructor(){super("CategoryFilter")}Set(a,b){if(!b)return null;a=Number(a);n.Validate(b);return super.Set(a,b)}Match(a){let b=void 0,c=n.Rank(b);for(const d of a){a=super.Get(d);const e=
n.Rank(a);e>c&&(b=a,c=e)}return b}}class x extends SEF.utils.Configs{constructor(){super("HidFilter");this.filters={};this.OnInitComplete().then(()=>{this._Load()})}_Load(){for(const a of super.Keys())Object.assign(this.filters,super.Get(a))}Set(a,b){this.filters=b;return super.Set(a,b)}Match(a){if(void 0!==this.filters.ConvictionLevel&&a<=this.filters.ConvictionLevel)return{cancel:!0};if(void 0!==this.filters.LoggingLevel&&a<=this.filters.LoggingLevel)return{cancel:!1}}Clear(){this.filters={};super.Clear()}}
class u extends SEF.utils.Configs{constructor(){super("UrlInspectorFilter");this.filters={};this.MAX_HID_LEVEL=500;this.OnInitComplete().then(()=>{this._Load()})}_Load(){for(const a of super.Keys())Object.assign(this.filters,super.Get(a))}Set(a,b){this.filters=b;return super.Set(a,b)}Match(a){let b=this.MAX_HID_LEVEL+1;for(const c of a)void 0!==this.filters.categoryLevels&&this.filters.categoryLevels.hasOwnProperty(c)&&(b=Math.min(this.filters.categoryLevels[c],b));return b}Clear(){this.filters={};
super.Clear()}}class A extends SEF.utils.Configs{constructor(){super("CategoryExclusion")}Set(a,b){super.Set(Number(a),b.categories)}Match(a){let b=[];for(const c of a)if(super.Keys().includes(c)){let d=!1;for(const b of super.Get(c))if(a.includes(b)){t.info(`Category exclusion met. ${c} will redirect to ${b}`);d=!0;break}d||b.push(c)}else b.push(c);return b}Clear(){super.Clear()}}class D extends SEF.core.Plugin{constructor(){super({name:"webFilter",version:"1.0.0",configurations:[{key:"state",value:k.moduleStates.DISABLED,
accessors:["persist"]}]});this.weight=k.consolPriorities.HIGH_MEDIUM;this.urlFilter=new e;this.ipv4Filter=new d;this.categoryFilter=new B;this.hidFilter=new x;this.urlInspectorFilter=new u;this.categoryExclusion=new A}Initialize(){return Promise.all([this.urlFilter.OnInitComplete(),this.ipv4Filter.OnInitComplete(),this.categoryFilter.OnInitComplete(),this.hidFilter.OnInitComplete(),this.urlInspectorFilter.OnInitComplete(),this.categoryExclusion.OnInitComplete()]).then(()=>{this.webRequest.onBeforeSendHeaders.addListener(b,
{urls:["<all_urls>"]},["requestHeaders","blocking","extraHeaders"]);this.webRequest.onHeadersReceived.addListener(c,{urls:["<all_urls>"]},["responseHeaders","blocking"]);this.reputationResult.onReputationResult.addListener(g);return!0})}}return new D})()})(this);
